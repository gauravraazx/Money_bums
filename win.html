<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>Coin Flip - Money Bums</title>
  <meta name="viewport" content="width=340, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      color: #ffffff;
      font-family: 'Inter', Arial, sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
      font-size: 14px;
    }
    .container { width: 340px; margin: 0 auto; padding: 15px 10px 110px 10px; }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px; padding: 12px; text-align: center; margin-bottom: 12px;
      box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
      border: 1px solid rgba(255,255,255,0.1);
    }
    .header-title { font-size: 1.1em; font-weight: 700; letter-spacing: 1px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }

    /* Balance Display */
    .balance-display {
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      padding: 12px;
      margin: 16px 0;
      display: flex;
      justify-content: space-around;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .balance-item {
      text-align: center;
    }
    .balance-label {
      font-size: 0.75em;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .balance-value {
      font-size: 1.1em;
      font-weight: 700;
      color: #4ade80;
    }

    /* Game Stats */
    .game-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin: 16px 0;
    }
    .stat-card {
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      padding: 10px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .stat-label {
      font-size: 0.75em;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .stat-value {
      font-size: 1.2em;
      font-weight: 700;
      color: #8b5cf6;
    }

    /* Coin Flip Section */
    .game-card {
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      text-align: center;
    }
    .game-title { font-size: 1.1em; font-weight: 700; margin-bottom: 12px; color: #8b5cf6; }

    /* Coin Animation */
    .coin-container {
      perspective: 1000px;
      height: 120px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 20px 0;
    }
    .coin {
      width: 100px;
      height: 100px;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.6s;
    }
    .coin.flipping {
      animation: flip 1s ease-in-out;
    }
    @keyframes flip {
      0% { transform: rotateY(0); }
      100% { transform: rotateY(1800deg); }
    }
    .coin-face {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5em;
      font-weight: 800;
      backface-visibility: hidden;
      border: 3px solid #fbbf24;
      box-shadow: 0 4px 20px rgba(251,191,36,0.4);
    }
    .coin-head {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
    }
    .coin-tail {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      transform: rotateY(180deg);
    }

    /* Input Fields */
    .input-group {
      margin: 16px 0;
    }
    .input-label {
      font-size: 0.85em;
      color: #c8d0e3;
      margin-bottom: 8px;
      display: block;
    }
    .input-field {
      width: 100%;
      padding: 12px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(139,92,246,0.4);
      border-radius: 8px;
      color: white;
      font-size: 1em;
      font-weight: 600;
      text-align: center;
    }
    .input-field:focus {
      outline: none;
      border-color: #8b5cf6;
      box-shadow: 0 0 0 3px rgba(139,92,246,0.2);
    }

    .selected-side {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed) !important;
      color: white !important;
      box-shadow: 0 2px 8px rgba(139,92,246,0.4);
    }

    /* Buttons */
    .action-btn {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 1em;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(139,92,246,0.4);
      transition: transform 0.2s;
      width: 100%;
    }
    .action-btn:hover { transform: scale(1.03); }

    /* Result */
    #flip-result {
      margin-top: 16px;
      min-height: 24px;
      font-weight: 700;
      font-size: 1.1em;
      text-align: center;
      color: #fbbf24;
      display: none;
    }

    /* Bottom Nav */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 340px;
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px 20px 0 0;
      padding: 16px 8px;
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 100;
    }
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      padding: 6px 4px;
      border-radius: 10px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      min-width: 45px;
      flex: 1;
      margin: 0 2px;
      transition: all 0.2s;
    }
    .nav-item:hover { background: rgba(255,255,255,0.1); transform: translateY(-2px); }
    .nav-icon {
      width: 20px;
      height: 20px;
      margin-bottom: 3px;
      background: #fff;
      mask-size: contain;
      mask-repeat: no-repeat;
      mask-position: center;
    }
    .nav-home .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m3 12 2-2m0 0 7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6'/%3E%3C/svg%3E"); }
    .nav-win .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='currentColor' d='M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z'/%3E%3C/svg%3E"); }
    .nav-ads .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z'/%3E%3C/svg%3E"); }
    .nav-refer .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z'/%3E%3C/svg%3E"); }
    .nav-task .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'/%3E%3C/svg%3E"); }
    .nav-wallet .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 00-3 3z'/%3E%3C/svg%3E"); }
    .nav-label { font-size: 0.65em; font-weight: 500; color: #e0e0e0; text-transform: uppercase; letter-spacing: 0.3px; }

    #snackbar {
      display: none;
      position: fixed;
      top: 18px;
      left: 50%;
      transform: translateX(-50%);
      background: #059669;
      color: white;
      padding: 12px 24px;
      border-radius: 24px;
      z-index: 2001;
      font-weight: 600;
      font-size: 1em;
      box-shadow: 0 4px 16px rgba(5,150,105,0.4);
      transition: opacity 0.4s;
      opacity: 1;
      letter-spacing: 0.5px;
    }
    #snackbar.error { background: #ef4444; box-shadow: 0 4px 16px rgba(239,68,68,0.4); }

    @media (max-width: 360px) {
      .container { width: 100%; padding: 10px 5px 110px 5px; }
      .bottom-nav { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-title">🪙 Coin Flip Game</div>
    </div>

    <!-- Balance Display -->
    <div class="balance-display">
      <div class="balance-item">
        <div class="balance-label">BUMS Balance</div>
        <div class="balance-value" id="user-bums">0</div>
      </div>
      <div class="balance-item">
        <div class="balance-label">TON Balance</div>
        <div class="balance-value" id="user-ton">0.00</div>
      </div>
    </div>

    <!-- Game Stats -->
    <div class="game-stats">
      <div class="stat-card">
        <div class="stat-label">Total Played</div>
        <div class="stat-value" id="total-played">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Won</div>
        <div class="stat-value" id="total-won">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Win Rate</div>
        <div class="stat-value" id="win-rate">0%</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Profit/Loss</div>
        <div class="stat-value" id="profit-loss">0</div>
      </div>
    </div>

    <!-- Coin Flip Game -->
    <div class="game-card">
      <!-- Coin Visual -->
      <div class="coin-container">
        <div class="coin" id="coin">
          <div class="coin-face coin-head">H</div>
          <div class="coin-face coin-tail">T</div>
        </div>
      </div>

      <div style="text-align: center; margin: 12px 0;">
        <div style="font-size: 0.9em; color: #9ca3af; margin-bottom: 8px;">Select your side</div>
        <div style="display: flex; justify-content: center; gap: 12px; margin: 10px 0;">
          <button id="btn-head" class="tab-btn" style="flex:1; padding:10px; background: rgba(255,255,255,0.08); color: #e0e0e0;">
            👑 HEAD
          </button>
          <button id="btn-tail" class="tab-btn" style="flex:1; padding:10px; background: rgba(255,255,255,0.08); color: #e0e0e0;">
            💎 TAIL
          </button>
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">Enter Bet Amount (BUMS) - Min: 100</label>
        <input type="number" id="bet-bums" class="input-field" placeholder="Enter BUMS amount" min="100" step="100">
      </div>

      <div class="input-group">
        <label class="input-label">Enter Bet Amount (TON) - Min: 0.01</label>
        <input type="number" id="bet-ton" class="input-field" placeholder="Enter TON amount" min="0.01" step="0.01">
      </div>

      <button id="flip-btn" class="action-btn" style="margin-top: 16px;">
        🎲 FLIP COIN
      </button>

      <div id="flip-result"></div>
    </div>
  </div>

  <div id="snackbar"></div>

  <div class="bottom-nav">
    <div class="nav-item nav-home" onclick="window.location.href='index.html'">
      <div class="nav-icon"></div><span class="nav-label">Home</span>
    </div>
    <div class="nav-item nav-win" onclick="window.location.href='win.html'">
      <div class="nav-icon"></div><span class="nav-label">Win</span>
    </div>
    <div class="nav-item nav-ads" onclick="window.location.href='ads.html'">
      <div class="nav-icon"></div><span class="nav-label">Ads</span>
    </div>
    <div class="nav-item nav-refer" onclick="window.location.href='refer.html'">
      <div class="nav-icon"></div><span class="nav-label">Refer</span>
    </div>
    <div class="nav-item nav-task" onclick="window.location.href='tasks.html'">
      <div class="nav-icon"></div><span class="nav-label">Tasks</span>
    </div>
    <div class="nav-item nav-wallet" onclick="window.location.href='wallet.html'">
      <div class="nav-icon"></div><span class="nav-label">Wallet</span>
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js?56"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBv4V4zPlUlbotICs5JVVJVfeZ_wesBCQI",
      authDomain: "momey-bims.firebaseapp.com",
      databaseURL: "https://momey-bims-default-rtdb.firebaseio.com",
      projectId: "momey-bims",
      storageBucket: "momey-bims.firebasestorage.app",
      messagingSenderId: "21496105095",
      appId: "1:21496105095:web:cbd7b39dada8f0b671d022",
      measurementId: "G-ECE8ZBS23B"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
    const userKey = tgUser ? String(tgUser.id) : "NOT_APP";

    let userData = {
      bums: 0,
      ton: 0,
      totalPlayed: 0,
      totalWon: 0,
      totalProfit: 0
    };

    async function init() {
      if (userKey === "NOT_APP") {
        document.getElementById('flip-btn').disabled = true;
        showSnackbar('Please open in Telegram app', true);
        return;
      }
      await loadUserData();
      updateUI();
    }

    async function loadUserData() {
      try {
        const userRef = ref(db, 'users/' + userKey);
        const snap = await get(userRef);
        if (snap.exists()) {
          const data = snap.val();
          userData.bums = parseInt(data.bums || 0);
          userData.ton = parseFloat(data.ton || 0);
          userData.totalPlayed = parseInt(data.totalPlayed || 0);
          userData.totalWon = parseInt(data.totalWon || 0);
          userData.totalProfit = parseFloat(data.totalProfit || 0);
        } else {
          await update(userRef, {
            bums: 0,
            ton: 0,
            totalPlayed: 0,
            totalWon: 0,
            totalProfit: 0
          });
        }
      } catch (error) {
        console.error('Error loading data:', error);
        showSnackbar('Error loading data', true);
      }
    }

    function updateUI() {
      document.getElementById('user-bums').textContent = userData.bums.toLocaleString();
      document.getElementById('user-ton').textContent = userData.ton.toFixed(4);
      document.getElementById('total-played').textContent = userData.totalPlayed;
      document.getElementById('total-won').textContent = userData.totalWon;
      
      const winRate = userData.totalPlayed > 0 
        ? ((userData.totalWon / userData.totalPlayed) * 100).toFixed(1) 
        : 0;
      document.getElementById('win-rate').textContent = winRate + '%';
      
      const profitColor = userData.totalProfit >= 0 ? '#4ade80' : '#ef4444';
      document.getElementById('profit-loss').textContent = userData.totalProfit.toFixed(2);
      document.getElementById('profit-loss').style.color = profitColor;
    }

    async function saveUserData() {
      try {
        const userRef = ref(db, 'users/' + userKey);
        await update(userRef, {
          bums: userData.bums,
          ton: userData.ton,
          totalPlayed: userData.totalPlayed,
          totalWon: userData.totalWon,
          totalProfit: userData.totalProfit
        });
      } catch (error) {
        console.error('Error saving data:', error);
        showSnackbar('Error saving data', true);
      }
    }

    function showSnackbar(msg, isError = false) {
      const bar = document.getElementById('snackbar');
      if (!bar) return;
      bar.textContent = msg;
      bar.className = isError ? 'error' : '';
      bar.style.display = 'block';
      bar.style.opacity = 1;
      setTimeout(() => {
        bar.style.opacity = 0;
        setTimeout(() => { bar.style.display = 'none'; }, 400);
      }, isError ? 4000 : 3000);
    }

    // === Coin Flip Logic ===
    let selectedSide = null;
    let isFlipping = false;

    document.getElementById('btn-head').addEventListener('click', () => {
      selectedSide = 'HEAD';
      document.getElementById('btn-head').classList.add('selected-side');
      document.getElementById('btn-tail').classList.remove('selected-side');
    });

    document.getElementById('btn-tail').addEventListener('click', () => {
      selectedSide = 'TAIL';
      document.getElementById('btn-tail').classList.add('selected-side');
      document.getElementById('btn-head').classList.remove('selected-side');
    });

    document.getElementById('flip-btn').addEventListener('click', async () => {
      if (isFlipping) return;

      const resultEl = document.getElementById('flip-result');
      const coinEl = document.getElementById('coin');
      const flipBtn = document.getElementById('flip-btn');
      resultEl.style.display = 'none';

      const bumsBet = parseFloat(document.getElementById('bet-bums').value) || 0;
      const tonBet = parseFloat(document.getElementById('bet-ton').value) || 0;

      if (!selectedSide) return showSnackbar('❌ Please select HEAD or TAIL', true);
      if (bumsBet === 0 && tonBet === 0) return showSnackbar('❌ Please enter a bet amount', true);
      if (bumsBet > 0 && tonBet > 0) return showSnackbar('❌ Bet only BUMS or TON, not both', true);
      if (bumsBet > 0 && bumsBet < 100) return showSnackbar('❌ Min BUMS bet: 100', true);
      if (tonBet > 0 && tonBet < 0.01) return showSnackbar('❌ Min TON bet: 0.01', true);

      let betAmount = 0, betCurrency = '';
      if (bumsBet > 0) {
        betAmount = bumsBet; betCurrency = 'BUMS';
        if (userData.bums < betAmount) return showSnackbar('❌ Insufficient BUMS', true);
      } else {
        betAmount = tonBet; betCurrency = 'TON';
        if (userData.ton < betAmount) return showSnackbar('❌ Insufficient TON', true);
      }

      if (betCurrency === 'TON') userData.ton -= betAmount;
      else userData.bums -= betAmount;
      userData.totalPlayed++;
      updateUI();

      isFlipping = true;
      flipBtn.disabled = true;
      flipBtn.textContent = '🎲 Flipping...';
      coinEl.classList.add('flipping');

      setTimeout(async () => {
        coinEl.classList.remove('flipping');

        // 🔥 25% WIN CHANCE AFTER SELECTION
        let flipResult;
        if (Math.random() < 0.25) {
          flipResult = selectedSide; // User wins (25%)
        } else {
          flipResult = selectedSide === 'HEAD' ? 'TAIL' : 'HEAD'; // User loses (75%)
        }

        const won = flipResult === selectedSide;
        coinEl.style.transform = flipResult === 'TAIL' ? 'rotateY(180deg)' : 'rotateY(0deg)';

        if (won) {
          const reward = betAmount * 2;
          if (betCurrency === 'TON') {
            userData.ton += reward;
            userData.totalProfit += betAmount;
          } else {
            userData.bums += reward;
            userData.totalProfit += betAmount;
          }
          userData.totalWon++;
          resultEl.innerHTML = `
            <div style="font-size: 1.3em; margin-bottom: 8px;">🎉 YOU WIN! 🎉</div>
            <div style="font-size: 1em; color: #4ade80;">Result: ${flipResult}</div>
            <div style="font-size: 0.95em; color: #fbbf24; margin-top: 8px;">
              +${betCurrency === 'TON' ? reward.toFixed(4) : reward} ${betCurrency}
            </div>
          `;
          resultEl.style.color = '#4ade80';
          showSnackbar(`🎉 Won ${betCurrency === 'TON' ? reward.toFixed(4) : reward} ${betCurrency}!`, false);
          createConfetti();
        } else {
          userData.totalProfit -= betAmount;
          resultEl.innerHTML = `
            <div style="font-size: 1.3em; margin-bottom: 8px;">❌ You Lose</div>
            <div style="font-size: 1em; color: #ef4444;">Result: ${flipResult}</div>
            <div style="font-size: 0.9em; color: #9ca3af; margin-top: 8px;">Better luck next time!</div>
          `;
          resultEl.style.color = '#ef4444';
          showSnackbar('❌ Better luck next time!', true);
        }

        resultEl.style.display = 'block';
        await saveUserData();
        updateUI();

        isFlipping = false;
        flipBtn.disabled = false;
        flipBtn.textContent = '🎲 FLIP COIN';

        setTimeout(() => {
          selectedSide = null;
          document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('selected-side'));
          document.getElementById('bet-bums').value = '';
          document.getElementById('bet-ton').value = '';
          resultEl.style.display = 'none';
          coinEl.style.transform = 'rotateY(0deg)';
        }, 5000);
      }, 1000);
    });

    function createConfetti() {
      const colors = ['#fbbf24', '#8b5cf6', '#4ade80', '#ef4444', '#3b82f6'];
      for (let i = 0; i < 30; i++) {
        setTimeout(() => {
          const c = document.createElement('div');
          c.style.cssText = `
            position: fixed; width: 10px; height: 10px;
            background: ${colors[Math.floor(Math.random() * colors.length)]};
            left: ${Math.random() * 100}%; top: -10px;
            border-radius: 50%; z-index: 9999; pointer-events: none;
          `;
          document.body.appendChild(c);
          let y = -10;
          const fall = setInterval(() => {
            if (y > window.innerHeight) { clearInterval(fall); c.remove(); }
            else { y += 5; c.style.top = y + 'px'; c.style.transform = 'rotate(' + y * 2 + 'deg)'; }
          }, 20);
        }, i * 50);
      }
    }

    init();
  </script>
</body>
</html>
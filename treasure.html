<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>Treasure - Open the chest</title>
  <meta name="viewport" content="width=340, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      background:linear-gradient(135deg,#0f172a 0%,#111827 50%,#0b1220 100%);
      color:#fff;font-family:'Inter',Arial,sans-serif;min-height:100vh;overflow-x:hidden;font-size:14px
    }
    .container{width:340px;margin:0 auto;padding:16px 10px 96px 10px}

    .title{font-size:26px;font-weight:800;text-align:center;letter-spacing:.3px;margin-top:2px}
    .badges{display:flex;justify-content:center;gap:10px;margin:10px 0 8px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border-radius:999px;
      font-weight:800;font-size:13px;border:1px solid rgba(255,255,255,.14);box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)
    }
    .pill.keys{background:linear-gradient(135deg,#3f3f46,#1f2937)}
    .pill.tickets{background:linear-gradient(135deg,#1e293b,#0f172a)}
    .pill .icon{font-size:16px}

    .card{
      background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:18px;
      padding:16px 12px;box-shadow:0 14px 36px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
      margin-top:10px
    }
    .chest-wrap{display:grid;place-items:center;margin:12px 0 2px 0;position:relative}
    .glow{
      width:240px;height:240px;border-radius:50%;
      background:radial-gradient(ellipse at center, rgba(255,215,0,.18) 0%, rgba(255,215,0,0) 60%);
      filter:blur(6px);position:absolute;z-index:0;pointer-events:none;transform:translateY(6px)
    }
    .chest{width:180px;height:180px;display:grid;place-items:center;position:relative;z-index:1;cursor:pointer}
    .chest-emoji{font-size:140px;filter:drop-shadow(0 12px 24px rgba(0,0,0,.45));transition:transform .12s ease}
    .chest:active .chest-emoji{transform:scale(.99)}
    .shake{animation:shake .9s cubic-bezier(.36,.07,.19,.97) both}
    @keyframes shake{
      10%,90%{transform:translateX(-1px)}
      20%,80%{transform:translateX(2px)}
      30%,50%,70%{transform:translateX(-4px)}
      40%,60%{transform:translateX(4px)}
    }
    .tap{text-align:center;color:#cbd5e1;margin:10px 0 2px 0;letter-spacing:.4px}

    .possible{margin-top:14px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:12px}
    .possible-title{font-weight:800;margin-bottom:8px;font-size:15px}
    .row{display:flex;gap:10px;justify-content:space-between}
    .box{flex:1;display:grid;place-items:center;gap:6px;padding:12px;border-radius:12px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08)}
    .box .ico{font-size:20px}
    .box .cap{font-size:12px;color:#cbd5e1}

    /* Compact Ad Box Styling */
    .ad-section{margin-top:16px}
    .section-header{
      display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;
      padding:10px 12px;background:rgba(251,191,36,.1);border:1px solid rgba(251,191,36,.3);
      border-radius:12px
    }
    .section-title{font-weight:800;font-size:16px;color:#fbbf24;display:flex;align-items:center;gap:8px}
    .section-info{font-size:11px;color:#cbd5e1;background:rgba(0,0,0,.3);padding:4px 8px;border-radius:8px}

    .ad-grid{display:flex;flex-direction:column;gap:12px}

    .compact-ad-box {
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.1);
      border-radius: 14px;
      padding: 12px;
      transition: all .3s ease;
    }

    .compact-ad-box:hover {
      border-color: rgba(59,130,246,.4);
      transform: translateY(-2px);
    }

    .compact-ad-box.completed {
      border-color: rgba(16,185,129,.5);
      background: rgba(16,185,129,.08);
      box-shadow: 0 0 20px rgba(16,185,129,.2);
    }

    .compact-ad-box.completed .ad-text {
      color: #10b981;
    }

    .compact-ad-content {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px;
      background: rgba(255,255,255,.03);
      border-radius: 10px;
    }

    .ad-text {
      font-weight: 600;
      font-size: 14px;
      color: #fbbf24;
      white-space: nowrap;
      min-width: 140px;
    }

    .ad-progress {
      font-size: 14px;
      font-weight: 600;
      color: #10b981;
      background: rgba(16,185,129,.15);
      padding: 6px 12px;
      border-radius: 12px;
      border: 1px solid rgba(16,185,129,.3);
    }

    .ad-progress.complete {
      background: rgba(16,185,129,.25);
      animation: pulse 2s infinite;
    }

    .play-btn {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      border: none;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .2s;
      color: white;
    }

    .play-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(59,130,246,.4);
    }

    .play-btn:active {
      transform: scale(1);
    }

    .play-btn:disabled {
      background: linear-gradient(135deg, #64748b, #475569);
      cursor: not-allowed;
      opacity: .6;
    }

    .play-btn.claim {
      background: linear-gradient(135deg, #10b981, #059669);
      animation: glow 2s ease-in-out infinite;
    }

    .play-btn.claim:hover {
      box-shadow: 0 4px 12px rgba(16,185,129,.5);
    }

    .ad-stats{
      display:flex;justify-content:space-between;margin-top:8px;
      padding-top:8px;border-top:1px solid rgba(255,255,255,.1);
      font-size:11px;color:#94a3b8
    }

    #snackbar{
      display:none;position:fixed;top:18px;left:50%;transform:translateX(-50%);
      background:#059669;color:white;padding:12px 24px;border-radius:24px;
      z-index:2001;font-weight:600;font-size:1em;
      box-shadow:0 4px 16px rgba(5,150,105,.4);transition:opacity .4s;
      opacity:1;letter-spacing:.5px
    }
    #snackbar.error{background:#ef4444;box-shadow:0 4px 16px rgba(239,68,68,.4)}

    /* Bottom navigation */
    .bottom-nav{
      position:fixed;bottom:0;left:50%;transform:translateX(-50%);
      width:340px;background:rgba(0,0,0,.9);backdrop-filter:blur(20px);
      border-top:1px solid rgba(255,255,255,.1);border-radius:20px 20px 0 0;
      padding:16px 8px;display:flex;justify-content:space-around;
      align-items:center;z-index:100
    }
    .nav-item{
      display:flex;flex-direction:column;align-items:center;
      cursor:pointer;padding:6px 4px;border-radius:10px;
      background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);
      min-width:45px;flex:1;margin:0 2px;transition:all .2s
    }
    .nav-item:hover{background:rgba(255,255,255,.1);transform:translateY(-2px)}
    .nav-icon{
      width:20px;height:20px;margin-bottom:3px;background:#fff;
      mask-size:contain;mask-repeat:no-repeat;mask-position:center
    }
    .nav-home .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m3 12 2-2m0 0 7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6'/%3E%3C/svg%3E")}
    .nav-win .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='currentColor' d='M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z'/%3E%3C/svg%3E")}
    .nav-ads .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z'/%3E%3C/svg%3E")}
    .nav-refer .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z'/%3E%3C/svg%3E")}
    .nav-task .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'/%3E%3C/svg%3E")}
    .nav-wallet .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z'/%3E%3C/svg%3E")}
    .nav-label{font-size:.65em;font-weight:500;color:#e0e0e0;text-transform:uppercase;letter-spacing:.3px}

    @media (max-width:360px){
      .container{width:100%;padding:10px 5px 110px 5px}
      .bottom-nav{width:100%}
    }

    .loading-spinner{
      display:inline-block;width:16px;height:16px;
      border:2px solid rgba(255,255,255,.3);
      border-radius:50%;border-top-color:#fff;
      animation:spin 1s linear infinite
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: .7; }
    }

    @keyframes glow {
      0%, 100% { box-shadow: 0 0 5px rgba(16,185,129,.5); }
      50% { box-shadow: 0 0 20px rgba(16,185,129,.8); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="title">Open the chest</div>

    <div class="badges">
      <div class="pill keys"><span class="count" id="keyCount">0</span><span class="icon">🔑</span></div>
      <div class="pill tickets"><span class="count" id="ticketCount">0</span><span class="icon">🎟️</span></div>
    </div>

    <div class="card">
      <div class="chest-wrap">
        <div class="glow"></div>
        <div class="chest" id="chest"><div class="chest-emoji" id="chestEmoji">🎁</div></div>
      </div>
      <div class="tap">Tap to Open</div>

      <div class="possible">
        <div class="possible-title">Possible treasures</div>
        <div class="row">
          <div class="box"><div class="ico">💰</div><div class="cap">BUMS</div></div>
          <div class="box"><div class="ico">🎟️</div><div class="cap">Ticket</div></div>
          <div class="box"><div class="ico">🎯</div><div class="cap">Spin</div></div>
        </div>
      </div>
    </div>

    <!-- Compact Ad Boxes Section -->
    <div class="card ad-section">
      <div class="section-header">
        <div class="section-title">
          <span>🎥</span>
          <span>Watch Ads & Earn Keys</span>
        </div>
        <div class="section-info">30 Ads = 1 🔑</div>
      </div>
      
      <div class="ad-grid">
        <div class="compact-ad-box" id="adBox1">
          <div class="compact-ad-content">
            <div class="ad-text">Watch 30 ads<br>and get 1 🔑</div>
            <div class="ad-progress" id="progress1">0/30</div>
            <button class="play-btn" id="adBtn1" onclick="watchAd(1)">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M8 5v14l11-7z"/>
              </svg>
            </button>
          </div>
          <div class="ad-stats">
            <span id="watched1">Watched: 0</span>
            <span id="remaining1">Remaining: 30</span>
          </div>
        </div>

        <div class="compact-ad-box" id="adBox2">
          <div class="compact-ad-content">
            <div class="ad-text">Watch 30 ads<br>and get 1 🔑</div>
            <div class="ad-progress" id="progress2">0/30</div>
            <button class="play-btn" id="adBtn2" onclick="watchAd(2)">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M8 5v14l11-7z"/>
              </svg>
            </button>
          </div>
          <div class="ad-stats">
            <span id="watched2">Watched: 0</span>
            <span id="remaining2">Remaining: 30</span>
          </div>
        </div>

        <div class="compact-ad-box" id="adBox3">
          <div class="compact-ad-content">
            <div class="ad-text">Watch 30 ads<br>and get 1 🔑</div>
            <div class="ad-progress" id="progress3">0/30</div>
            <button class="play-btn" id="adBtn3" onclick="watchAd(3)">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M8 5v14l11-7z"/>
              </svg>
            </button>
          </div>
          <div class="ad-stats">
            <span id="watched3">Watched: 0</span>
            <span id="remaining3">Remaining: 30</span>
          </div>
        </div>

        <div class="compact-ad-box" id="adBox4">
          <div class="compact-ad-content">
            <div class="ad-text">Watch 30 ads<br>and get 1 🔑</div>
            <div class="ad-progress" id="progress4">0/30</div>
            <button class="play-btn" id="adBtn4" onclick="watchAd(4)">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M8 5v14l11-7z"/>
              </svg>
            </button>
          </div>
          <div class="ad-stats">
            <span id="watched4">Watched: 0</span>
            <span id="remaining4">Remaining: 30</span>
          </div>
        </div>

        <div class="compact-ad-box" id="adBox5">
          <div class="compact-ad-content">
            <div class="ad-text">Watch 30 ads<br>and get 1 🔑</div>
            <div class="ad-progress" id="progress5">0/30</div>
            <button class="play-btn" id="adBtn5" onclick="watchAd(5)">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M8 5v14l11-7z"/>
              </svg>
            </button>
          </div>
          <div class="ad-stats">
            <span id="watched5">Watched: 0</span>
            <span id="remaining5">Remaining: 30</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="snackbar"></div>

  <!-- Bottom navigation -->
  <div class="bottom-nav">
    <div class="nav-item nav-home" onclick="window.location.href='index.html'">
      <div class="nav-icon"></div><span class="nav-label">Home</span>
    </div>
    <div class="nav-item nav-win" onclick="window.location.href='win.html'">
      <div class="nav-icon"></div><span class="nav-label">Win</span>
    </div>
    <div class="nav-item nav-ads" onclick="window.location.href='ads.html'">
      <div class="nav-icon"></div><span class="nav-label">Ads</span>
    </div>
    <div class="nav-item nav-refer" onclick="window.location.href='refer.html'">
      <div class="nav-icon"></div><span class="nav-label">Refer</span>
    </div>
    <div class="nav-item nav-task" onclick="window.location.href='tasks.html'">
      <div class="nav-icon"></div><span class="nav-label">Tasks</span>
    </div>
    <div class="nav-item nav-wallet" onclick="window.location.href='wallet.html'">
      <div class="nav-icon"></div><span class="nav-label">Wallet</span>
    </div>
  </div>

  <script src="//libtl.com/sdk.js" data-zone="10005741" data-sdk="show_10005741"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, get, set, runTransaction } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    function toast(msg, isError = false) {
      const el = document.getElementById('snackbar');
      el.textContent = msg;
      el.className = isError ? 'error' : '';
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, isError ? 3600 : 2400);
    }

    const firebaseConfig = {
      apiKey: "AIzaSyBv4V4zPlUlbotICs5JVVJVfeZ_wesBCQI",
      authDomain: "momey-bims.firebaseapp.com",
      databaseURL: "https://momey-bims-default-rtdb.firebaseio.com",
      projectId: "momey-bims",
      storageBucket: "momey-bims.firebasestorage.app",
      messagingSenderId: "21496105095",
      appId: "1:21496105095:web:cbd7b39dada8f0b671d022",
      measurementId: "G-ECE8ZBS23B"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    window.Telegram?.WebApp?.ready?.();
    const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
    const userKey = tgUser?.id ? String(tgUser.id) : "UNKNOWN_USER";

    const elKey = document.getElementById('keyCount');
    const elTick = document.getElementById('ticketCount');
    const chest = document.getElementById('chest');

    async function loadBalances() {
      try {
        const keyRef = ref(db, 'users/' + userKey + '/key');
        const ticketRef = ref(db, 'users/' + userKey + '/ticket');
        const spinRef = ref(db, 'users/' + userKey + '/spin');
        const bumsRef = ref(db, 'users/' + userKey + '/bums');

        const [kS, tS, sS, bS] = await Promise.all([
          get(keyRef),
          get(ticketRef),
          get(spinRef),
          get(bumsRef)
        ]);

        if (!kS.exists()) await set(keyRef, 0);
        if (!tS.exists()) await set(ticketRef, 0);
        if (!sS.exists()) await set(spinRef, 0);
        if (!bS.exists()) await set(bumsRef, 0);

        elKey.textContent = String(kS.exists() ? (kS.val() ?? 0) : 0);
        elTick.textContent = String(tS.exists() ? (tS.val() ?? 0) : 0);
      } catch (e) {
        console.error('Error loading balances:', e);
        toast('Failed to load balances', true);
      }
    }

    async function spendOneKey() {
      const keyRef = ref(db, `users/${userKey}/key`);
      let snap = await get(keyRef);
      let start = Number(snap.val() ?? 0);
      if (!Number.isFinite(start)) start = parseInt(snap.val(), 10) || 0;
      if (start <= 0) throw new Error('NO_KEYS');

      const attempt = () => runTransaction(keyRef, cur => {
        let v = Number(cur ?? 0);
        if (!Number.isFinite(v)) v = parseInt(cur, 10) || 0;
        return v > 0 ? v - 1 : v;
      });

      let res = await attempt();
      if (!res.committed) {
        res = await attempt();
        if (!res.committed) throw new Error('KEY_RETRY_ABORT');
      }
      return Number(res.snapshot.val() ?? 0);
    }

    async function addBums(amount) {
      const r = ref(db, 'users/' + userKey + '/bums');
      await runTransaction(r, cur => Number(cur ?? 0) + Number(amount));
    }
    
    async function addTicket(cnt = 1) {
      const r = ref(db, 'users/' + userKey + '/ticket');
      const res = await runTransaction(r, cur => Number(cur ?? 0) + Number(cnt));
      elTick.textContent = String(res.snapshot.val() ?? 0);
    }
    
    async function addSpin(cnt = 1) {
      const r = ref(db, 'users/' + userKey + '/spin');
      await runTransaction(r, cur => Number(cur ?? 0) + Number(cnt));
    }

    const REWARDS = [
      {type:'BUMS',   value:5,  weight:28},
      {type:'BUMS',   value:10, weight:22},
      {type:'BUMS',   value:20, weight:12},
      {type:'TICKET', value:1,  weight:18},
      {type:'SPIN',   value:1,  weight:20},
    ];
    
    function pickReward() {
      const total = REWARDS.reduce((a, r) => a + r.weight, 0);
      let roll = Math.random() * total;
      for (const r of REWARDS) { 
        if ((roll -= r.weight) <= 0) return r; 
      }
      return REWARDS[0];
    }

    let opening = false;
    chest.addEventListener('click', async () => {
      if (opening) return;
      try {
        const left = await spendOneKey();
        elKey.textContent = String(left);

        opening = true;
        chest.classList.add('shake');

        setTimeout(async () => {
          const prize = pickReward();
          if (prize.type === 'BUMS') { 
            await addBums(prize.value); 
            toast(`🎉 +${prize.value} BUMS`); 
          }
          else if (prize.type === 'TICKET') { 
            await addTicket(prize.value); 
            toast(`🎟️ +${prize.value} Ticket`); 
          }
          else { 
            await addSpin(prize.value); 
            toast(`🎯 +${prize.value} Spin`); 
          }
          chest.classList.remove('shake');
          opening = false;
        }, 900);
      } catch (e) {
        if (e.message === 'NO_KEYS') toast('No keys available', true);
        else { 
          console.error(e); 
          toast('Open failed', true); 
        }
      }
    });

    // ==================== AD BOX MANAGEMENT ====================
    const AD_BOXES = 5;
    const ADS_REQUIRED = 30;
    let adWatching = {};

    async function loadAdProgress() {
      try {
        for (let i = 1; i <= AD_BOXES; i++) {
          const progressRef = ref(db, `users/${userKey}/adProgress/box${i}`);
          const snap = await get(progressRef);
          const count = snap.exists() ? Number(snap.val() ?? 0) : 0;
          if (!snap.exists()) await set(progressRef, 0);
          updateAdUI(i, count);
        }
      } catch (e) {
        console.error('Error loading ad progress:', e);
        toast('Failed to load ad progress', true);
      }
    }

    function updateAdUI(boxNum, count) {
      const progressEl = document.getElementById(`progress${boxNum}`);
      const btnEl = document.getElementById(`adBtn${boxNum}`);
      const boxEl = document.getElementById(`adBox${boxNum}`);
      const watchedEl = document.getElementById(`watched${boxNum}`);
      const remainingEl = document.getElementById(`remaining${boxNum}`);

      if (!progressEl || !btnEl || !boxEl) return;

      progressEl.textContent = `${count}/${ADS_REQUIRED}`;
      if (watchedEl) watchedEl.textContent = `Watched: ${count}`;
      if (remainingEl) remainingEl.textContent = `Remaining: ${ADS_REQUIRED - count}`;

      if (count >= ADS_REQUIRED) {
        btnEl.classList.add('claim');
        boxEl.classList.add('completed');
        progressEl.classList.add('complete');
      } else {
        btnEl.classList.remove('claim');
        boxEl.classList.remove('completed');
        progressEl.classList.remove('complete');
      }
    }

    async function addKey(count = 1) {
      const keyRef = ref(db, `users/${userKey}/key`);
      const res = await runTransaction(keyRef, cur => Number(cur ?? 0) + Number(count));
      elKey.textContent = String(res.snapshot.val() ?? 0);
      return res.snapshot.val();
    }

    window.watchAd = async function(boxNum) {
      if (adWatching[boxNum]) {
        toast('Please wait for current ad to complete', true);
        return;
      }

      const progressRef = ref(db, `users/${userKey}/adProgress/box${boxNum}`);
      const btnEl = document.getElementById(`adBtn${boxNum}`);

      try {
        const snap = await get(progressRef);
        const currentCount = snap.exists() ? Number(snap.val() ?? 0) : 0;

        if (currentCount >= ADS_REQUIRED) {
          btnEl.disabled = true;
          btnEl.innerHTML = '<span class="loading-spinner"></span>';
          try {
            await addKey(1);
            await set(progressRef, 0);
            updateAdUI(boxNum, 0);
            toast(`🔑 +1 Key claimed from Ad Box ${boxNum}!`);
          } catch (e) {
            console.error('Error claiming key:', e);
            toast('Failed to claim key', true);
          } finally {
            btnEl.disabled = false;
            btnEl.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
          }
          return;
        }

        adWatching[boxNum] = true;
        btnEl.disabled = true;
        btnEl.innerHTML = '<span class="loading-spinner"></span>';

        // Trigger ad
        try {
          if (window.show_10005741) window.show_10005741();
        } catch (e) {
          console.log('Monetag ad trigger:', e);
        }

        const adDuration = 2000 + Math.random() * 1000;

        setTimeout(async () => {
          try {
            const newCount = currentCount + 1;
            await set(progressRef, newCount);
            updateAdUI(boxNum, newCount);
            if (newCount >= ADS_REQUIRED) {
              toast(`🎉 Ad Box ${boxNum} completed! Claim your key now!`);
            } else {
              toast(`✅ Ad watched! Progress: ${newCount}/${ADS_REQUIRED}`);
            }
          } catch (e) {
            console.error('Error updating progress:', e);
            toast('Failed to save progress', true);
          } finally {
            adWatching[boxNum] = false;
            btnEl.disabled = false;
            btnEl.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
          }
        }, adDuration);

      } catch (e) {
        console.error('Error in watchAd:', e);
        toast('Ad loading failed', true);
        adWatching[boxNum] = false;
        btnEl.disabled = false;
        btnEl.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
      }
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', async () => {
        await loadBalances();
        await loadAdProgress();
      });
    } else {
      loadBalances().then(() => loadAdProgress());
    }

    setInterval(() => loadAdProgress(), 30000);
  </script>
</body>
</html>
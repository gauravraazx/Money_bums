<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=340, initial-scale=1.0" />
  <title>Tickets - Weekly Draw</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:#0b0b0f;color:#fff;font-family:'Inter',Arial,sans-serif;min-height:100vh;overflow-x:hidden;font-size:14px}
    .wrap{width:340px;margin:0 auto;padding:16px 12px 110px}

    .top-card{display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:14px 16px;margin-bottom:14px;box-shadow:0 10px 28px rgba(0,0,0,.35)}
    .tk-left{display:flex;align-items:center;gap:10px}
    .tk-pill{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);padding:8px 12px;border-radius:12px;font-weight:800}
    .get-btn{background:#fff;color:#111;border:none;border-radius:14px;padding:10px 18px;font-weight:800;cursor:pointer}

    .h1{font-weight:800;font-size:1.15em;margin:14px 2px 8px 2px;letter-spacing:.3px}
    .hint{display:inline-flex;align-items:center;gap:6px;color:#cdd3e2;font-size:.9em}

    .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:14px;margin-top:12px;box-shadow:0 10px 28px rgba(0,0,0,.35)}
    .row{display:flex;justify-content:space-between;align-items:center;padding:10px 2px;border-bottom:1px solid rgba(255,255,255,.08)}
    .row:last-child{border-bottom:none}
    .lbl{color:#d9deed}
    .val{font-weight:800}

    .enter-box{display:flex;gap:10px;margin-top:12px}
    .enter-input{flex:1;border:none;border-radius:12px;padding:12px 14px;background:rgba(255,255,255,.08);color:#fff;border:1px solid rgba(255,255,255,.12);font-weight:700}
    .plus-btn{width:46px;height:46px;border:none;border-radius:12px;background:rgba(255,255,255,.1);color:#fff;font-size:20px;font-weight:900;cursor:pointer}

    .snack{position:fixed;top:16px;left:50%;transform:translateX(-50%);background:#10b981;color:#061a10;border:1px solid rgba(16,185,129,.5);padding:10px 16px;border-radius:12px;display:none;z-index:1000;font-weight:800}
    .snack.error{background:#ef4444;color:#fff;border-color:rgba(239,68,68,.6)}
    .snack.show{display:block}

    .bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:340px;background:rgba(0,0,0,.9);backdrop-filter:blur(20px);border-top:1px solid rgba(255,255,255,.1);border-radius:20px 20px 0 0;padding:16px 12px;display:flex;justify-content:space-around;align-items:center;z-index:100}
    .nav-item{display:flex;flex-direction:column;align-items:center;cursor:pointer;padding:8px 8px;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);min-width:50px;flex:1;margin:0 2px;transition:transform .2s ease, background .2s ease}
    .nav-item:hover{background:rgba(255,255,255,.1);transform:translateY(-2px)}
    .nav-item.active{background:rgba(102,126,234,.2);border-color:rgba(102,126,234,.3)}
    .nav-icon{width:22px;height:22px;margin-bottom:4px;background:#fff;mask-size:contain;mask-repeat:no-repeat;mask-position:center}
    .nav-home .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m3 12 2-2m0 0 7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6'/%3E%3C/svg%3E")}
    .nav-invite .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7M16 6l-4-4-4 4M12 2v14' stroke='currentColor' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E")}
    .nav-task .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'/%3E%3C/svg%3E")}
    .nav-ads .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z'/%3E%3C/svg%3E")}
    .nav-wallet .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z'/%3E%3C/svg%3E")}
    .nav-label{font-size:.7em;font-weight:500;color:#e0e0e0;text-transform:uppercase;letter-spacing:.3px}

    @media(max-width:360px){
      .container{width:100%;padding:7px 3px 90px 3px}
      .bottom-nav{width:100%}
    }
    /* inline TON icon image */
    .ton-icon-img{width:18px;height:18px;object-fit:contain;vertical-align:-3px;margin:0 2px}
  </style>
</head>
<body>
  <div class="wrap">

    <div class="top-card">
      <div class="tk-left">
        <div class="tk-pill"><span id="myTickets">0</span> üéüÔ∏è</div>
      </div>
      <button id="getBtn" class="get-btn">Get</button>
    </div>

    <div class="h1">Take part in the weekly drawing <span class="hint">?</span></div>

    <div class="card" id="weeklyCard">
      <div class="row"><div class="lbl">Winners</div><div class="val" id="winners">10</div></div>
      <div class="row"><div class="lbl">Rewards</div><div class="val" id="rewards"></div></div>
      <div class="row"><div class="lbl">Tickets</div><div class="val" id="totalTickets">0 üéüÔ∏è</div></div>
      <div class="row"><div class="lbl">My tickets</div><div class="val" id="myEntered">0 üéüÔ∏è</div></div>
      <div class="row"><div class="lbl">Chance of winning</div><div class="val" id="chance">0.00 %</div></div>
      <div class="row"><div class="lbl">Results</div><div class="val" id="endsAt">‚Äî</div></div>

      <div class="enter-box">
        <input id="enterCount" class="enter-input" type="number" min="1" step="1" value="1" placeholder="Enter from 1 ticket" />
        <button id="enterBtn" class="plus-btn">+</button>
      </div>
    </div>
  </div>

  <div id="snack" class="snack"></div>

  <div class="bottom-nav">
    <div class="nav-item nav-home" onclick="window.location.href='index.html'">
      <div class="nav-icon"></div><span class="nav-label">Home</span>
    </div>
    <div class="nav-item nav-invite" onclick="window.location.href='invite.html'">
      <div class="nav-icon"></div><span class="nav-label">Invite</span>
    </div>
    <div class="nav-item nav-task" onclick="window.location.href='tasks.html'">
      <div class="nav-icon"></div><span class="nav-label">Tasks</span>
    </div>
    <div class="nav-item nav-ads" onclick="window.location.href='ads.html'">
      <div class="nav-icon"></div><span class="nav-label">Ads</span>
    </div>
    <div class="nav-item nav-wallet" onclick="window.location.href='wallet.html'">
      <div class="nav-icon"></div><span class="nav-label">Wallet</span>
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, onValue, get, set, runTransaction, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = { apiKey:"AIzaSyALUr9fR5GE5CxPwY2xdYcIEvy33nu4vbs", authDomain:"money-bums-c9eba.firebaseapp.com", databaseURL:"https://money-bums-c9eba-default-rtdb.firebaseio.com", projectId:"money-bums-c9eba", storageBucket:"money-bums-c9eba.firebasestorage.app", messagingSenderId:"759031341495", appId:"1:759031341495:web:e9d2f9a7ec124e0a524832", measurementId:"G-XWHHSQHPP9" };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    function resolveUID(){
      try{ const tg=window.Telegram?.WebApp; tg?.ready?.(); const u=tg?.initDataUnsafe?.user; if(u?.id) return String(u.id); }catch{}
      try{
        const url=new URL(location.href); const qp=url.searchParams;
        const uidParam=qp.get('uid'); if(uidParam) return String(uidParam);
        const raw=qp.get('tgWebAppData')||qp.get('tgwebappdata');
        const parseInit=(s)=>{ const p=new URLSearchParams(s); const k=p.get('user'); if(!k) return null; try{ return JSON.parse(k); }catch{ return null; } };
        let ju=raw?parseInit(raw):null;
        if(!ju&&location.hash){ const hp=new URLSearchParams(location.hash.slice(1)); const hr=hp.get('tgWebAppData')||hp.get('tgwebappdata'); if(hr) ju=parseInit(hr); }
        const saved=localStorage.getItem('debug_uid');
        if(ju?.id) return String(ju.id); if(saved) return saved;
      }catch{}
      return "NOT_APP";
    } // TMA init data pattern [web:101][web:126]

    const UID = resolveUID();

    const el=id=>document.getElementById(id);
    const snack=(m,bad=false)=>{ const s=el('snack'); s.textContent=m; s.classList.toggle('error',bad); s.classList.add('show'); clearTimeout(snack._t); snack._t=setTimeout(()=>s.classList.remove('show'), bad?3000:1600); };

    function isoWeekKey(d=new Date()){
      const dt=new Date(Date.UTC(d.getUTCFullYear(),d.getUTCMonth(),d.getUTCDate()));
      dt.setUTCDate(dt.getUTCDate()+4-(dt.getUTCDay()||7));
      const yearStart=new Date(Date.UTC(dt.getUTCFullYear(),0,1));
      const weekNo=Math.ceil((((dt-yearStart)/86400000)+1)/7);
      return `${dt.getUTCFullYear()}-W${String(weekNo).padStart(2,'0')}`;
    } // ISO Monday week [web:226][web:227]

    const weekKey = isoWeekKey();

    // Rewards HTML builder (10 TON image + 100M BUMS)
    function rewardsHTML(){
      const tonImg = "<img class='ton-icon-img' src='https://i.ibb.co/RGCjdRZy/1000023104-removebg-preview.png' alt='TON'>";
      return `10 ${tonImg} (100M BUMS)`;
    } // inline <img> sizing via CSS contain [web:162][web:173]

    const defaults = {
      winners: 10,
      rewards_text_html: rewardsHTML(),
      ends_at_iso: (()=>{ const x=new Date(); const day=x.getUTCDay(); const diff=(7-day)%7; const end=new Date(Date.UTC(x.getUTCFullYear(),x.getUTCMonth(),x.getUTCDate()+diff,0,0,0)); return end.toISOString().slice(0,16).replace('T',' ')+' UTC'; })()
    };

    async function ensureWeekly(){
      await runTransaction(ref(db, `globals/weekly/current_key`), v => v || weekKey);                         /* [web:77] */
      await runTransaction(ref(db, `globals/weekly/current`), cur => {
        const o = cur || {};
        if (o.winners == null) o.winners = defaults.winners;
        if (o.total_tickets == null) o.total_tickets = 0;
        if (o.ends_at_iso == null) o.ends_at_iso = defaults.ends_at_iso;
        if (o.rewards_text_html == null) o.rewards_text_html = defaults.rewards_text_html;
        return o;
      });                                                                                                     /* [web:73][web:77] */
    }

    async function ensureUser(){
      await runTransaction(ref(db, `users/${UID}/tickets`), v => Number(v||0));                               /* [web:77] */
      await runTransaction(ref(db, `users/${UID}/weekly/${weekKey}/my_tickets`), v => Number(v||0));          /* [web:77] */
    }

    function bindLive(){
      onValue(ref(db, `users/${UID}/tickets`), s => el('myTickets').textContent = Number(s.val()||0));        /* [web:73] */
      onValue(ref(db, `users/${UID}/weekly/${weekKey}/my_tickets`), s => {
        el('myEntered').textContent = `${Number(s.val()||0)} üéüÔ∏è`;
        recomputeChance();
      });                                                                                                     /* [web:73] */
      onValue(ref(db, `globals/weekly/current`), s => {
        const v = s.val()||{};
        el('winners').textContent = v.winners ?? 10;
        el('rewards').innerHTML = v.rewards_text_html ?? defaults.rewards_text_html;
        el('totalTickets').textContent = `${Number(v.total_tickets||0).toLocaleString()} üéüÔ∏è`;
        el('endsAt').textContent = v.ends_at_iso ?? defaults.ends_at_iso;
        recomputeChance();
      });                                                                                                     /* [web:73] */
    }

    function recomputeChance(){
      const totalTxt = el('totalTickets').textContent.split(' ')[0].replace(/,/g,'');
      const total = Number(totalTxt||0);
      const mineTxt = el('myEntered').textContent.split(' ')[0].replace(/,/g,'');
      const mine = Number(mineTxt||0);
      const pct = total>0 ? ((mine/total)*100) : 0;
      el('chance').textContent = `${pct.toFixed(2)} %`;
    }

    el('getBtn').addEventListener('click', ()=> location.href='treasure.html');

    el('enterBtn').addEventListener('click', async ()=>{
      const n = Math.max(1, Math.floor(Number(el('enterCount').value||1)));
      const ok = await runTransaction(ref(db, `users/${UID}/tickets`), cur=>{
        const c = Number(cur||0);
        if (c>=n) return c-n;
        return;
      });                                                                                                     /* [web:77] */
      if (!ok.committed){ snack('‚ùå Not enough tickets', true); return; }
      await runTransaction(ref(db, `globals/weekly/current/total_tickets`), v => Number(v||0)+n);             /* [web:77] */
      await runTransaction(ref(db, `users/${UID}/weekly/${weekKey}/my_tickets`), v => Number(v||0)+n);        /* [web:77] */
      snack(`‚úÖ Entered with ${n} ticket(s)`);
    });

    await ensureWeekly();
    await ensureUser();
    bindLive();
  </script>
</body>
</html>

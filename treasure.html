<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=340, initial-scale=1.0">
  <title>Treasure Hunt - BUMS</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:#000;color:#fff;font-family:'Inter',Arial,sans-serif;min-height:100vh;overflow-x:hidden;font-size:14px}
    .container{width:340px;margin:0 auto;padding:20px 16px 120px 16px}

    .header{text-align:center;margin-bottom:16px}
    .header h1{font-size:1.8em;font-weight:700;margin-bottom:8px}
    .badge-row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
    .key-count,.ticket-count{display:inline-flex;align-items:center;gap:8px;font-size:1.05em;background:rgba(255,193,7,.15);padding:6px 14px;border-radius:20px;border:2px solid rgba(255,193,7,.3)}
    .ticket-count{background:rgba(59,130,246,.15);border-color:rgba(59,130,246,.35)}
    .key-icon{font-size:1.1em}

    .treasure-main{text-align:center;margin:20px 0}
    .chest-box{width:200px;height:200px;margin:0 auto 10px;position:relative;cursor:pointer;transition:transform .3s ease}
    .chest-box:hover{transform:scale(1.05)}
    .chest-box img{width:100%;height:100%;object-fit:contain;filter:drop-shadow(0 10px 30px rgba(255,193,7,.4))}
    .chest-box.opening img{animation:shake .6s ease}
    @keyframes shake{0%,100%{transform:rotate(0) scale(1)}25%{transform:rotate(-8deg) scale(1.05)}50%{transform:rotate(8deg) scale(1.1)}75%{transform:rotate(-8deg) scale(1.05)}}
    .tap-text{font-size:1.05em;color:#ccc;letter-spacing:1px}

    .treasures-section{background:rgba(255,255,255,.05);border-radius:16px;padding:16px;margin:20px 0}
    .treasures-section h2{font-size:1.2em;font-weight:700;margin-bottom:12px;text-align:center}
    .treasure-items{display:flex;justify-content:space-around;align-items:center;gap:10px}
    .treasure-item{width:60px;height:60px;background:rgba(255,255,255,.08);border-radius:12px;display:flex;align-items:center;justify-content:center;border:2px solid rgba(255,255,255,.1);overflow:hidden}
    .treasure-item img{width:36px;height:36px;object-fit:contain;display:block}

    .ton-section{background:rgba(255,255,255,.05);border-radius:16px;padding:16px;display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .ton-left{display:flex;align-items:center;gap:12px}
    .ton-logo-img{width:40px;height:40px;object-fit:contain;border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,.35);background:#fff}
    .ton-balance{font-size:1.6em;font-weight:700}
    .withdraw-btn{background:rgba(255,255,255,.9);color:#000;border:none;padding:10px 16px;border-radius:12px;font-weight:700;font-size:.95em;cursor:pointer;transition:all .2s ease}
    .withdraw-btn:hover{background:#fff;transform:translateY(-2px)}

    /* Get tickets panel */
    .tickets-panel{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:14px;box-shadow:0 10px 28px rgba(0,0,0,.35)}
    .tp-title{text-align:center;font-weight:800;margin-bottom:10px}
    .tp-card{display:flex;align-items:center;justify-content:space-between;gap:10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px}
    .tp-text{font-weight:800}
    .tp-pill{min-width:64px;text-align:center;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);color:#e5e7eb;padding:8px 10px;border-radius:10px;font-weight:800}
    .tp-btn{border:none;border-radius:10px;padding:10px 12px;font-weight:800;color:#fff;background:linear-gradient(135deg,#60a5fa,#3b82f6);box-shadow:0 8px 20px rgba(59,130,246,.35);cursor:pointer}
    .tp-btn:disabled{opacity:.6;cursor:not-allowed}
    .tp-btn.loading{background:linear-gradient(135deg,#60a5fa,#3b82f6)}
    .tp-btn.loading::after{content:"";width:16px;height:16px;margin-left:8px;display:inline-block;border-radius:50%;border:2px solid rgba(255,255,255,.7);border-top-color:transparent;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:340px;background:rgba(0,0,0,.9);backdrop-filter:blur(20px);border-top:1px solid rgba(255,255,255,.1);border-radius:20px 20px 0 0;padding:16px 12px;display:flex;justify-content:space-around;align-items:center;z-index:100}
    .nav-item{display:flex;flex-direction:column;align-items:center;cursor:pointer;padding:8px 8px;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);min-width:50px;flex:1;margin:0 2px;transition:transform .2s ease, background .2s ease}
    .nav-item:hover{background:rgba(255,255,255,.1);transform:translateY(-2px)}
    .nav-item.active{background:rgba(102,126,234,.2);border-color:rgba(102,126,234,.3)}
    .nav-icon{width:22px;height:22px;margin-bottom:4px;background:#fff;mask-size:contain;mask-repeat:no-repeat;mask-position:center}
    .nav-home .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m3 12 2-2m0 0 7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6'/%3E%3C/svg%3E")}
    .nav-invite .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7M16 6l-4-4-4 4M12 2v14' stroke='currentColor' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E")}
    .nav-task .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'/%3E%3C/svg%3E")}
    .nav-ads .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z'/%3E%3C/svg%3E")}
    .nav-wallet .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z'/%3E%3C/svg%3E")}
    .nav-label{font-size:.7em;font-weight:500;color:#e0e0e0;text-transform:uppercase;letter-spacing:.3px}

    @media(max-width:360px){
      .container{width:100%;padding:7px 3px 90px 3px}
      .bottom-nav{width:100%}
    }

    .message{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#10b981;color:#071b0f;padding:12px 24px;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,.3);display:none;z-index:1000;animation:slideDown .3s ease;font-weight:700;border:1px solid rgba(16,185,129,.5)}
    .message.error{background:#ef4444;color:#fff;border-color:rgba(239,68,68,.6)}
    @keyframes slideDown{from{transform:translate(-50%,-100%)}to{transform:translate(-50%,0)}}
    .message.show{display:block}

    @media(max-width:360px){.container{width:100%;padding:15px 10px 110px 10px}.bottom-nav{width:100%}}
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>Open the chest</h1>
      <div class="badge-row">
        <div class="key-count"><span id="keyCount">0</span><span class="key-icon">üóùÔ∏è</span></div>
        <div class="ticket-count"><span id="ticketCount">0</span><span>üéüÔ∏è</span></div>
      </div>
    </div>

    <!-- Main Treasure Box -->
    <div class="treasure-main">
      <div class="chest-box" onclick="openChest('key')">
        <img src="https://i.ibb.co/Gv2WtyCD/1000023099-removebg-preview.png" alt="Treasure Chest">
      </div>
      <div class="tap-text">Tap to Open</div>
    </div>

    <!-- Possible Treasures -->
    <div class="treasures-section">
      <h2>Possible treasures</h2>
      <div class="treasure-items">
        <div class="treasure-item">üí∞</div>
        <div class="treasure-item"><img src="https://i.ibb.co/RGCjdRZy/1000023104-removebg-preview.png" alt="TON"></div>
        <div class="treasure-item">üéüÔ∏è</div>
        <div class="treasure-item">üéØ</div>
      </div>
    </div>

    <!-- TON Balance -->
    <div class="ton-section">
      <div class="ton-left">
        <img class="ton-logo-img" src="https://i.ibb.co/RGCjdRZy/1000023104-removebg-preview.png" alt="TON">
        <div class="ton-balance" id="tonBalance">0</div>
      </div>
      <button class="withdraw-btn" onclick="openChest('ton')">Min 1 TON</button>
    </div>

    <!-- Get tickets by ads -->
    <div class="tickets-panel">
      <div class="tp-title">Get tickets</div>
      <div class="tp-card">
        <div class="tp-text">Watch 10 ads and get 1 ticket</div>
        <div class="tp-pill"><span id="adsTicketProg">0</span>/10</div>
        <button id="playTicketAdBtn" class="tp-btn">‚ñ∂ Watch</button>
      </div>
    </div>
  </div>

  <div class="message" id="message"></div>

  <div class="bottom-nav">
    <div class="nav-item nav-home" onclick="window.location.href='index.html'">
      <div class="nav-icon"></div><span class="nav-label">Home</span>
    </div>
    <div class="nav-item nav-invite" onclick="window.location.href='invite.html'">
      <div class="nav-icon"></div><span class="nav-label">Invite</span>
    </div>
    <div class="nav-item nav-task" onclick="window.location.href='tasks.html'">
      <div class="nav-icon"></div><span class="nav-label">Tasks</span>
    </div>
    <div class="nav-item nav-ads" onclick="window.location.href='ads.html'">
      <div class="nav-icon"></div><span class="nav-label">Ads</span>
    </div>
    <div class="nav-item nav-wallet" onclick="window.location.href='wallet.html'">
      <div class="nav-icon"></div><span class="nav-label">Wallet</span>
    </div>
  </div>

  <!-- Monetag SDK (zone for ads) -->
  <script src="//libtl.com/sdk.js" data-zone="10005741" data-sdk="show_10005741"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyALUr9fR5GE5CxPwY2xdYcIEvy33nu4vbs",
      authDomain: "money-bums-c9eba.firebaseapp.com",
      databaseURL: "https://money-bums-c9eba-default-rtdb.firebaseio.com",
      projectId: "money-bums-c9eba",
      storageBucket: "money-bums-c9eba.firebasestorage.app",
      messagingSenderId: "759031341495",
      appId: "1:759031341495:web:e9d2f9a7ec124e0a524832",
      measurementId: "G-XWHHSQHPP9"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    let currentUserId = null;

    // Pools
    const KEY_TREASURES = [
      { type:'BUMS', icon:'üí∞', min:10, max:25, field:'balance' },
      { type:'TON',  icon:'üíé', min:0.001, max:0.005, field:'ton_balance', ton:true },
      { type:'Ticket', icon:'üéüÔ∏è', amount:1, field:'tickets' },
      { type:'Spin', icon:'üéØ', amount:1, field:'spin_balance' }
    ];
    const TON_TREASURES = [
      { type:'TON',  icon:'üíé', min:0.1, max:1, field:'ton_balance', ton:true },
      { type:'BUMS', icon:'üí∞', min:50, max:100, field:'balance' },
      { type:'Ticket', icon:'üéüÔ∏è', amount:1, field:'tickets' },
      { type:'Spin', icon:'üéØ', amount:1, field:'spin_balance' }
    ];

    function getTelegramUser(){
      try{ const tg=window.Telegram?.WebApp; tg?.ready?.(); const u=tg?.initDataUnsafe?.user; if(u?.id) return u; }catch{}
      try{
        const parse=(src)=>{ const sp=new URLSearchParams(src); const raw=sp.get('tgWebAppData')||sp.get('tgwebappdata'); if(!raw) return null; const inner=new URLSearchParams(raw); const s=inner.get('user'); return s?JSON.parse(s):null; };
        const h=location.hash? parse(location.hash.slice(1)) : null; if(h?.id) return h;
        const q=parse(location.search.slice(1)); if(q?.id) return q;
      }catch{}
      return { id:"NOT_APP" };
    }

    async function initializeUser(userId){
      const userRef = ref(db, `users/${userId}`);
      const snapshot = await get(userRef);
      if (!snapshot.exists()){
        await set(userRef, {
          balance:0, ton_balance:0, tickets:0, spin_balance:0,
          key:{ balance:1, lastKeyTime: Date.now() }
        });
      } else {
        const data = snapshot.val()||{};
        if (data.tickets==null){ await runTransaction(ref(db, `users/${userId}/tickets`), cur => Number(cur||0)); }
        if (!data.key){
          await set(ref(db, `users/${userId}/key`), { balance:1, lastKeyTime: Date.now() });
        }
      }
      loadUserData(userId);
      // ensure ads_ticket node
      await runTransaction(ref(db, `users/${userId}/ads_ticket`), cur => cur || { count:0, total:0, last_award:0 });
    }

    function loadUserData(userId){
      onValue(ref(db, `users/${userId}/key/balance`), s => {
        document.getElementById('keyCount').textContent = Number(s.val()||0);
      });
      onValue(ref(db, `users/${userId}/tickets`), s => {
        document.getElementById('ticketCount').textContent = Number(s.val()||0);
      });
      onValue(ref(db, `users/${userId}/ton_balance`), s => {
        document.getElementById('tonBalance').textContent = Number(s.val()||0).toFixed(2);
      });
      onValue(ref(db, `users/${userId}/ads_ticket/count`), s=>{
        document.getElementById('adsTicketProg').textContent = Number(s.val()||0);
      });
      checkDailyKey(userId);
    }

    async function checkDailyKey(userId){
      const keyRef = ref(db, `users/${userId}/key`);
      const snap = await get(keyRef);
      const keyData = snap.val() || {};
      const now = Date.now();
      const oneDay = 24*60*60*1000;
      const last = Number(keyData.lastKeyTime||0);
      if (now - last >= oneDay){
        await runTransaction(keyRef, cur=>{
          const k = cur || {};
          return { balance: Number(k.balance||0)+1, lastKeyTime: now };
        });
        showMessage('üéâ Daily key received!');
      }
    }

    function showMessage(text, isError=false){
      const el = document.getElementById('message');
      el.textContent = text;
      el.classList.toggle('error', !!isError);
      el.classList.add('show');
      clearTimeout(showMessage._t);
      showMessage._t = setTimeout(()=> el.classList.remove('show'), 3000);
    }

    function randomReward(min, max, isTON=false){
      const r = Math.random() * (max - min) + min;
      return isTON ? Number(r.toFixed(3)) : Math.floor(r);
    }

    async function spendKey(userId){
      const keyRef = ref(db, `users/${userId}/key/balance`);
      const res = await runTransaction(keyRef, cur=>{
        const c = Number(cur||0);
        if (c>0) return c-1;
        return;
      });
      return res.committed;
    }

    async function spendTON(userId, amt){
      const tonRef = ref(db, `users/${userId}/ton_balance`);
      const res = await runTransaction(tonRef, cur=>{
        const c = Number(cur||0);
        if (c>=amt) return Number((c-amt).toFixed(9));
        return;
      });
      return res.committed;
    }

    async function credit(userId, field, amount){
      const refPath = ref(db, `users/${userId}/${field}`);
      await runTransaction(refPath, cur => {
        const base = Number(cur||0);
        const next = base + Number(amount||0);
        return field==='ton_balance' ? Number(next.toFixed(9)) : next;
      });
    }

    // Monetag ensure + show
    let monetagReadyPromise = null;
    function ensureMonetag(){
      if (typeof window.show_10005741 === 'function') return Promise.resolve();
      if (monetagReadyPromise) return monetagReadyPromise;
      monetagReadyPromise = new Promise((resolve)=>{
        const tag = document.querySelector('script[data-zone="10005741"][data-sdk="show_10005741"]');
        if (tag){
          tag.addEventListener('load', ()=> resolve(), { once:true });
          setTimeout(()=> resolve(), 1200);
        } else {
          const s=document.createElement('script');
          s.src='//libtl.com/sdk.js';
          s.dataset.zone='10005741';
          s.dataset.sdk='show_10005741';
          s.onload=()=>resolve();
          document.body.appendChild(s);
        }
      });
      return monetagReadyPromise;
    }
    async function showAdSafe(placement){
      try{
        await ensureMonetag();
        if (typeof window.show_10005741 === 'function'){
          await window.show_10005741({ ymid:String(currentUserId), requestVar:String(placement||'treasure_ticket') });
        }
      }catch(e){}
    } // Monetag Promise interface [web:187][web:186]

    // Ticket ad progress: every 10 views -> +1 ticket
    async function recordTicketViewAndMaybeAward(){
      const res = await runTransaction(ref(db, `users/${currentUserId}/ads_ticket`), cur=>{
        const o = cur || { count:0, total:0, last_award:0 };
        let count = Number(o.count||0) + 1;
        const total = Number(o.total||0) + 1;
        const award = Math.floor(count / 10);
        count = count % 10;
        return { count, total, last_award: award };
      }); // Atomic counter update [web:77]

      const after = res?.snapshot?.val() || {};
      const give = Number(after.last_award||0);
      if (give > 0){
        await runTransaction(ref(db, `users/${currentUserId}/tickets`), v => Number(v||0) + give); // Award tickets [web:77]
        try{ await runTransaction(ref(db, `users/${currentUserId}/ads_ticket/last_award`), () => 0); }catch{}
        showMessage(`üéüÔ∏è +${give} ticket added`);
      } else {
        showMessage('‚úÖ +1 view counted');
      }
    }

    // Open chest (same as before)
    window.openChest = async function(method){
      if (!currentUserId) return;
      let pool = KEY_TREASURES;
      if (method==='key'){
        const ok = await spendKey(currentUserId);
        if (!ok){ showMessage('‚ùå Not enough keys!', true); return; }
        pool = KEY_TREASURES;
      } else if (method==='ton'){
        const ok = await spendTON(currentUserId, 1);
        if (!ok){ showMessage('‚ùå Minimum 1 TON required!', true); return; }
        pool = TON_TREASURES;
      }
      const chestBox = document.querySelector('.chest-box');
      chestBox.classList.add('opening');

      const t = pool[Math.floor(Math.random() * pool.length)];
      const amt = (t.min!=null && t.max!=null) ? randomReward(t.min, t.max, !!t.ton) : Number(t.amount||0);
      await credit(currentUserId, t.field, amt);

      setTimeout(()=>{
        chestBox.classList.remove('opening');
        const msg = t.type==='TON' ? `üíé Won +${amt} TON` : t.type==='BUMS' ? `üí∞ Won +${amt} BUMS` : t.type==='Ticket' ? `üéüÔ∏è Won +${amt} Ticket` : `üéØ Won +${amt} Spin`;
        showMessage(msg);
      }, 600);
      try{ window.Telegram?.WebApp?.HapticFeedback?.notificationOccurred?.('success'); }catch{}
    }

    // Ticket ad button
    const playTicketAdBtn = document.getElementById('playTicketAdBtn');
    playTicketAdBtn.addEventListener('click', async ()=>{
      playTicketAdBtn.disabled = true;
      playTicketAdBtn.classList.add('loading');
      playTicketAdBtn.textContent = 'Loading...';
      try{
        await showAdSafe('treasure_ticket');   // Monetag call [web:187]
        await recordTicketViewAndMaybeAward(); // Firebase credit [web:73][web:77]
      } finally {
        playTicketAdBtn.classList.remove('loading');
        playTicketAdBtn.textContent = '‚ñ∂ Watch';
        playTicketAdBtn.disabled = false;
      }
    });

    async function boot(){
      const u = getTelegramUser();
      currentUserId = String(u?.id || 'NOT_APP');
      await initializeUser(currentUserId);
    }
    boot();
  </script>
</body>
</html>

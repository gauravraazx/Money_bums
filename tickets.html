<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>Tickets ‚Äî Weekly Draw</title>
  <meta name="viewport" content="width=340, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      background:linear-gradient(135deg,#0b1020 0%,#121729 50%,#0e1f3f 100%);
      color:#fff;font-family:'Inter',Arial,sans-serif;min-height:100vh;overflow-x:hidden;font-size:14px
    }
    .container{width:340px;margin:0 auto;padding:15px 10px 100px 10px}
    .header{background:linear-gradient(135deg,#667eea,#764ba2);border-radius:12px;padding:12px;text-align:center;margin-bottom:12px;border:1px solid rgba(255,255,255,.1);box-shadow:0 8px 32px rgba(102,126,234,.3)}
    .header-title{font-weight:800;letter-spacing:.5px;font-size:.95em}
    .inv-wrap{display:flex;align-items:center;justify-content:space-between;gap:10px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px 12px;margin-bottom:14px}
    .inv-badge{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:6px 10px;display:flex;align-items:center;gap:8px;min-width:90px;justify-content:center}
    .get-btn{background:#fff;color:#111;border:none;padding:8px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    .card{background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:14px;box-shadow:0 6px 24px rgba(0,0,0,.35);margin-bottom:14px}
    .card h3{font-size:1.05em;font-weight:800;margin-bottom:10px}
    .row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.06)}
    .row:last-child{border-bottom:none}
    .k{color:#aab3c9;font-weight:600}
    .v{font-weight:800;letter-spacing:.3px}
    .accent{color:#4ade80}
    .warn{color:#fbbf24}
    .muted{color:#cfd6e6}
    .inline-input{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:8px 10px;margin-top:10px}
    .btn-round{width:32px;height:32px;border-radius:8px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.1);color:#fff;font-weight:900;cursor:pointer}
    .qty{flex:1;text-align:center;font-weight:800;font-size:1em;border:none;outline:none;background:transparent;color:#fff}
    .primary{margin-top:12px;width:100%;background:linear-gradient(135deg,#22c55e,#16a34a);border:none;color:#fff;font-weight:800;padding:10px 12px;border-radius:10px;cursor:pointer;box-shadow:0 6px 16px rgba(34,197,94,.3)}
    .subtle{font-size:.85em;color:#b7c0d8;margin-top:6px;text-align:center}
    .lb-card .row .v{display:flex;gap:10px;align-items:center}
    .chip{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);padding:4px 8px;border-radius:8px;font-weight:700}
    #snackbar{display:none;position:fixed;top:18px;left:50%;transform:translateX(-50%);background:#059669;color:#fff;padding:12px 24px;border-radius:24px;z-index:2001;font-weight:700;box-shadow:0 4px 16px rgba(5,150,105,.4)}
    #snackbar.error{background:#ef4444}
    .bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:340px;background:rgba(0,0,0,.9);backdrop-filter:blur(20px);border-top:1px solid rgba(255,255,255,.1);border-radius:20px 20px 0 0;padding:16px 8px;display:flex;justify-content:space-around;align-items:center;z-index:100}
    .nav-item{display:flex;flex-direction:column;align-items:center;cursor:pointer;padding:6px 4px;border-radius:10px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);min-width:45px;flex:1;margin:0 2px}
    .nav-icon{width:20px;height:20px;margin-bottom:3px;background:#fff;mask-size:contain;mask-repeat:no-repeat;mask-position:center}
    .nav-home .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m3 12 2-2m0 0 7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6'/%3E%3C/svg%3E")}
    .nav-ads .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z'/%3E%3C/svg%3E")}
    .nav-refer .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z'/%3E%3C/svg%3E")}
    .nav-task .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'/%3E%3C/svg%3E")}
    .nav-wallet .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z'/%3E%3C/svg%3E")}
    .nav-label{font-size:.65em;font-weight:600;color:#e0e0e0;text-transform:uppercase;letter-spacing:.3px}
    @media (max-width:360px){.container{width:100%;padding:10px 5px 100px 5px}.bottom-nav{width:100%}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header"><div class="header-title" id="header-username">Loading...</div></div>

    <!-- Inventory + Get -->
    <div class="inv-wrap">
      <div class="inv-badge"><span id="inv-tickets">0</span><span>üéüÔ∏è</span></div>
      <button class="get-btn" id="btn-get">Get</button>
    </div>

    <!-- Weekly draw card -->
    <div class="card">
      <h3>Take part in the weekly drawing ?</h3>
      <div class="row"><span class="k">Winners</span><span class="v" id="winners">2</span></div>
      <div class="row">
        <span class="k">Rewards</span>
        <span class="v"><span id="reward-desc">0.1 TON each (total 0.2 TON)</span></span>
      </div>
      <div class="row"><span class="k">Tickets</span><span class="v" id="total-tickets">0 üéüÔ∏è</span></div>
      <div class="row"><span class="k">My tickets</span><span class="v" id="my-tickets">0 üéüÔ∏è</span></div>
      <div class="row"><span class="k">Chance of winning</span><span class="v accent" id="win-chance">0.00 %</span></div>
      <div class="row"><span class="k">Results</span><span class="v warn" id="results-at">‚Äî</span></div>

      <div class="inline-input">
        <button class="btn-round" id="minus">‚àí</button>
        <input class="qty" id="qty" type="number" min="1" step="1" value="1" />
        <button class="btn-round" id="plus">+</button>
      </div>
      <button class="primary" id="btn-enter">Enter draw</button>
      <div class="subtle">Tickets will be deducted from your inventory and added to this round.</div>
    </div>

    <!-- Daily Top-2 Leaderboard (optional, ‡§∞‡§ñ‡§æ ‡§π‡•Å‡§Ü ‡§π‡•à) -->
    <div class="card lb-card">
      <h3>Today‚Äôs Top contributors</h3>
      <div class="row"><span class="k">#1</span><span class="v"><span id="lb1-name">‚Äî</span><span class="chip" id="lb1-count">0 üéüÔ∏è</span></span></div>
      <div class="row"><span class="k">#2</span><span class="v"><span id="lb2-name">‚Äî</span><span class="chip" id="lb2-count">0 üéüÔ∏è</span></span></div>
      <div class="subtle">Top-1 at 00:00 UTC gets 0.1 TON automatically.</div>
    </div>
  </div>

  <div id="snackbar"></div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <div class="nav-item nav-home" onclick="location.href='index.html'"><div class="nav-icon"></div><span class="nav-label">Home</span></div>
    <div class="nav-item nav-ads" onclick="location.href='ads.html'"><div class="nav-icon"></div><span class="nav-label">Ads</span></div>
    <div class="nav-item nav-refer" onclick="location.href='refer.html'"><div class="nav-icon"></div><span class="nav-label">Refer</span></div>
    <div class="nav-item nav-task" onclick="location.href='tasks.html'"><div class="nav-icon"></div><span class="nav-label">Tasks</span></div>
    <div class="nav-item nav-wallet" onclick="location.href='wallet.html'"><div class="nav-icon"></div><span class="nav-label">Wallet</span></div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js?56"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, get, set, update, runTransaction } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    // Toast
    function toast(msg, err=false){ const el=document.getElementById('snackbar'); el.textContent=msg; el.className=err?'error':''; el.style.display='block'; setTimeout(()=>el.style.display='none', err?4000:3000); }

    // Config
    const firebaseConfig = {
      apiKey: "AIzaSyBv4V4zPlUlbotICs5JVVJVfeZ_wesBCQI",
      authDomain: "momey-bims.firebaseapp.com",
      databaseURL: "https://momey-bims-default-rtdb.firebaseio.com",
      projectId: "momey-bims",
      storageBucket: "momey-bims.firebasestorage.app",
      messagingSenderId: "21496105095",
      appId: "1:21496105095:web:cbd7b39dada8f0b671d022",
      measurementId: "G-ECE8ZBS23B"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // Telegram
    window.Telegram?.WebApp?.ready?.();
    const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
    const uid = tgUser ? String(tgUser.id) : "UNKNOWN_USER";
    const uname = tgUser?.username ? "@"+tgUser.username : (tgUser ? ("ID:"+tgUser.id) : "UNKNOWN_USER");
    document.getElementById('header-username').textContent = uname;

    // Constants per request
    const WINNERS_COUNT = 2;
    const TON_PER_WINNER = 0.1;        // 0.1 TON each
    const TON_TOTAL = 0.2;             // total 0.2 TON

    // Helpers
    const $ = (id)=>document.getElementById(id);
    const invEl=$('inv-tickets'), totalEl=$('total-tickets'), myEl=$('my-tickets'), chanceEl=$('win-chance'), resultsEl=$('results-at');
    const qtyEl=$('qty'), plusEl=$('plus'), minusEl=$('minus'), enterBtn=$('btn-enter'), getBtn=$('btn-get');
    const lb1n=$('lb1-name'), lb2n=$('lb2-name'), lb1c=$('lb1-count'), lb2c=$('lb2-count');

    const todayKeyUTC=(d=new Date())=>{
      const y=d.getUTCFullYear(), m=String(d.getUTCMonth()+1).padStart(2,'0'), da=String(d.getUTCDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    };
    const yesterKeyUTC=()=>{ const d=new Date(); d.setUTCDate(d.getUTCDate()-1); return todayKeyUTC(d); };
    const nextSundayUTC0 = ()=>{
      const d=new Date(); const day=d.getUTCDay(); const add=(7-day)%7;
      return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()+add, 0,0,0));
    };
    const fmtUTC = (dt)=> `${dt.getUTCFullYear()}-${String(dt.getUTCMonth()+1).padStart(2,'0')}-${String(dt.getUTCDate()).padStart(2,'0')} 00:00 UTC`;

    // Paths
    const uRef = ref(db, `users/${uid}`);
    const roundRef = ref(db, `weekly/current`);
    const entriesRef = ref(db, `weekly/current/entries/${uid}`);

    // State
    let myInv=0, myEntered=0, totalTickets=0;

    // UI bindings
    plusEl.onclick = ()=>{ qtyEl.value = String(Math.max(1, Number(qtyEl.value||1)+1)); };
    minusEl.onclick = ()=>{ qtyEl.value = String(Math.max(1, Number(qtyEl.value||1)-1)); };
    getBtn.onclick = ()=>{ window.location.href = 'buy.html'; }; // as requested

    enterBtn.onclick = async ()=>{
      if (uid==="UNKNOWN_USER"){ toast("Open in Telegram to enter.", true); return; }
      const n = Math.floor(Number(qtyEl.value||1));
      if (n<=0){ toast("Enter at least 1 ticket", true); return; }

      try{
        // Deduct inventory
        const invTx = await runTransaction(ref(db, `users/${uid}/ticketsInventory`), (cur)=>{
          const have=Number(cur||0);
          if (have<n) return; // abort
          return have-n;
        });
        if (!invTx.committed){ toast("Not enough tickets", true); return; }

        // Add my entries
        await runTransaction(entriesRef, (cur)=> Number(cur||0) + n);

        // Add total
        const totTx = await runTransaction(ref(db, `weekly/current/ticketsTotal`), (cur)=> Number(cur||0) + n);
        totalTickets = Number(totTx.snapshot.val()||0);

        // Daily counter for leaderboard
        const today=todayKeyUTC();
        await runTransaction(ref(db, `dailyTickets/${today}/users/${uid}`), (cur)=> Number(cur||0) + n);

        // Refresh few fields
        const [invSnap, meSnap] = await Promise.all([get(ref(db, `users/${uid}/ticketsInventory`)), get(entriesRef)]);
        myInv = Number(invSnap.val()||0); invEl.textContent=String(myInv);
        myEntered = Number(meSnap.val()||0); myEl.textContent=`${myEntered} üéüÔ∏è`;
        totalEl.textContent=`${totalTickets} üéüÔ∏è`;
        refreshChance();
        toast(`Entered ${n} tickets`);
        await loadTodayTop2();
      }catch(e){ console.error(e); toast("Failed to enter tickets", true); }
    };

    function refreshChance(){
      const t=Number(totalTickets||0), m=Number(myEntered||0);
      const p = (!t||!m)?0:(m*100.0)/t;
      chanceEl.textContent = `${p.toFixed(2)} %`;
    }

    async function ensureUser(){
      const snap = await get(uRef);
      if (!snap.exists()){
        await set(uRef,{bums:10,ton:0,ticketsInventory:0,totalEarn:0,taskDone:0,profileName:uname});
      }else{
        // keep profileName refreshed (non-destructive)
        const cur = snap.val()||{};
        if (!cur.profileName && uname) await update(uRef,{profileName:uname});
      }
    }

    async function loadAll(){
      await ensureUser();

      // Prepare current round fields (TON-only model)
      let rSnap = await get(roundRef);
      if (!rSnap.exists() || !rSnap.val()?.resultsAt){
        const resAt = nextSundayUTC0().toISOString();
        await update(roundRef,{
          winners: WINNERS_COUNT,
          rewardTonPerWinner: TON_PER_WINNER,
          rewardTonTotal: TON_TOTAL,
          ticketsTotal: Number(rSnap.val()?.ticketsTotal||0)||0,
          resultsAt: resAt
        });
        rSnap = await get(roundRef);
      }

      // Read user + round + my entries
      const [uSnap, eSnap] = await Promise.all([get(uRef), get(entriesRef)]);
      const u = uSnap.val()||{};
      myInv = Number(u.ticketsInventory||0); invEl.textContent=String(myInv);

      const r = rSnap.val()||{};
      totalTickets = Number(r.ticketsTotal||0);
      myEntered = Number(eSnap.exists()? eSnap.val():0);
      $('winners').textContent = String(r.winners||WINNERS_COUNT);
      $('reward-desc').textContent = `${(r.rewardTonPerWinner??TON_PER_WINNER).toFixed(1)} TON each (total ${(r.rewardTonTotal??TON_TOTAL).toFixed(1)} TON)`;
      totalEl.textContent = `${totalTickets} üéüÔ∏è`;
      myEl.textContent = `${myEntered} üéüÔ∏è`;
      resultsEl.textContent = fmtUTC(new Date(r.resultsAt));

      refreshChance();
      await loadTodayTop2();
      await tryAwardYesterdayTop1();
      await settleWeeklyIfDue(); // run after UI load
    }

    // Daily Top-2 (unchanged)
    async function loadTodayTop2(){
      const today = todayKeyUTC();
      const snap = await get(ref(db, `dailyTickets/${today}/users`));
      const map = snap.exists()? snap.val() : {};
      const arr = Object.entries(map).map(([k,v])=>({uid:k,count:Number(v||0)})).sort((a,b)=> b.count-a.count);
      const t1=arr[0]||{uid:'‚Äî',count:0}, t2=arr[1]||{uid:'‚Äî',count:0};
      const n1 = await usernameOf(t1.uid), n2 = await usernameOf(t2.uid);
      lb1n.textContent=n1; lb2n.textContent=n2; lb1c.textContent=`${t1.count} üéüÔ∏è`; lb2c.textContent=`${t2.count} üéüÔ∏è`;
    }
    async function usernameOf(u){
      if (!u||u==='‚Äî') return '‚Äî';
      const s = await get(ref(db, `users/${u}/profileName`));
      if (s.exists()) return s.val();
      return `ID:${u}`;
    }

    // Award daily Top-1 0.1 TON (same as earlier)
    async function tryAwardYesterdayTop1(){
      const ykey = yesterKeyUTC();
      const awardRef = ref(db, `awards/${ykey}`);
      const already = await get(awardRef);
      if (already.exists() && already.val()?.awarded) return;

      const usersSnap = await get(ref(db, `dailyTickets/${ykey}/users`));
      if (!usersSnap.exists()) return;
      const arr = Object.entries(usersSnap.val()).map(([k,v])=>({uid:k,count:Number(v||0)})).sort((a,b)=>b.count-a.count);
      if (!arr.length) return;
      const top = arr[0];

      const lock = await runTransaction(awardRef,(cur)=>{ if (cur && cur.awarded) return cur; return {awarded:true,top1Uid:top.uid,count:top.count,amountTon:0.1,at:Date.now()}; });
      if (!lock.committed) return;

      await runTransaction(ref(db, `users/${top.uid}/ton`),(cur)=>Number(cur||0)+0.1);
      await update(ref(db, `users/${top.uid}/awards/${ykey}`),{ton:0.1,reason:'Daily Top-1 tickets',at:Date.now()});
    }

    // Weekly settlement: pick 2 winners weighted by entries and award 0.1 TON each; then start next round
    async function settleWeeklyIfDue(){
      const rSnap = await get(roundRef);
      if (!rSnap.exists()) return;
      const r = rSnap.val();
      const due = new Date(r.resultsAt||0).getTime();
      if (!due || Date.now() < due) return;

      // Settlement lock
      const lockRef = ref(db, `weekly/current/settlement`);
      const lock = await runTransaction(lockRef,(cur)=>{ if (cur && cur.started) return cur; return {started:true,at:Date.now()}; });
      if (!lock.committed) return; // someone else is settling

      // Read entries
      const entriesSnap = await get(ref(db, `weekly/current/entries`));
      const entries = entriesSnap.exists()? entriesSnap.val():{};
      const participants = Object.entries(entries).map(([k,v])=>({uid:k,count:Number(v||0)})).filter(x=>x.count>0);
      const total = participants.reduce((s,x)=>s+x.count,0);

      let winners = [];
      if (total>0 && participants.length>0){
        // Weighted draw without building big array
        const pickOne = (list, totalCount)=>{
          let r = Math.floor(Math.random()*totalCount);
          for (let i=0;i<list.length;i++){
            const c=list[i].count;
            if (r < c) return i;
            r -= c;
          }
          return list.length-1;
        };
        let list = participants.map(x=>({...x}));
        let t = total;
        const need = Math.min(WINNERS_COUNT, list.length);
        for (let k=0;k<need;k++){
          const idx = pickOne(list, t);
          winners.push(list[idx].uid);
          t -= list[idx].count;
          list.splice(idx,1);
          if (t<=0) break;
        }
      }

      // Award winners
      for (const w of winners){
        await runTransaction(ref(db, `users/${w}/ton`),(cur)=>Number(cur||0)+TON_PER_WINNER);
        await update(ref(db, `users/${w}/weeklyAwards/${todayKeyUTC()}`),{ton:TON_PER_WINNER,at:Date.now()});
      }

      // Save history
      const roundKey = todayKeyUTC(new Date(due)); // the result day key
      await update(ref(db, `weekly/history/${roundKey}`),{
        winners,
        perWinnerTon: TON_PER_WINNER,
        totalTon: TON_TOTAL,
        ticketsTotal: total||0,
        settledAt: Date.now()
      });

      // Reset current round for next week
      const nextAt = nextSundayUTC0().toISOString();
      await set(ref(db, `weekly/current`),{
        winners: WINNERS_COUNT,
        rewardTonPerWinner: TON_PER_WINNER,
        rewardTonTotal: TON_TOTAL,
        ticketsTotal: 0,
        resultsAt: nextAt,
        entries: {}
      });

      // Refresh UI quickly
      totalTickets = 0; myEntered = 0;
      totalEl.textContent = `0 üéüÔ∏è`; myEl.textContent = `0 üéüÔ∏è`; resultsEl.textContent = fmtUTC(new Date(nextAt)); refreshChance();
      toast(`Weekly settled. ${winners.length} winner(s) awarded.`);
    }

    // Init
    if (document.readyState==='loading'){
      document.addEventListener('DOMContentLoaded', loadAll);
    }else{
      loadAll();
    }
  </script>
</body>
</html>
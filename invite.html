<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Invite - BUMS</title>
  <meta name="viewport" content="width=340, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:linear-gradient(135deg,#0b1224 0%,#0f1e3a 50%,#081224 100%);color:#fff;font-family:'Inter',Arial,sans-serif;min-height:100vh;overflow-x:hidden;font-size:13px}
    .container{width:340px;margin:0 auto;padding:12px 8px 100px 8px}

    .panel{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:16px;box-shadow:0 10px 26px rgba(0,0,0,.35);padding:14px;margin-bottom:12px}
    .p-title{font-weight:800;letter-spacing:.3px;color:#dfe7ff;margin-bottom:10px}

    .link-box{display:flex;align-items:center;gap:10px;background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:10px}
    .link{flex:1;background:transparent;border:none;color:#e9eeff;font-weight:600;outline:none}
    .copy-btn{background:#7c3aed;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
    .share-big{width:100%;border:none;border-radius:12px;padding:12px 14px;background:linear-gradient(135deg,#22c55e,#10b981);color:#071b0f;font-weight:800;cursor:pointer;box-shadow:0 8px 22px rgba(34,197,94,.35)}

    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    .stat{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:14px;text-align:center}
    .big{font-size:20px;font-weight:800;color:#9be7a5}
    .muted{color:#cfd6e6;margin-top:6px}

    .claim-wrap{display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:12px;margin-top:10px}
    .claim-btn{border:none;border-radius:10px;padding:8px 12px;font-weight:800;cursor:pointer;background:#334155;color:#cbd5e1}
    .claim-btn.active{background:linear-gradient(135deg,#60a5fa,#3b82f6);color:#071b0f;box-shadow:0 8px 22px rgba(59,130,246,.35)}

    .list{margin-top:8px;border-top:1px dashed rgba(255,255,255,.12)}
    .item{display:flex;align-items:center;justify-content:space-between;padding:12px 2px;border-bottom:1px dashed rgba(255,255,255,.08)}
    .rid{display:flex;align-items:center;gap:10px;color:#e5e7eb;font-weight:600}
    .amt{color:#34d399;font-weight:800}

    .toast{position:fixed;top:10px;left:50%;transform:translateX(-50%) translateY(-20px);background:rgba(34,197,94,.95);color:#071b0f;border:1px solid rgba(34,197,94,.6);padding:10px 14px;border-radius:14px;font-weight:800;letter-spacing:.3px;box-shadow:0 10px 28px rgba(0,0,0,.35);opacity:0;z-index:120;transition:all .25s ease}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    .toast.error{background:rgba(239,68,68,.95);border-color:rgba(239,68,68,.6);color:#160b0b}

    .bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:340px;background:rgba(0,0,0,.9);backdrop-filter:blur(20px);border-top:1px solid rgba(255,255,255,.1);border-radius:20px 20px 0 0;padding:16px 12px;display:flex;justify-content:space-around;align-items:center;z-index:100}
    .nav-item{display:flex;flex-direction:column;align-items:center;cursor:pointer;padding:8px 8px;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);min-width:50px;flex:1;margin:0 2px;transition:transform .2s ease, background .2s ease}
    .nav-item:hover{background:rgba(255,255,255,.1);transform:translateY(-2px)}
    .nav-item.active{background:rgba(102,126,234,.2);border-color:rgba(102,126,234,.3)}
    .nav-icon{width:22px;height:22px;margin-bottom:4px;background:#fff;mask-size:contain;mask-repeat:no-repeat;mask-position:center}
    .nav-home .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m3 12 2-2m0 0 7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6'/%3E%3C/svg%3E")}
    .nav-invite .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7M16 6l-4-4-4 4M12 2v14' stroke='currentColor' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E")}
    .nav-task .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'/%3E%3C/svg%3E")}
    .nav-ads .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z'/%3E%3C/svg%3E")}
    .nav-wallet .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z'/%3E%3C/svg%3E")}
    .nav-label{font-size:.7em;font-weight:500;color:#e0e0e0;text-transform:uppercase;letter-spacing:.3px}

    @media(max-width:360px){
      .container{width:100%;padding:7px 3px 90px 3px}
      .bottom-nav{width:100%}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="panel">
      <div class="p-title">YOUR REFERRAL LINK</div>
      <div class="link-box">
        <input id="refLink" class="link" type="text" readonly value="https://t.me/moneybums_bot?start=" />
        <button class="copy-btn" id="copyBtn">COPY</button>
      </div>
      <button class="share-big" id="shareBtn" style="margin-top:12px">SHARE WITH FRIENDS</button>

      <div class="claim-wrap">
        <div>
          <div style="font-weight:800">REFERRAL EARNINGS</div>
          <div id="pendingAmt" class="muted" style="margin-top:4px">0.00 BUMS</div>
        </div>
        <button id="claimBtn" class="claim-btn" disabled>CLAIM</button>
      </div>

      <div class="grid" style="margin-top:10px">
        <div class="stat">
          <div id="totalRefer" class="big">0</div>
          <div class="muted">TOTAL REFER</div>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="p-title">REFERRAL IDS</div>
      <div id="refList" class="list"></div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <div class="bottom-nav">
    <div class="nav-item nav-home" onclick="window.location.href='index.html'">
      <div class="nav-icon"></div><span class="nav-label">Home</span>
    </div>
    <div class="nav-item nav-invite active" onclick="window.location.href='invite.html'">
      <div class="nav-icon"></div><span class="nav-label">Invite</span>
    </div>
    <div class="nav-item nav-task" onclick="window.location.href='tasks.html'">
      <div class="nav-icon"></div><span class="nav-label">Tasks</span>
    </div>
    <div class="nav-item nav-ads" onclick="window.location.href='ads.html'">
      <div class="nav-icon"></div><span class="nav-label">Ads</span>
    </div>
    <div class="nav-item nav-wallet" onclick="window.location.href='wallet.html'">
      <div class="nav-icon"></div><span class="nav-label">Wallet</span>
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, get, set, update, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyALUr9fR5GE5CxPwY2xdYcIEvy33nu4vbs",
      authDomain: "money-bums-c9eba.firebaseapp.com",
      databaseURL: "https://money-bums-c9eba-default-rtdb.firebaseio.com",
      projectId: "money-bums-c9eba",
      storageBucket: "money-bums-c9eba.firebasestorage.app",
      messagingSenderId: "759031341495",
      appId: "1:759031341495:web:e9d2f9a7ec124e0a524832",
      measurementId: "G-XWHHSQHPP9"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const toastEl = document.getElementById('toast');
    function showToast(msg, ok=true){
      if(!toastEl) return;
      toastEl.textContent = msg;
      toastEl.classList.remove('error');
      if(!ok) toastEl.classList.add('error');
      toastEl.classList.add('show');
      try{ window.Telegram?.WebApp?.HapticFeedback?.notificationOccurred?.(ok?'success':'error'); }catch{}
      setTimeout(()=> toastEl.classList.remove('show'), 1800);
    }

    function getTelegramUser() {
      try { const tg = window.Telegram?.WebApp; tg?.ready?.(); const u = tg?.initDataUnsafe?.user; if (u?.id) return u; } catch {}
      try {
        const parse = (src) => { const sp=new URLSearchParams(src); const raw=sp.get('tgWebAppData')||sp.get('tgwebappdata'); if(!raw) return null; const inner=new URLSearchParams(raw); const s=inner.get('user'); return s?JSON.parse(s):null; };
        const h = location.hash? parse(location.hash.slice(1)) : null; if (h?.id) return h;
        const q = parse(location.search.slice(1)); if (q?.id) return q;
      } catch {}
      return { id: "7206619137" };
    }

    const refLinkEl   = document.getElementById('refLink');
    const copyBtn     = document.getElementById('copyBtn');
    const shareBtn    = document.getElementById('shareBtn');
    const claimBtn    = document.getElementById('claimBtn');
    const pendingAmt  = document.getElementById('pendingAmt');
    const totalRefer  = document.getElementById('totalRefer');
    const refList     = document.getElementById('refList');

    const BOT_LINK = "https://t.me/moneybums_bot";
    const u   = getTelegramUser();
    const UID = String(u?.id || "7206619137");

    const inviteLink = `${BOT_LINK}?start=${UID}`;
    refLinkEl.value  = inviteLink;

    // Ensure nodes for this schema:
    // users/{uid}/balance, users/{uid}/referEarn, users/{uid}/referral (object of {referid: amount})
    async function ensureInviteNodes(uid){
      const uref = ref(db, `users/${uid}`);
      const snap = await get(uref);
      if (!snap.exists()){
        await set(uref, { balance:0, referEarn:0, referral:{} });
      } else {
        const v = snap.val()||{};
        const up = {};
        if (v.balance === undefined) up.balance = 0;
        if (v.referEarn === undefined) up.referEarn = 0;
        if (!v.referral || typeof v.referral !== 'object') up.referral = {};
        if (Object.keys(up).length) await update(uref, up);
      }
    }

    function renderList(referralNode){
      const map = referralNode && typeof referralNode==='object' ? referralNode : {};
      const entries = Object.entries(map);
      totalRefer.textContent = String(entries.length);
      refList.innerHTML = '';
      entries.slice(0,100).forEach(([rid, amt], idx)=>{
        const div = document.createElement('div');
        div.className = 'item';
        const earned = Number(amt||0);
        div.innerHTML = `
          <div class="rid"><span>${idx+1}.</span><span>${rid}</span>
        `;
        refList.appendChild(div);
      });
      if (entries.length===0){
        const empty = document.createElement('div');
        empty.style.padding='12px 2px';
        empty.className='muted';
        empty.textContent='No referrals yet';
        refList.appendChild(empty);
      }
    }

    await ensureInviteNodes(UID);

    // referEarn -> REFERRAL EARNINGS
    onValue(ref(db, `users/${UID}/referEarn`), s=>{
      const p = Number(s.val()||0);
      pendingAmt.textContent = `${p.toFixed(2)} BUMS`;
      if (p>0){ claimBtn.disabled=false; claimBtn.classList.add('active'); } else { claimBtn.disabled=true; claimBtn.classList.remove('active'); }
    });

    // Referral list
    onValue(ref(db, `users/${UID}/referral`), s=>{
      renderList(s.val()||{});
    });

    // Copy / Share / Claim
    copyBtn.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(inviteLink); showToast('Link copied'); }
      catch{ refLinkEl.select(); document.execCommand?.('copy'); showToast('Link copied'); }
    });

    function shareMsg(){
      const text = encodeURIComponent(`ðŸŽ Earn free TON ðŸ˜‰

${inviteLink}

âœ… COMPLETE SIMPLE TASK AND EARN TON 
âœ… INVITE YOUR FRIENDS AND EARN TON`);
      window.location.href = `https://t.me/share/url?url=${encodeURIComponent(BOT_LINK)}&text=${text}`;
    }
    shareBtn.addEventListener('click', shareMsg);

    // Claim: move referEarn -> balance, then zero referEarn
    claimBtn.addEventListener('click', async ()=>{
      const earnRef = ref(db, `users/${UID}/referEarn`);
      let amountToClaim = 0;
      await runTransaction(earnRef, (v)=> {
        const p = Number(v||0);
        amountToClaim = p;
        return 0; // set to zero atomically
      });
      if (amountToClaim>0){
        await runTransaction(ref(db, `users/${UID}/balance`), v=> Number(v||0) + amountToClaim);
        showToast(`Claimed ${amountToClaim.toFixed(2)} BUMS`);
      } else {
        showToast('Nothing to claim', false);
      }
    });
  </script>
</body>
</html>
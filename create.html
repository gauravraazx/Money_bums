<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <title>Create Center - BUMS</title>
  <meta name="viewport" content="width=340, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      color: #ffffff;
      font-family: 'Inter', Arial, sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
      font-size: 13px;
    }
    .container { width: 340px; margin: 0 auto; padding: 12px 8px 120px 8px; }
    .tab-nav { display: flex; margin-bottom: 16px; background: rgba(255,255,255,0.05); border-radius: 12px; padding: 4px; border: 1px solid rgba(255,255,255,0.1); }
    .tab-btn {
      flex: 1; background: transparent; border: none; color: #ffffff; padding: 12px 8px; font-weight: 600; cursor: pointer; border-radius: 8px; transition: all 0.3s; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .tab-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 4px 12px rgba(102,126,234,0.3); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .form-section { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border-radius: 14px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 8px 32px rgba(0,0,0,0.3); margin-bottom: 16px; }
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 0.95em; font-weight: 600; color: #f0f0f0; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    .form-input { width: 100%; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; padding: 12px 16px; font-size: 0.95em; color: #ffffff; outline: none; transition: all 0.3s; }
    .form-input:focus { border-color: #667eea; background: rgba(255,255,255,0.15); box-shadow: 0 0 0 2px rgba(102,126,234,0.2); }
    .form-input::placeholder { color: #9ca3af; }
    .form-input.error { border-color: #ef4444; background: rgba(239,68,68,0.1); }

    .balance-display { background: rgba(255,255,255,0.05); border-radius: 8px; padding: 10px 12px; margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.1); font-size: 0.9em; color: #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
    .balance-content { flex: 1; }
    .balance-title { font-weight: 600; margin-bottom: 4px; color: #4ade80; text-transform: uppercase; letter-spacing: 0.5px; }
    .balance-amount { font-weight: 700; color: #ffffff; }
    .deposit-btn { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 0.85em; font-weight: 600; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.3s; box-shadow: 0 2px 8px rgba(245,158,11,0.3); min-width: 70px; }
    .deposit-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(245,158,11,0.4); }
    .error-message { color: #ef4444; font-size: 0.85em; margin-top: 6px; font-weight: 500; }
    .create-btn { width: 100%; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; border-radius: 12px; padding: 14px; color: white; font-size: 1em; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; transition: all 0.3s; box-shadow: 0 4px 16px rgba(16,185,129,0.3); }
    .create-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(16,185,129,0.4); }
    .create-btn:disabled { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); cursor: not-allowed; transform: none; box-shadow: none; }

    .amount-selector { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
    .amount-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 8px 12px; color: #ffffff; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 0.85em; min-width: 60px; text-align: center; }
    .amount-btn:hover { background: rgba(255,255,255,0.15); }
    .amount-btn.active { background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-color: #10b981; }

    .history-section { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border-radius: 14px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 8px 32px rgba(0,0,0,0.3); margin-bottom: 16px; }
    .history-title { font-size: 1em; font-weight: 600; color: #f0f0f0; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.5px; }

    .gift-code-item { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 16px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.05); transition: all 0.3s; }
    .gift-code-item:hover { background: rgba(255,255,255,0.08); }
    .gift-code-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .gift-code-value { flex: 1; font-family: 'Courier New', monospace; font-size: 1.1em; font-weight: 700; letter-spacing: 1px; padding: 8px 12px; background: rgba(255,255,255,0.1); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); }
    .gift-code-value.active { color: #10b981; border-color: #10b981; background: rgba(16,185,129,0.1); }
    .gift-code-value.inactive { color: #ef4444; border-color: #ef4444; background: rgba(239,68,68,0.1); }
    .code-actions { display: flex; gap: 8px; }
    .code-action-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 6px 12px; color: #ffffff; font-size: 0.8em; font-weight: 600; cursor: pointer; transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px; }
    .code-action-btn:hover { background: rgba(255,255,255,0.2); transform: translateY(-1px); }
    .copy-code-btn { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border-color: #8b5cf6; }
    .copy-code-btn:hover { box-shadow: 0 4px 12px rgba(139,92,246,0.4); }
    .share-code-btn { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); border-color: #3b82f6; }
    .share-code-btn:hover { box-shadow: 0 4px 12px rgba(59,130,246,0.4); }

    .gift-code-stats { display: flex; justify-content: space-between; gap: 16px; }
    .stat-item { flex: 1; text-align: center; }
    .stat-label { font-size: 0.75em; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
    .stat-value { font-size: 0.95em; font-weight: 700; color: #ffffff; }

    .no-history { text-align: center; color: #9ca3af; font-weight: 500; padding: 40px 20px; font-size: 0.95em; letter-spacing: 0.5px; }
    .loading-history { text-align: center; color: #667eea; font-weight: 500; padding: 40px 20px; font-size: 0.95em; letter-spacing: 0.5px; }

    .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); animation: fadeIn 0.3s ease-in-out; }
    .modal.show { display: flex; justify-content: center; align-items: center; }
    .modal-content { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); border-radius: 20px; padding: 30px; max-width: 320px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); border: 1px solid rgba(255, 255, 255, 0.1); position: relative; animation: slideUp 0.4s ease-out; }
    .modal-header { margin-bottom: 20px; }
    .modal-icon { font-size: 3em; margin-bottom: 10px; color: #4ade80; }
    .modal-title { font-size: 1.3em; font-weight: 700; color: #ffffff; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
    .modal-message { font-size: 0.95em; color: #f0f0f0; margin-bottom: 25px; line-height: 1.4; }
    .promo-code-display { background: rgba(255, 255, 255, 0.1); border: 2px solid #4ade80; border-radius: 12px; padding: 15px; margin: 20px 0; position: relative; }
    .promo-code-label { font-size: 0.8em; color: #4ade80; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .promo-code-value { font-size: 1.4em; font-weight: 700; color: #ffffff; letter-spacing: 2px; font-family: 'Courier New', monospace; word-break: break-all; }
    .modal-actions { margin-top: 20px; }
    .copy-btn { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.3s; font-size: 0.9em; margin: 10px 5px; }
    .copy-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4); }
    .close-btn { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 12px 25px; border-radius: 8px; font-weight: 600; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.3s; font-size: 1em; margin-top: 15px; }
    .close-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(16,185,129,0.4); }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    #snackbar { 
      display: none; 
      position: fixed; 
      top: 18px; 
      left: 50%; 
      transform: translateX(-50%); 
      background: #059669; 
      color: white; 
      padding: 12px 24px; 
      border-radius: 24px; 
      z-index: 2001; 
      font-weight: 600; 
      font-size: 1em; 
      box-shadow: 0 4px 16px rgba(5,150,105,0.4); 
      transition: opacity 0.4s; 
      opacity: 1; 
      letter-spacing: 0.5px; 
    }
    #snackbar.error { background: #ef4444; box-shadow: 0 4px 16px rgba(239,68,68,0.4); }

    .bottom-nav { 
      position: fixed; 
      bottom: 0; 
      left: 50%; 
      transform: translateX(-50%); 
      width: 340px; 
      background: rgba(0,0,0,0.9); 
      backdrop-filter: blur(20px); 
      border-top: 1px solid rgba(255,255,255,0.1); 
      border-radius: 20px 20px 0 0; 
      padding: 16px 8px; 
      display: flex; 
      justify-content: space-around; 
      align-items: center; 
      z-index: 100; 
    }
    .nav-item { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      cursor: pointer; 
      padding: 6px 4px; 
      border-radius: 10px; 
      background: rgba(255,255,255,0.05); 
      border: 1px solid rgba(255,255,255,0.1); 
      min-width: 45px; 
      flex: 1; 
      margin: 0 2px; 
      transition: all 0.2s; 
    }
    .nav-item:hover { background: rgba(255,255,255,0.1); transform: translateY(-2px); }
    .nav-icon { 
      width: 20px; 
      height: 20px; 
      margin-bottom: 3px; 
      background: #fff; 
      mask-size: contain; 
      mask-repeat: no-repeat; 
      mask-position: center; 
    }
    .nav-home .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m3 12 2-2m0 0 7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6'/%3E%3C/svg%3E"); }
    .nav-win .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='currentColor' d='M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z'/%3E%3C/svg%3E"); }
    .nav-ads .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z'/%3E%3C/svg%3E"); }
    .nav-refer .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z'/%3E%3C/svg%3E"); }
    .nav-task .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'/%3E%3C/svg%3E"); }
    .nav-wallet .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 00-3 3z'/%3E%3C/svg%3E"); }
    .nav-label { font-size: 0.65em; font-weight: 500; color: #e0e0e0; text-transform: uppercase; letter-spacing: 0.3px; }

    .note-box {
      margin-top: 12px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 10px;
      padding: 12px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }
    .note-text {
      flex: 1;
      font-size: 0.85em;
      color: #e5e7eb;
      line-height: 1.4;
    }
    .note-action-btn {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      border: none;
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 0.8em;
      cursor: pointer;
      white-space: nowrap;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 8px rgba(59,130,246,0.35);
    }
    .note-action-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(59,130,246,0.45); }

    @media (max-width: 360px) { 
      .container { width: 100%; padding: 7px 3px 120px 3px; } 
      .bottom-nav { width: 100%; } 
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- Tab Navigation -->
    <div class="tab-nav">
      <button class="tab-btn active" onclick="switchTab('task')" id="task-tab-btn">Create Task</button>
      <button class="tab-btn" onclick="switchTab('gift')" id="gift-tab-btn">Create Gift</button>
    </div>

    <!-- CREATE TASK Tab -->
    <div id="task-tab" class="tab-content active">
      <div class="form-section">
        <div class="form-group">
          <label class="form-label">Enter Task Link</label>
          <input type="url" class="form-input" id="task-link" placeholder="@channelusername or https://t.me/channelusername">
          <div class="error-message" id="task-link-error" style="display:none;"></div>
        </div>
        <div class="form-group">
          <label class="form-label">Currency: TON</label>
          <div class="balance-display">
            <div class="balance-content">
              <div class="balance-title">TON Balance</div>
              <div class="balance-amount" id="task-balance-display">... TON</div>
            </div>
            <button class="deposit-btn" onclick="window.location.href='wallet.html'">DEPOSIT +200%</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label" id="task-amount-label">Enter Amount (TON)</label>
          <input type="number" class="form-input" id="task-amount-input" placeholder="0.1" min="0.1" step="0.01">
          <div class="error-message" id="task-amount-error" style="display: none;"></div>
        </div>
        <button class="create-btn" id="create-task-btn" onclick="createTask()">CREATE TASK</button>

        <div class="note-box">
          <div class="note-text">
            Note: If you don't assign admin status to the bot on your channel, you may have trouble gaining members. Click "ADD ADMIN" to allow direct admission.
          </div>
          <button class="note-action-btn" onclick="openAddAdmin()">ADD ADMIN</button>
        </div>
      </div>

      <!-- My Tasks Section -->
      <div class="history-section">
        <div class="history-title">My Tasks</div>
        <div id="user-tasks-container">
          <div class="loading-history">Loading your tasks...</div>
        </div>
      </div>
    </div>

    <!-- CREATE GIFT Tab -->
    <div id="gift-tab" class="tab-content">
      <div class="form-section">
        <div class="form-group">
          <label class="form-label">Currency: TON</label>
          <div class="balance-display">
            <div class="balance-content">
              <div class="balance-title">TON Balance</div>
              <div class="balance-amount" id="gift-balance-display">... TON</div>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Total Active (Claim Limit)</label>
          <div class="amount-selector">
            <button class="amount-btn active" onclick="setClaimLimit(10, event)">10</button>
            <button class="amount-btn" onclick="setClaimLimit(25, event)">25</button>
            <button class="amount-btn" onclick="setClaimLimit(50, event)">50</button>
            <button class="amount-btn" onclick="setClaimLimit(100, event)">100</button>
          </div>
          <input type="number" class="form-input" id="claim-limit-input" placeholder="Enter custom limit" min="1" step="1" value="10">
        </div>

        <div class="form-group">
          <label class="form-label" id="gift-amount-label">Total Amount (TON)</label>
          <input type="number" class="form-input" id="gift-amount-input" placeholder="0.1" min="0.1" step="0.01">
          <div class="error-message" id="gift-amount-error" style="display: none;"></div>
          <div style="margin-top:8px;color:#9ca3af;font-size:12px;">Note: Minimum total ‚Äî TON: 0.1. Per-user min ‚Äî TON: 0.01.</div>
        </div>

        <button class="create-btn" id="create-gift-btn" onclick="createGift()">CREATE GIFT</button>
      </div>

      <div class="history-section">
        <div class="history-title">Gift Code History</div>
        <div id="gift-history-container">
          <div class="loading-history">Loading gift history...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Promo Code Modal -->
  <div id="promo-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-icon">üéÅ</div>
        <div class="modal-title">Gift Created Successfully!</div>
        <div class="modal-message">Your promo code has been generated. Share it with others to claim the gift!</div>
      </div>

      <div class="promo-code-display">
        <div class="promo-code-label">Promo Code</div>
        <div class="promo-code-value" id="generated-promo-code">LOADING...</div>
      </div>

      <div class="modal-actions">
        <button class="copy-btn" onclick="copyPromoCode()">COPY CODE</button>
        <button class="copy-btn" onclick="sharePromoCode()">SHARE</button>
        <br>
        <button class="close-btn" onclick="closePromoModal()">CLOSE</button>
      </div>
    </div>
  </div>

  <div id="snackbar"></div>

  <div class="bottom-nav">
    <div class="nav-item nav-home" onclick="window.location.href='index.html'">
      <div class="nav-icon"></div><span class="nav-label">Home</span>
    </div>
    <div class="nav-item nav-win" onclick="window.location.href='win.html'">
      <div class="nav-icon"></div><span class="nav-label">Win</span>
    </div>
    <div class="nav-item nav-ads" onclick="window.location.href='ads.html'">
      <div class="nav-icon"></div><span class="nav-label">Ads</span>
    </div>
    <div class="nav-item nav-refer" onclick="window.location.href='refer.html'">
      <div class="nav-icon"></div><span class="nav-label">Refer</span>
    </div>
    <div class="nav-item nav-task" onclick="window.location.href='tasks.html'">
      <div class="nav-icon"></div><span class="nav-label">Tasks</span>
    </div>
    <div class="nav-item nav-wallet" onclick="window.location.href='wallet.html'">
      <div class="nav-icon"></div><span class="nav-label">Wallet</span>
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, get, set, update, push } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const BOT_USERNAME = 'moneybums_bot';

    function showSnackbar(msg, isError = false) {
      const bar = document.getElementById('snackbar');
      if (!bar) return;
      bar.textContent = msg;
      bar.className = isError ? 'error' : '';
      bar.style.display = 'block';
      bar.style.opacity = 1;
      setTimeout(() => {
        bar.style.opacity = 0;
        setTimeout(() => { bar.style.display = 'none'; }, 400);
      }, 3000);
    }

    function normalizeAndClassifyLink(raw) {
      const input = (raw || '').trim();
      if (!input) return { ok: false, error: 'Please enter a link.' };

      let urlStr = input;
      if (/^(t\.me|wa\.me)\//i.test(input)) urlStr = 'https://' + input;
      let u;
      try { u = new URL(urlStr); } catch {
        if (input.startsWith('@')) {
          const handle = input.slice(1);
          if (!/^[A-Za-z0-9_]{3,110}$/.test(handle)) {
            return { ok: false, error: 'Invalid @username. Use 3‚Äì110 letters, numbers, or underscores.' };
          }
          return {
            ok: true,
            platform: 'telegram',
            url: `https://t.me/${handle}`,
            titleBase: handle.toUpperCase(),
            username: handle
          };
        }
        return { ok: false, error: 'Invalid link format.' };
      }

      const host = u.hostname.toLowerCase().replace(/^www\./, '');
      const path = u.pathname.replace(/^\/+|\/+$/g, '');
      const segs = path ? path.split('/') : [];

      if (host === 't.me') {
        const first = segs[0] || '';
        const titleBase = first ? first.toUpperCase() : 'TELEGRAM';
        return {
          ok: true,
          platform: 'telegram',
          url: `https://t.me${u.pathname}${u.search}${u.hash}`,
          titleBase,
          username: first || null
        };
      }

      if (host === 'wa.me' || host === 'api.whatsapp.com') {
        let number = '';
        if (host === 'wa.me' && segs[0]) number = segs[0];
        if (host === 'api.whatsapp.com') {
          const phone = new URLSearchParams(u.search).get('phone') || '';
          number = phone;
        }
        const titleBase = number ? `WA_${number}`.toUpperCase() : 'WHATSAPP';
        return {
          ok: true,
          platform: 'whatsapp',
          url: `https://${host}${u.pathname}${u.search}${u.hash}`,
          titleBase
        };
      }

      if (host === 'ig.me' || host === 'instagram.com') {
        let titleBase = 'INSTAGRAM';
        if (host === 'ig.me' && segs[0]?.toLowerCase() === 'm' && segs[1]) {
          titleBase = segs[1].toUpperCase();
        } else if (host === 'instagram.com' && segs[0]) {
          titleBase = segs[0].toUpperCase();
        }
        return {
          ok: true,
          platform: 'instagram',
          url: `https://${host}${u.pathname}${u.search}${u.hash}`,
          titleBase
        };
      }

      return {
        ok: true,
        platform: 'other',
        url: u.href,
        titleBase: host.split('.')[0].toUpperCase()
      };
    }

    function generateRandomPromoCode(length = 10) {
      const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let result = '';
      for (let i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * characters.length));
      }
      return result;
    }

    const firebaseConfig = {
      apiKey: "AIzaSyBv4V4zPlUlbotICs5JVVJVfeZ_wesBCQI",
      authDomain: "momey-bims.firebaseapp.com",
      databaseURL: "https://momey-bims-default-rtdb.firebaseio.com",
      projectId: "momey-bims",
      storageBucket: "momey-bims.firebasestorage.app",
      messagingSenderId: "21496105095",
      appId: "1:21496105095:web:cbd7b39dada8f0b671d022",
      measurementId: "G-ECE8ZBS23B"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    window.Telegram?.WebApp?.ready?.();

    const user = window.Telegram?.WebApp?.initDataUnsafe?.user;
    let userKey = user ? String(user.id) : "UNKNOWN_USER";

    let claimLimit = 10;
    let userBalance = { bums: 0, ton: 0 };
    let currentPromoCode = '';

    const MIN_MULTIPLIER = 10;
    const COIN_MIN_VALUES = { 'TON': 0.001 };

    window.switchTab = function(tabName) {
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabName + '-tab')?.classList.add('active');
      document.getElementById(tabName + '-tab-btn')?.classList.add('active');
      if (tabName === 'gift') loadGiftHistory();
    };

    async function loadUserBalance() {
      try {
        const userRef = ref(db, 'users/' + userKey);
        const snapshot = await get(userRef);
        if (snapshot.exists()) {
          const data = snapshot.val();
          userBalance.bums = Number(data.bums) || 0;
          userBalance.ton = Number(data.ton) || 0;
        } else {
          userBalance = { bums: 10, ton: 0 };
          await set(userRef, userBalance);
        }
        updateBalanceDisplays();
      } catch (error) {
        console.error('Error loading balance:', error);
        document.getElementById('task-balance-display').textContent = 'Error loading balance';
        document.getElementById('gift-balance-display').textContent = 'Error loading balance';
      }
    }

    function updateBalanceDisplays() {
      const taskBal = document.getElementById('task-balance-display');
      const giftBal = document.getElementById('gift-balance-display');
      if (taskBal) taskBal.textContent = `${userBalance.ton.toFixed(4)} TON`;
      if (giftBal) giftBal.textContent = `${userBalance.ton.toFixed(4)} TON`;
    }

    window.setClaimLimit = function(limit, event) {
      claimLimit = limit;
      document.querySelectorAll('.amount-btn').forEach(btn => btn.classList.remove('active'));
      if (event?.currentTarget) event.currentTarget.classList.add('active');
      const el = document.getElementById('claim-limit-input');
      if (el) el.value = limit;
      validateGiftAmount();
    };

    function validateTaskAmount() {
      const input = document.getElementById('task-amount-input');
      const errorDiv = document.getElementById('task-amount-error');
      if (!input || !errorDiv) return true;
      const value = parseFloat(input.value);
      let isValid = true;
      let errorMessage = '';
      if (input.value === '') {
        isValid = true;
      } else {
        if (value < 0.1) { isValid = false; errorMessage = 'Minimum 0.1 TON required'; }
        else if (value > userBalance.ton) { isValid = false; errorMessage = 'Insufficient TON balance'; }
      }
      input.classList.toggle('error', !isValid && input.value !== '');
      errorDiv.style.display = (!isValid && input.value !== '') ? 'block' : 'none';
      if (!isValid && input.value !== '') errorDiv.textContent = errorMessage;
      return isValid || input.value === '';
    }

    function validateGiftAmount() {
      const input = document.getElementById('gift-amount-input');
      const errorDiv = document.getElementById('gift-amount-error');
      const limitEl = document.getElementById('claim-limit-input');
      if (!input || !errorDiv || !limitEl) return true;

      const value = parseFloat(input.value);
      const totalActive = parseInt(limitEl.value) || claimLimit;

      let isValid = true;
      let errorMessage = '';

      if (input.value === '') {
        isValid = true;
      } else {
        let minRequiredAmount = totalActive * MIN_MULTIPLIER * COIN_MIN_VALUES.TON;
        if (value < minRequiredAmount) { 
          isValid = false; 
          errorMessage = `Minimum ${minRequiredAmount.toFixed(3)} TON required (${totalActive} users √ó 10x)`; 
        }
        else if (value > userBalance.ton) { 
          isValid = false; 
          errorMessage = 'Insufficient TON balance'; 
        }
      }

      input.classList.toggle('error', !isValid && input.value !== '');
      errorDiv.style.display = (!isValid && input.value !== '') ? 'block' : 'none';
      if (!isValid && input.value !== '') errorDiv.textContent = errorMessage;
      return isValid || input.value === '';
    }

    window.createTask = async function() {
      const linkInput = document.getElementById('task-link');
      const linkErr = document.getElementById('task-link-error');
      const amountEl = document.getElementById('task-amount-input');
      const amount = parseFloat(amountEl?.value || '0');

      const res = normalizeAndClassifyLink(linkInput?.value);
      if (!res.ok) {
        linkInput?.classList.add('error');
        if (linkErr) { linkErr.textContent = res.error; linkErr.style.display = 'block'; }
        showSnackbar(res.error, true);
        return;
      } else {
        linkInput?.classList.remove('error');
        if (linkErr) linkErr.style.display = 'none';
      }

      if (!amount || !validateTaskAmount()) { showSnackbar('Please enter a valid amount', true); return; }
      if (amount > userBalance.ton) { showSnackbar('Insufficient TON balance', true); return; }

      try {
        const createBtn = document.getElementById('create-task-btn');
        if (createBtn) { createBtn.disabled = true; createBtn.textContent = 'CREATING...'; }

        const taskData = {
          title: res.titleBase,
          link: res.url,
          reward: 10,
          totalReward: amount,
          currency: 'TON',
          maxCompletions: Math.floor(amount * 400),
          currentCompletions: 0,
          completedBy: [],
          createdBy: userKey,
          createdAt: new Date().toISOString(),
          status: 'active'
        };

        await push(ref(db, 'tasks'), taskData);

        userBalance.ton -= amount;
        await update(ref(db, 'users/' + userKey), {
          bums: userBalance.bums,
          ton: userBalance.ton
        });
        updateBalanceDisplays();

        showSnackbar(`Task created successfully! üéâ (Max ${taskData.maxCompletions} users)`);
        if (linkInput) linkInput.value = '';
        if (amountEl) amountEl.value = '';
        loadUserTasks(); // Refresh tasks list
        setTimeout(() => { window.location.href = 'tasks.html'; }, 1500);
      } catch (error) {
        console.error('Error creating task:', error);
        showSnackbar('Error creating task. Please try again.', true);
      } finally {
        const createBtn = document.getElementById('create-task-btn');
        if (createBtn) { createBtn.disabled = false; createBtn.textContent = 'CREATE TASK'; }
      }
    };

    window.openAddAdmin = function() {
      const perms = 'post_messages+invite_users';
      const link = `https://t.me/${BOT_USERNAME}?startchannel&admin=${perms}`;
      if (window.Telegram?.WebApp?.openTelegramLink) {
        window.Telegram.WebApp.openTelegramLink(link);
      } else {
        window.open(link, '_blank');
      }
    };

    window.createGift = async function() {
      const totalAmount = parseFloat(document.getElementById('gift-amount-input')?.value || '0');
      const totalActive = parseInt(document.getElementById('claim-limit-input')?.value || String(claimLimit), 10) || claimLimit;

      if (!totalAmount || !validateGiftAmount()) { showSnackbar('Please enter a valid total amount', true); return; }
      if (totalActive < 1) { showSnackbar('Total active must be at least 1', true); return; }

      let minRequiredAmount = totalActive * MIN_MULTIPLIER * COIN_MIN_VALUES.TON;
      if (totalAmount < minRequiredAmount) { 
        showSnackbar(`Total amount must be at least ${minRequiredAmount.toFixed(3)} TON (${totalActive} users √ó 10x)`, true); 
        return; 
      }
      if (totalAmount > userBalance.ton) { showSnackbar('Insufficient TON balance', true); return; }

      const amountPerClaim = totalAmount / totalActive;

      try {
        const createBtn = document.getElementById('create-gift-btn');
        if (createBtn) { createBtn.disabled = true; createBtn.textContent = 'CREATING...'; }

        currentPromoCode = generateRandomPromoCode(10);
        let isUnique = false;
        while (!isUnique) {
          const promoRef = ref(db, 'promoCodes/' + currentPromoCode);
          const snap = await get(promoRef);
          if (!snap.exists()) isUnique = true;
          else currentPromoCode = generateRandomPromoCode(10);
        }

        const giftData = {
          type: 'gift',
          code: currentPromoCode,
          rewardCurrency: 'TON',
          rewardAmount: parseFloat(amountPerClaim.toFixed(6)),
          totalAmount: parseFloat(totalAmount.toFixed(6)),
          maxUses: totalActive,
          usedCount: 0,
          active: true,
          createdBy: userKey,
          createdAt: new Date().toISOString()
        };

        await set(ref(db, 'promoCodes/' + currentPromoCode), giftData);

        userBalance.ton -= giftData.totalAmount;

        await update(ref(db, 'users/' + userKey), {
          bums: userBalance.bums,
          ton: userBalance.ton
        });
        updateBalanceDisplays();

        const codeEl = document.getElementById('generated-promo-code');
        if (codeEl) codeEl.textContent = currentPromoCode;
        const modal = document.getElementById('promo-modal');
        if (modal) modal.classList.add('show');

        showSnackbar('Gift created successfully! üéÅ');
        const amtEl = document.getElementById('gift-amount-input');
        if (amtEl) amtEl.value = '';
        loadGiftHistory();
      } catch (err) {
        console.error('Error creating gift:', err);
        showSnackbar('Error creating gift. Please try again.', true);
      } finally {
        const createBtn = document.getElementById('create-gift-btn');
        if (createBtn) { createBtn.disabled = false; createBtn.textContent = 'CREATE GIFT'; }
      }
    };

    async function loadGiftHistory() {
      const container = document.getElementById('gift-history-container');
      if (!container) return;
      container.innerHTML = '<div class="loading-history">Loading gift history...</div>';
      try {
        const promoCodesRef = ref(db, 'promoCodes');
        const snapshot = await get(promoCodesRef);
        if (!snapshot.exists()) {
          container.innerHTML = '<div class="no-history">No gift codes created yet</div>';
          return;
        }
        const allPromoCodes = snapshot.val();
        const userGiftCodes = [];
        Object.entries(allPromoCodes).forEach(([codeId, codeData]) => {
          if (codeData.createdBy === userKey && codeData.type === 'gift') userGiftCodes.push([codeId, codeData]);
        });
        if (userGiftCodes.length === 0) {
          container.innerHTML = '<div class="no-history">No gift codes created yet</div>';
          return;
        }
        container.innerHTML = '';
        userGiftCodes.sort((a, b) => new Date(b[1].createdAt) - new Date(a[1].createdAt));
        userGiftCodes.forEach(([codeId, codeData]) => {
          const isActive = codeData.active && (codeData.usedCount < codeData.maxUses);
          const availableClaims = codeData.maxUses - (codeData.usedCount || 0);
          const historyItem = document.createElement('div');
          historyItem.className = 'gift-code-item';
          historyItem.innerHTML = `
            <div class="gift-code-header">
              <div class="gift-code-value ${isActive ? 'active' : 'inactive'}">${codeData.code}</div>
              <div class="code-actions">
                <button class="code-action-btn copy-code-btn" onclick="copyGiftCode('${codeData.code}')">COPY</button>
                <button class="code-action-btn share-code-btn" onclick="shareGiftCode('${codeData.code}')">SHARE</button>
              </div>
            </div>
            <div class="gift-code-stats">
              <div class="stat-item">
                <div class="stat-label">Maximum Active</div>
                <div class="stat-value">${codeData.maxUses}</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">Available Claims</div>
                <div class="stat-value">${availableClaims}</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">Reward</div>
                <div class="stat-value">${codeData.rewardAmount} ${codeData.rewardCurrency}</div>
              </div>
            </div>
          `;
          container.appendChild(historyItem);
        });
      } catch (error) {
        console.error('Error loading gift history:', error);
        container.innerHTML = '<div class="no-history">Error loading gift history</div>';
      }
    }

    // >>> NEW: Load User Tasks <<<
    async function loadUserTasks() {
      const container = document.getElementById('user-tasks-container');
      if (!container) return;
      container.innerHTML = '<div class="loading-history">Loading your tasks...</div>';
      try {
        const tasksRef = ref(db, 'tasks');
        const snapshot = await get(tasksRef);
        if (!snapshot.exists()) {
          container.innerHTML = '<div class="no-history">No tasks created yet</div>';
          return;
        }
        const allTasks = snapshot.val();
        const userTasks = [];
        Object.entries(allTasks).forEach(([taskId, taskData]) => {
          if (taskData.createdBy === userKey) {
            userTasks.push([taskId, taskData]);
          }
        });
        if (userTasks.length === 0) {
          container.innerHTML = '<div class="no-history">No tasks created yet</div>';
          return;
        }
        container.innerHTML = '';
        userTasks.sort((a, b) => new Date(b[1].createdAt) - new Date(a[1].createdAt));
        userTasks.forEach(([taskId, taskData]) => {
          const isCompleted = taskData.currentCompletions >= taskData.maxCompletions;
          const statusText = isCompleted ? 'Completed' : 'Active';
          const statusClass = isCompleted ? 'inactive' : 'active';

          const taskItem = document.createElement('div');
          taskItem.className = 'gift-code-item';
          taskItem.innerHTML = `
            <div class="gift-code-header">
              <div>
                <div class="gift-code-value ${statusClass}" style="font-size:1em;">${taskData.title}</div>
                <div style="font-size:0.8em;color:#9ca3af;margin-top:4px;">${taskData.link}</div>
              </div>
            </div>
            <div class="gift-code-stats">
              <div class="stat-item">
                <div class="stat-label">Status</div>
                <div class="stat-value" style="color:${isCompleted ? '#ef4444' : '#10b981'};">${statusText}</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">Completed</div>
                <div class="stat-value">${taskData.currentCompletions} / ${taskData.maxCompletions}</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">Reward</div>
                <div class="stat-value">${taskData.totalReward} TON</div>
              </div>
            </div>
          `;
          container.appendChild(taskItem);
        });
      } catch (error) {
        console.error('Error loading user tasks:', error);
        container.innerHTML = '<div class="no-history">Error loading tasks</div>';
      }
    }

    window.copyPromoCode = async function() {
      try {
        const code = document.getElementById('generated-promo-code')?.textContent || currentPromoCode;
        await navigator.clipboard.writeText(code);
        showSnackbar('Code copied!');
      } catch {
        showSnackbar('Copy failed', true);
      }
    };

    window.sharePromoCode = function() {
      const code = document.getElementById('generated-promo-code')?.textContent || currentPromoCode;
      const text = `Claim this gift code: ${code}`;
      if (navigator.share) {
        navigator.share({ text }).catch(() => {});
      } else {
        showSnackbar('Sharing not supported here');
      }
    };

    window.copyGiftCode = async function(code) {
      try {
        await navigator.clipboard.writeText(code);
        showSnackbar('Code copied!');
      } catch {
        showSnackbar('Copy failed', true);
      }
    };

    window.shareGiftCode = function(code) {
      const text = `Claim this gift code: ${code}`;
      if (navigator.share) {
        navigator.share({ text }).catch(() => {});
      } else {
        showSnackbar('Sharing not supported here');
      }
    };

    window.closePromoModal = function() {
      const modal = document.getElementById('promo-modal');
      if (modal) modal.classList.remove('show');
    };

    window.addEventListener('load', function() {
      const hash = window.location.hash;
      if (hash === '#gift') {
        window.switchTab('gift');
      }
      updateBalanceDisplays();
    });

    document.addEventListener('DOMContentLoaded', () => {
      loadUserBalance();
      loadUserTasks(); // <<< Load user tasks on start

      const taskAmountEl = document.getElementById('task-amount-input');
      const giftAmountEl = document.getElementById('gift-amount-input');
      const claimLimitEl = document.getElementById('claim-limit-input');
      const taskLinkEl = document.getElementById('task-link');
      const taskLinkErr = document.getElementById('task-link-error');

      if (taskAmountEl) taskAmountEl.addEventListener('input', () => validateTaskAmount());
      if (giftAmountEl) giftAmountEl.addEventListener('input', () => validateGiftAmount());

      if (claimLimitEl) {
        claimLimitEl.addEventListener('input', () => {
          claimLimit = parseInt(claimLimitEl.value) || 10;
          document.querySelectorAll('.amount-btn').forEach(btn => btn.classList.remove('active'));
          validateGiftAmount();
        });
        claimLimitEl.addEventListener('change', () => {
          document.querySelectorAll('.amount-btn').forEach(btn => btn.classList.remove('active'));
          validateGiftAmount();
        });
      }

      if (taskLinkEl) {
        taskLinkEl.addEventListener('input', () => {
          const res = normalizeAndClassifyLink(taskLinkEl.value);
          if (!res.ok && taskLinkEl.value.trim() !== '') {
            taskLinkEl.classList.add('error');
            if (taskLinkErr) {
              taskLinkErr.textContent = res.error;
              taskLinkErr.style.display = 'block';
            }
          } else {
            taskLinkEl.classList.remove('error');
            if (taskLinkErr) taskLinkErr.style.display = 'none';
          }
        });
      }

      const promoModal = document.getElementById('promo-modal');
      if (promoModal) {
        promoModal.addEventListener('click', (e) => {
          if (e.target === promoModal) window.closePromoModal();
        });
      }
    });
  </script>
</body>
</html>
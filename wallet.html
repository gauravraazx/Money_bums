<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Wallet - BUMS</title>
  <meta name="viewport" content="width=340, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:linear-gradient(135deg,#0b1224 0%,#0f1e3a 50%,#081224 100%);color:#fff;font-family:'Inter',Arial,sans-serif;min-height:100vh;overflow-x:hidden;font-size:13px}
    .wrap{width:340px;margin:0 auto;padding:14px 8px 110px 8px}

    /* Tabs */
    .tabs{display:flex;gap:10px;margin-bottom:14px}
    .tab{flex:1;text-align:center;padding:12px 10px;border-radius:14px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);cursor:pointer;font-weight:800;letter-spacing:.4px;box-shadow:0 8px 22px rgba(0,0,0,.35)}
    .tab.active{background:rgba(102,126,234,.2);border-color:rgba(102,126,234,.35)}

    /* Cards */
    .card{background:linear-gradient(180deg,rgba(120,92,34,.55),rgba(88,62,20,.45));border:1px solid rgba(255,214,150,.25);border-radius:24px;padding:18px;box-shadow:0 16px 40px rgba(0,0,0,.35)}
    .title{font-size:20px;font-weight:800;margin-bottom:8px}
    .line{margin:12px 0 6px 0;font-size:14px;color:#ffe3b4;font-weight:700}

    .inputRow{position:relative;background:rgba(0,0,0,.28);border:1px solid rgba(255,255,255,.25);border-radius:16px;padding:12px 44px 12px 16px;display:flex;align-items:center;min-height:52px}
    .inputText{font-family:'Inter',monospace;font-weight:800;white-space:nowrap;overflow:auto}
    .copyBtn{position:absolute;right:10px;top:50%;transform:translateY(-50%);width:36px;height:36px;border-radius:10px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.12);display:flex;align-items:center;justify-content:center;cursor:pointer}
    .copyBtn::before{content:"";width:18px;height:18px;background:#fff;mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><rect x="3" y="3" width="13" height="13" rx="2"/></svg>') center/contain no-repeat}
    .hint{margin-top:10px;color:#e6d6b8}

    .formRow{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .inpGrp{display:flex;gap:8px}
    .inp{flex:1;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);border-radius:12px;padding:10px 12px;color:#fff}
    .miniBtn{border:none;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);color:#fff}
    .btn{margin-top:6px;border:none;border-radius:12px;padding:12px 14px;background:linear-gradient(135deg,#60a5fa,#3b82f6);color:#fff;font-weight:800;cursor:pointer}
    .msg{margin-top:6px;font-weight:700}
    .msg.err{color:#f87171}.msg.ok{color:#86efac}

    /* History (small) */
    .hist-head{display:flex;align-items:center;justify-content:space-between;margin:14px 2px 8px 2px}
    .hist-title{font-weight:800;opacity:.9;font-size:14px;letter-spacing:.4px}
    .hist-refresh{width:30px;height:30px;border-radius:10px;background:linear-gradient(135deg,#8b5cf6,#6366f1);display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,.22);cursor:pointer}
    .hist-refresh::before{content:"";width:16px;height:16px;background:#fff;mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 1 1 2.13 8.36" stroke="%23000" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>') center/contain no-repeat}
    .h-item{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:10px;padding:12px;border-radius:14px;background:linear-gradient(135deg,rgba(255,255,255,.06),rgba(255,255,255,.04));border:1px solid rgba(255,255,255,.12);box-shadow:0 6px 18px rgba(0,0,0,.3)}
    .h-col{display:flex;flex-direction:column}
    .h-id{opacity:.9;font-size:12px}
    .h-amt{font-weight:800;font-size:15px;margin-top:4px}
    .h-time{opacity:.9;font-size:12px}
    .h-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid transparent;font-weight:800;font-size:12px}
    .h-badge.ok{background:rgba(22,163,74,.2);border-color:rgba(22,163,74,.5)}
    .h-badge.pend{background:rgba(234,179,8,.25);border-color:rgba(234,179,8,.6)}
    .h-badge.rej{background:rgba(239,68,68,.25);border-color:rgba(239,68,68,.6)}
    .h-badge::before{content:"";width:14px;height:14px;background:#fff;mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5" stroke="%23000" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>') center/contain no-repeat}
    .h-badge.pend::before{mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 6v6l4 2" stroke="%23000" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>')}
    .h-badge.rej::before{mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12" stroke="%23000" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>')}

    /* Bottom nav (index style) */
    .bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:340px;background:rgba(0,0,0,.9);backdrop-filter:blur(20px);border-top:1px solid rgba(255,255,255,.1);border-radius:20px 20px 0 0;padding:16px 12px;display:flex;justify-content:space-around;align-items:center;z-index:100}
    .nav-item{display:flex;flex-direction:column;align-items:center;cursor:pointer;padding:8px 8px;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);min-width:50px;flex:1;margin:0 2px;transition:transform .2s ease, background .2s ease}
    .nav-item:hover{background:rgba(255,255,255,.1);transform:translateY(-2px)}
    .nav-item.active{background:rgba(102,126,234,.2);border-color:rgba(102,126,234,.3)}
    .nav-icon{width:22px;height:22px;margin-bottom:4px;background:#fff;mask-size:contain;mask-repeat:no-repeat;mask-position:center}
    .nav-home .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m3 12 2-2m0 0 7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6'/%3E%3C/svg%3E")}
    .nav-invite .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7M16 6l-4-4-4 4M12 2v14' stroke='currentColor' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E")}
    .nav-task .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'/%3E%3C/svg%3E")}
    .nav-ads .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z'/%3E%3C/svg%3E")}
    .nav-wallet .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z'/%3E%3C/svg%3E")}
    .nav-label{font-size:.7em;font-weight:500;color:#e0e0e0;text-transform:uppercase;letter-spacing:.3px}

    @media(max-width:360px){
      .container{width:100%;padding:7px 3px 90px 3px}
      .bottom-nav{width:100%}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="tabs">
      <div class="tab active" data-tab="deposit">DEPOSIT</div>
      <div class="tab" data-tab="withdraw">WITHDRAW</div>
    </div>

    <!-- Deposit -->
    <div id="deposit" class="card">
      <div class="title">Wallet address</div>
      <div class="inputRow">
        <div id="addr" class="inputText">UQB3O8XsvlpniZ-rsanNwLs1THLxYz1Uc5ucrBwlKS3X-dKE</div>
        <button class="copyBtn" data-copy="addr"></button>
      </div>

      <div class="line">Comment (MEMO) - required!</div>
      <div class="inputRow">
        <div id="memo" class="inputText">Loading...</div>
        <button class="copyBtn" data-copy="memo"></button>
      </div>

      <div class="hint">â€¢ NOTE - Minimum deposit 0.1 TON. Send only TON; include MEMO exactly as shown.</div>

      <!-- NEW: Deposit Amount & Pay -->
      <div class="line" style="margin-top:16px">Deposit TON</div>
      <div class="formRow">
        <input id="depAmount" class="inp" placeholder="Amount (TON)" inputmode="decimal">
        <button id="depPay" class="btn">Pay</button>
        <div id="depMsg" class="msg"></div>
      </div>
    </div>

    <!-- Withdraw -->
    <div id="withdraw" class="card" style="display:none;margin-top:0;">
      <div class="title">Withdraw TON</div>
      <div class="formRow">
        <input id="wAddr" class="inp" placeholder="TON wallet address">
        <div class="inpGrp">
          <input id="wAmount" class="inp" placeholder="Amount (BUMS)" inputmode="numeric">
          <button id="maxBtn" class="miniBtn" type="button">MAX</button>
        </div>
        <button id="wSubmit" class="btn">Request Withdraw</button>
        <div id="wMsg" class="msg"></div>
      </div>
    </div>

    <!-- History visible only when Withdraw tab active -->
    <div id="histBlock" style="display:none">
      <div class="hist-head">
        <div class="hist-title">Withdrawal history</div>
        <button id="refreshHist" class="hist-refresh" aria-label="Refresh"></button>
      </div>
      <div id="hList"></div>
    </div>
  </div>

  <!-- Bottom nav -->
  <div class="bottom-nav">
    <div class="nav-item nav-home" onclick="window.location.href='index.html'">
      <div class="nav-icon"></div><span class="nav-label">Home</span>
    </div>
    <div class="nav-item nav-invite" onclick="window.location.href='invite.html'">
      <div class="nav-icon"></div><span class="nav-label">Invite</span>
    </div>
    <div class="nav-item nav-task" onclick="window.location.href='tasks.html'">
      <div class="nav-icon"></div><span class="nav-label">Tasks</span>
    </div>
    <div class="nav-item nav-ads" onclick="window.location.href='ads.html'">
      <div class="nav-icon"></div><span class="nav-label">Ads</span>
    </div>
    <div class="nav-item nav-wallet active" onclick="window.location.href='wallet.html'">
      <div class="nav-icon"></div><span class="nav-label">Wallet</span>
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, push, set, onValue, get, runTransaction } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyALUr9fR5GE5CxPwY2xdYcIEvy33nu4vbs",
  authDomain: "money-bums-c9eba.firebaseapp.com",
  databaseURL: "https://money-bums-c9eba-default-rtdb.firebaseio.com",
  projectId: "money-bums-c9eba",
  storageBucket: "money-bums-c9eba.firebasestorage.app",
  messagingSenderId: "759031341495",
  appId: "1:759031341495:web:e9d2f9a7ec124e0a524832",
  measurementId: "G-XWHHSQHPP9"
};
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

// Telegram user ID
function getTelegramUser() {
  try { const tg = window.Telegram?.WebApp; tg?.ready?.(); const u = tg?.initDataUnsafe?.user; if (u?.id) return u; } catch {}
  try {
    const parse = (src)=>{ const sp=new URLSearchParams(src); const raw=sp.get('tgWebAppData')||sp.get('tgwebappdata'); if(!raw) return null; const inner=new URLSearchParams(raw); const us=inner.get('user'); return us?JSON.parse(us):null; };
    const h = location.hash? parse(location.hash.slice(1)) : null; if (h?.id) return h;
    const q = parse(location.search.slice(1)); if (q?.id) return q;
  } catch {}
  return { id:"NOT_APP" };
}
const UID = String(getTelegramUser()?.id || "NOT_APP");
document.getElementById('memo').textContent = UID;

// Copy buttons
function trimText(id){ return (document.getElementById(id).textContent||'').replace(/\s+/g,' ').trim(); }
document.querySelectorAll('.copyBtn').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const id = btn.getAttribute('data-copy');
    try{
      await navigator.clipboard.writeText(trimText(id));
      btn.style.background="rgba(34,197,94,.4)";
      setTimeout(()=> btn.style.background="rgba(255,255,255,.12)", 700);
    } catch { alert('Copy failed'); }
  });
});

// Tabs
const histBlock  = document.getElementById('histBlock');
function setTab(active){
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.getElementById('deposit').style.display  = active==='deposit' ? '' : 'none';
  document.getElementById('withdraw').style.display = active==='withdraw' ? '' : 'none';
  histBlock.style.display = active==='withdraw' ? '' : 'none';
  document.querySelector(`.tab[data-tab="${active}"]`).classList.add('active');
}
document.querySelector('.tab[data-tab="deposit"]').addEventListener('click', ()=> setTab('deposit'));
document.querySelector('.tab[data-tab="withdraw"]').addEventListener('click',()=> setTab('withdraw'));

// Withdraw logic
const MIN_WD = 500;
const wMsg   = document.getElementById('wMsg');
const wAmtEl = document.getElementById('wAmount');
let userBalance = 0;

function listenBalance(){
  onValue(ref(db, `users/${UID}/balance`), s=>{
    userBalance = Number(s.val() || 0);
  });
}
listenBalance();

document.getElementById('maxBtn').addEventListener('click', ()=>{
  wAmtEl.value = String(Math.max(userBalance, 0));
  wMsg.textContent = "";
  wMsg.className = "msg";
});

function checkAmount(num){
  if (!Number.isFinite(num) || num <= 0){ wMsg.textContent="Enter valid amount"; wMsg.className="msg err"; return false; }
  if (num < MIN_WD){ wMsg.textContent=`Minimum withdrawal is ${MIN_WD} BUMS`; wMsg.className="msg err"; return false; }
  if (num > userBalance){ wMsg.textContent=`Maximum withdraw ${userBalance} BUMS`; wMsg.className="msg err"; return false; }
  wMsg.textContent=""; wMsg.className="msg"; return true;
}

// History
const hList  = document.getElementById('hList');
const fmtTime = ts => {
  const d = new Date(ts);
  const optDate = { month:'short', day:'2-digit' };
  const optTime = { hour:'2-digit', minute:'2-digit' };
  return { date: d.toLocaleDateString(undefined,optDate), time: d.toLocaleTimeString(undefined,optTime) };
};
const badgeClass = (st) => st==='paid' ? 'ok' : (st==='reject' ? 'rej' : 'pend');

function renderHistory(map){
  const arr = [];
  if (map) { Object.values(map).forEach(v=>{ if (String(v.userid)===UID) arr.push(v); }); }
  arr.sort((a,b)=> Number(b.time||0)-Number(a.time||0));
  if (arr.length===0){ hList.innerHTML = '<div class="h-time">No withdrawals yet.</div>'; return; }
  hList.innerHTML = arr.map(r=>{
    const t = fmtTime(Number(r.time||0));
    const st = String(r.status||'panding');
    const idShort = (r.id||'').slice(0,9);
    return `
      <div class="h-item">
        <div class="h-col">
          <div class="h-id">${idShort}</div>
          <div class="h-amt">${Number(r.amountBUMS||0)} BUMS</div>
        </div>
        <div class="h-col" style="align-items:flex-end;">
          <div class="h-time">${t.date}, ${t.time}</div>
          <div class="h-badge ${badgeClass(st)}">${st.toUpperCase()}</div>
        </div>
      </div>`;
  }).join('');
}

function listenRequests(){
  onValue(ref(db, `withdraw_requests`), snap=>{
    renderHistory(snap.val() || null);
  });
}
listenRequests();

document.getElementById('refreshHist').addEventListener('click', async ()=>{
  const s = await get(ref(db, `withdraw_requests`));
  renderHistory(s.val() || null);
});

// Withdraw submit
document.getElementById('wSubmit').addEventListener('click', async ()=>{
  const addr = (document.getElementById('wAddr').value||"").trim();
  const amt  = parseInt(wAmtEl.value, 10);

  if (!addr){ wMsg.textContent="Enter wallet address"; wMsg.className="msg err"; return; }
  if (!checkAmount(amt)) return;

  const balRef = ref(db, `users/${UID}/balance`);
  let ok = false, newBal = 0;
  await runTransaction(balRef, (curr)=>{
    const b = Number(curr || 0);
    if (!Number.isFinite(b) || b < amt) return; // abort
    ok = true; newBal = b - amt;
    return newBal;
  });

  if (!ok){
    wMsg.textContent = `Maximum withdraw ${userBalance} BUMS`;
    wMsg.className = "msg err";
    return;
  }

  const ts = Date.now();
  const payload = {
    userid: UID,
    address: addr,
    amountBUMS: amt,
    status: 'panding',
    time: ts,
    date: new Date(ts).toISOString().slice(0,10)
  };
  const reqRef = push(ref(db, 'withdraw_requests'));
  await set(reqRef, { id: reqRef.key, ...payload });

  wMsg.textContent = "Request submitted.";
  wMsg.className = "msg ok";
  document.getElementById('wAddr').value = '';
  wAmtEl.value = '';
});

// Deposit logic with TONKeeper
const depAmount = document.getElementById('depAmount');
const depMsg = document.getElementById('depMsg');
const walletAddr = trimText('addr'); // wallet address
const memoId = UID; // MEMO = Telegram userid

document.getElementById('depPay').addEventListener('click', async ()=>{
  const val = parseFloat(depAmount.value);
  if (!Number.isFinite(val) || val < 0.1){
    depMsg.textContent = "Minimum deposit is 0.1 TON";
    depMsg.className = "msg err";
    return;
  }

  depMsg.textContent = "Opening TONKeeper...";
  depMsg.className = "msg ok";

  const tonkeeperLink = `https://tonkeeper.com/transfer/${walletAddr}?amount=${val}&text=${encodeURIComponent(memoId)}`;
  
  window.open(tonkeeperLink, "_blank");

  depMsg.textContent = `TONKeeper opened for ${val} TON`;
  depAmount.value = '';
});

// Default tab
setTab('deposit');
</script>
</head>
</html>
<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <title>Ads - Earn BUMS</title>
  <meta name="viewport" content="width=340, initial-scale=1.0">
  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);color:#fff;font-family:'Inter',Arial,sans-serif;min-height:100vh;overflow-x:hidden;font-size:13px}
    .container{width:340px;margin:0 auto;padding:12px 8px 90px 8px}
    .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:14px;padding:14px;text-align:center;margin-bottom:14px;box-shadow:0 8px 32px rgba(102,126,234,.3);border:1px solid rgba(255,255,255,.1)}
    .header-title{font-size:1em;font-weight:700;letter-spacing:1px;text-shadow:0 2px 4px rgba(0,0,0,.3)}

    /* Earnings */
    .earnings-box{background:rgba(255,255,255,.05);backdrop-filter:blur(10px);border-radius:14px;padding:16px;margin-bottom:16px;border:1px solid rgba(255,255,255,.1);box-shadow:0 8px 32px rgba(0,0,0,.3)}
    .earnings-title{font-size:.95em;font-weight:600;margin-bottom:12px;color:#f0f0f0;text-transform:uppercase;letter-spacing:1px;text-align:center}
    .earning-item{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:rgba(255,255,255,.03);border-radius:8px;margin-bottom:8px;border:1px solid rgba(255,255,255,.05)}
    .earning-label{font-size:.9em;font-weight:500;color:#e0e0e0}
    .earning-value{font-size:.9em;font-weight:600}
    .balance-value{color:#4ade80}.total-earning-value{color:#f59e0b}.today-earning-value{color:#3b82f6}

    /* Ads section (glass) */
    .ads-section{position:relative;padding:16px;border-radius:16px;background:rgba(255,255,255,.06);backdrop-filter:blur(14px) saturate(120%);-webkit-backdrop-filter:blur(14px) saturate(120%);border:1px solid rgba(255,255,255,.14);box-shadow:0 10px 30px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.06);margin-bottom:16px;overflow:hidden}
    .ads-section::before{content:"";position:absolute;inset:0;background:radial-gradient(120% 60% at -10% -20%,rgba(124,58,237,.28) 0%,transparent 60%),radial-gradient(120% 60% at 110% 120%,rgba(99,102,241,.22) 0%,transparent 60%);pointer-events:none}
    .section-title{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:999px;background:linear-gradient(135deg,#67e8f9 0%,#a78bfa 50%,#f472b6 100%);color:#0b1020;font-weight:700;font-size:.9em;margin:0 auto 14px;text-transform:none;letter-spacing:.3px;box-shadow:0 6px 18px rgba(167,139,250,.35)}
    .section-title::before{content:"";width:16px;height:16px;background:#0b1020;mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%23000" d="M8 5v14l11-7z"/></svg>') center/contain no-repeat}

    .ad-item{position:relative;display:flex;flex-direction:column;gap:10px;padding:14px;border-radius:14px;background:rgba(13,18,35,.55);border:1px solid rgba(255,255,255,.08);box-shadow:0 8px 20px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease;text-align:left;margin-bottom:12px}
    .ad-item:hover{transform:translateY(-2px);box-shadow:0 12px 26px rgba(0,0,0,.45);border-color:rgba(255,255,255,.16)}
    .ad-title{font-size:1.02em;font-weight:700;letter-spacing:.2px;color:#f4f4f5;margin-bottom:2px}
    .ad-reward{display:inline-flex;align-items:center;gap:8px;width:max-content;margin-top:2px;padding:6px 10px;border-radius:10px;background:linear-gradient(135deg,rgba(16,185,129,.15),rgba(34,197,94,.15));color:#34d399;font-weight:600;border:1px solid rgba(16,185,129,.35)}
    .ad-reward::before{content:"";width:14px;height:14px;background:#34d399;mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path fill="%23000" d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 4v2.09a3.5 3.5 0 012.5 3.36c0 1.93-1.57 3.5-3.5 3.5H9a1 1 0 110-2h1a1.5 1.5 0 000-3H9a1 1 0 110-2h2V6a1 1 0 112 0z"/></svg>') center/contain no-repeat}

    /* Progress rows */
    .progress-row{display:flex;flex-direction:column;gap:6px;margin-top:6px}
    .progress-row.subtle{opacity:.95}
    .progress-label{display:flex;justify-content:space-between;align-items:center;font-size:.85em;color:#cfd6e6}
    .progress-track{position:relative;height:10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);overflow:hidden}
    .progress-track.inverse{background:rgba(255,255,255,.04)}
    .progress-fill{height:100%;width:0%;background:linear-gradient(90deg,#22c55e 0%,#10b981 45%,#06b6d4 100%);transition:width .35s ease}
    .progress-fill.inverse{background:linear-gradient(90deg,#22c55e 0%,#84cc16 60%,#f59e0b 100%)}

    /* Buttons */
    .ad-btn{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background-clip:padding-box;font-weight:700;cursor:pointer;transition:transform .2s ease, box-shadow .2s ease, background .2s ease, opacity .2s ease}
    .ad-btn:disabled{opacity:.6;cursor:not-allowed}
    .watch-btn{background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:#fff;box-shadow:0 8px 20px rgba(124,58,237,.4)}
    .watch-btn::before{content:"";width:16px;height:16px;margin-right:8px;background:#fff;display:inline-block;vertical-align:-3px;mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%23000" d="M8 5v14l11-7z"/></svg>') center/contain no-repeat}
    .ad-processing-btn{background:linear-gradient(135deg,#60a5fa,#3b82f6);color:#fff;cursor:wait;position:relative;box-shadow:0 6px 16px rgba(59,130,246,.35)}
    .ad-processing-btn::after{content:"";width:16px;height:16px;margin-left:8px;display:inline-block;vertical-align:-3px;border-radius:50%;border:2px solid rgba(255,255,255,.7);border-top-color:transparent;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Bottom nav */
    .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 340px; background: rgba(0,0,0,0.9); backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.1); border-radius: 20px 20px 0 0; padding: 16px 8px; display: flex; justify-content: space-around; align-items: center; z-index: 100; }
    .nav-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 6px 4px; border-radius: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); min-width: 45px; flex: 1; margin: 0 2px; transition: all 0.2s; }
    .nav-item:hover { background: rgba(255,255,255,0.1); transform: translateY(-2px); }
    .nav-icon { width: 20px; height: 20px; margin-bottom: 3px; background: #fff; mask-size: contain; mask-repeat: no-repeat; mask-position: center; }
    .nav-home .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m3 12 2-2m0 0 7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6'/%3E%3C/svg%3E"); }
    /* New WIN icon (star) */
    .nav-win .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='currentColor' d='M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z'/%3E%3C/svg%3E"); }
    .nav-ads .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z'/%3E%3C/svg%3E"); }
    .nav-refer .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z'/%3E%3C/svg%3E"); }
    .nav-task .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'/%3E%3C/svg%3E"); }
    .nav-wallet .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 00-3 3z'/%3E%3C/svg%3E"); }
    .nav-label { font-size: 0.65em; font-weight: 500; color: #e0e0e0; text-transform: uppercase; letter-spacing: 0.3px; }

    #snackbar { display: none; position: fixed; top: 18px; left: 50%; transform: translateX(-50%); background: #059669; color: white; padding: 12px 24px; border-radius: 24px; z-index: 2001; font-weight: 600; font-size: 1em; box-shadow: 0 4px 16px rgba(5,150,105,0.4); transition: opacity 0.4s; opacity: 1; letter-spacing: 0.5px; }
    #snackbar.error { background: #ef4444; box-shadow: 0 4px 16px rgba(239,68,68,0.4); }

    @media (max-width: 360px) { .container { width: 100%; padding: 10px 5px 110px 5px; } .bottom-nav { width: 100%; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header"><div class="header-title" id="telegram-id">Loading User...</div></div>

    <div class="earnings-box">
      <div class="earnings-title">üìä Earnings Summary</div>
      <div class="earning-item">
        <div class="earning-label">üí∞ Balance:</div>
        <div class="earning-value balance-value" id="balance-display">... BUMS</div>
      </div>
      <div class="earning-item">
        <div class="earning-label">üìà Total Earning:</div>
        <div class="earning-value total-earning-value" id="total-earning">... BUMS</div>
      </div>
      <div class="earning-item">
        <div class="earning-label">‚≠ê Today Earning:</div>
        <div class="earning-value today-earning-value" id="today-earning">... BUMS</div>
      </div>
    </div>

    <div class="ads-section">
      <div class="section-title">üé¨ Watch Ads & Earn</div>

      <div class="ad-item">
        <div class="ad-title">üíé Premium Video Ad</div>
        <div class="ad-reward">+ 2 BUMS per ad</div>

        <div class="progress-row">
          <div class="progress-label"><span>View progress</span><span id="premium-view-text">0/25</span></div>
          <div class="progress-track" id="premium-view-track" role="progressbar" aria-label="Premium view progress" aria-valuemin="0" aria-valuemax="25" aria-valuenow="0">
            <div class="progress-fill" id="premium-view-bar"></div>
          </div>
        </div>

        <button class="ad-btn watch-btn" id="ad-button-premium">Watch Ad</button>
      </div>

      <div class="ad-item">
        <div class="ad-title">üöÄ Sponsored Content</div>
        <div class="ad-reward">+ 2 BUMS per view</div>

        <div class="progress-row">
          <div class="progress-label"><span>View progress</span><span id="sponsored-view-text">0/25</span></div>
          <div class="progress-track" id="sponsored-view-track" role="progressbar" aria-label="Sponsored view progress" aria-valuemin="0" aria-valuemax="25" aria-valuenow="0">
            <div class="progress-fill" id="sponsored-view-bar"></div>
          </div>
        </div>

        <button class="ad-btn watch-btn" id="ad-button-sponsored">Watch Ad</button>
      </div>
    </div>
  </div>

  <div id="snackbar"></div>

  <div class="bottom-nav">
    <div class="nav-item nav-home" onclick="window.location.href='index.html'">
      <div class="nav-icon"></div><span class="nav-label">Home</span>
    </div>
    <!-- New WIN between Home and Ads -->
    <div class="nav-item nav-win" onclick="window.location.href='win.html'">
      <div class="nav-icon"></div><span class="nav-label">Win</span>
    </div>
    <div class="nav-item nav-ads" onclick="window.location.href='ads.html'">
      <div class="nav-icon"></div><span class="nav-label">Ads</span>
    </div>
    <div class="nav-item nav-refer" onclick="window.location.href='refer.html'">
      <div class="nav-icon"></div><span class="nav-label">Refer</span>
    </div>
    <div class="nav-item nav-task" onclick="window.location.href='tasks.html'">
      <div class="nav-icon"></div><span class="nav-label">Tasks</span>
    </div>
    <div class="nav-item nav-wallet" onclick="window.location.href='wallet.html'">
      <div class="nav-icon"></div><span class="nav-label">Wallet</span>
    </div>
  </div>

  <!-- Monetag SDK: Premium + Sponsored -->
  <script src='//libtl.com/sdk.js' data-zone='9903518' data-sdk='show_9903518'></script>
  <script src='//libtl.com/sdk.js' data-zone='10005741' data-sdk='show_10005741'></script>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- App Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    function showSnackbar(msg, isError = false) {
      const el = document.getElementById('snackbar');
      el.textContent = msg;
      el.className = isError ? 'error' : '';
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, isError ? 4000 : 2500);
    }

    const firebaseConfig = {
      apiKey: "AIzaSyBv4V4zPlUlbotICs5JVVJVfeZ_wesBCQI",
      authDomain: "momey-bims.firebaseapp.com",
      databaseURL: "https://momey-bims-default-rtdb.firebaseio.com",
      projectId: "momey-bims",
      storageBucket: "momey-bims.firebasestorage.app",
      messagingSenderId: "21496105095",
      appId: "1:21496105095:web:cbd7b39dada8f0b671d022",
      measurementId: "G-ECE8ZBS23B"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // Telegram user
    window.Telegram?.WebApp?.ready?.();
    const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
    let userKey = tgUser?.id ? String(tgUser.id) : "UNKNOWN_USER";
    document.getElementById("telegram-id").textContent = tgUser?.username ? "@"+tgUser.username : userKey;

    // App constants
    const MAX_ADS_PER_DAY = 25;
    const AD_KEYS = { 'ad-button-premium':'premium', 'ad-button-sponsored':'sponsored' };

    // Map each ad key to its SDK function
    const AD_SDK_FN = { premium: 'show_9903518', sponsored: 'show_10005741' };

    // BUMS stored directly as 'bums' field
    const DEFAULT_DOC = { bums: 0, totalEarning: 0, dailyEarnings: {}, adViews: {} };

    const todayStr = () => new Date().toISOString().split('T')[0];
    let userData = null;

    async function ensureUserDoc() {
      const uref = ref(db, 'users/' + userKey);
      const snap = await get(uref);
      if (!snap.exists()) {
        await set(uref, DEFAULT_DOC);
        return { ...DEFAULT_DOC };
      }
      return snap.val() || { ...DEFAULT_DOC };
    }

    function setBar(fillId, textId, now, max) {
      document.getElementById(fillId).style.width = `${(now/max)*100}%`;
      document.getElementById(textId).textContent = `${now}/${max}`;
    }

    async function loadAndRender() {
      userData = await ensureUserDoc();

      // DIRECT: users/{userid}/bums
      const bums = userData.bums || 0;
      const total = userData.totalEarning || 0;
      const tEarn = userData.dailyEarnings?.[todayStr()] || 0;

      // Display ONLY BUMS
      document.getElementById('balance-display').textContent = `${bums} BUMS`;
      document.getElementById('total-earning').textContent = `${total} BUMS`;
      document.getElementById('today-earning').textContent = `${tEarn} BUMS`;

      // Progress
      const pv = userData.adViews?.[todayStr()]?.premium || 0;
      const sv = userData.adViews?.[todayStr()]?.sponsored || 0;
      setBar('premium-view-bar','premium-view-text', pv, MAX_ADS_PER_DAY);
      setBar('sponsored-view-bar','sponsored-view-text', sv, MAX_ADS_PER_DAY);

      document.getElementById('ad-button-premium').disabled = pv>=MAX_ADS_PER_DAY;
      document.getElementById('ad-button-sponsored').disabled = sv>=MAX_ADS_PER_DAY;
    }

    async function startCooldown(btn, seconds = 5) {
      for (let s = seconds; s > 0; s--) {
        btn.disabled = true;
        btn.textContent = `Please wait ${s}s...`;
        await new Promise(r => setTimeout(r, 1000));
      }
    }

    async function handleWatchAd(adButtonId, rewardBums) {
      const adKey = AD_KEYS[adButtonId];
      const count = userData.adViews?.[todayStr()]?.[adKey] || 0;
      if (count >= MAX_ADS_PER_DAY) return showSnackbar("Daily limit reached", true);

      const btn = document.getElementById(adButtonId);
      btn.disabled = true;
      btn.className = "ad-btn ad-processing-btn";
      btn.textContent = "Loading Ad...";

      const fnName = AD_SDK_FN[adKey];
      if (typeof window[fnName] === 'function') {
        try {
          await window[fnName](); // Show the ad (Monetag SDK)
          await claimAdReward(adKey, rewardBums, count);
          await loadAndRender();

          // Cooldown: 5 seconds before enabling again
          btn.className = "ad-btn watch-btn";
          await startCooldown(btn, 5);

          // Re-evaluate limit after cooldown
          const nowCount = userData.adViews?.[todayStr()]?.[adKey] || 0;
          btn.textContent = "Watch Ad";
          btn.disabled = nowCount >= MAX_ADS_PER_DAY;
        } catch(e) {
          showSnackbar("Ad failed", true);
          btn.className = "ad-btn watch-btn";
          btn.textContent = "Watch Ad";
          btn.disabled = false;
        }
      } else {
        showSnackbar("Ad service unavailable", true);
        btn.className = "ad-btn watch-btn";
        btn.textContent = "Watch Ad";
        btn.disabled = false;
      }
    }

    async function claimAdReward(adKey, rewardBums, prevCount) {
      const t = todayStr();
      const uref = ref(db, 'users/' + userKey);

      // DIRECT: users/{userid}/bums
      const nextBums  = (userData.bums || 0) + rewardBums;
      const nextTotal = (userData.totalEarning || 0) + rewardBums;
      const nextToday = (userData.dailyEarnings?.[t] || 0) + rewardBums;
      const nextViews = prevCount + 1;

      await update(uref, {
        bums: nextBums,
        totalEarning: nextTotal,
        [`dailyEarnings/${t}`]: nextToday,
        [`adViews/${t}/${adKey}`]: nextViews
      });

      showSnackbar(`üéâ You earned ${rewardBums} BUMS!`);
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await loadAndRender();
      document.getElementById('ad-button-premium').onclick   = () => handleWatchAd('ad-button-premium', 2);
      document.getElementById('ad-button-sponsored').onclick = () => handleWatchAd('ad-button-sponsored', 2);
    });
  </script>
</body>
</html>

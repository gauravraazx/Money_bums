<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <title>Wallet</title>
  <meta name="viewport" content="width=340, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      font-family: 'Inter', Arial, sans-serif;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 13px;
      padding: 10px 5px 100px 5px;
    }
    .id-banner {
      width: 100%;
      max-width: 340px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      font-weight: 700;
      font-size: 1em;
      text-align: center;
      padding: 10px 10px;
      border-radius: 14px;
      margin-bottom: 16px;
      letter-spacing: 1px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
      box-shadow: 0 8px 32px rgba(102,126,234,0.3);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    /* Tab Buttons */
    .tab-buttons {
      width: 100%;
      max-width: 340px;
      display: flex;
      margin-bottom: 16px;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.1);
      overflow: hidden;
    }
    .tab-btn {
      flex: 1;
      padding: 12px 16px;
      background: transparent;
      color: rgba(255,255,255,0.7);
      border: none;
      font-family: inherit;
      font-size: 0.95em;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .tab-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .tab-btn:hover:not(.active) {
      background: rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.9);
    }

    /* Content Containers */
    .content-container {
      width: 100%;
      max-width: 340px;
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(10px);
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.1);
      padding: 20px 15px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      display: none;
      flex-direction: column;
      gap: 16px;
    }
    .content-container.active {
      display: flex;
    }

    /* Deposit Styles */
    .deposit-section {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .deposit-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .deposit-label {
      font-weight: 600;
      font-size: 0.96em;
      letter-spacing: 0.5px;
      color: #f0f0f0;
      text-transform: uppercase;
    }
    .deposit-value-container {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 10px 12px;
      backdrop-filter: blur(8px);
    }
    .deposit-value {
      flex: 1;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 0.85em;
      color: #4ade80;
      font-weight: 500;
      word-break: break-all;
      line-height: 1.3;
    }
    .copy-btn {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border: none;
      border-radius: 6px;
      color: #fff;
      padding: 6px 10px;
      font-size: 0.8em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .copy-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 12px rgba(16,185,129,0.3);
    }
    .copy-btn:active {
      transform: translateY(0);
    }
    .note-text {
      background: rgba(255,193,7,0.1);
      border: 1px solid rgba(255,193,7,0.3);
      border-radius: 8px;
      padding: 12px;
      font-size: 0.85em;
      color: #ffd700;
      line-height: 1.4;
    }
    .note-text strong {
      color: #fff;
    }

    /* Form Input (used in deposit amount too) */
    .form-input {
      width: 100%;
      padding: 7px 10px;
      border-radius: 7px;
      font-family: inherit;
      font-size: 0.98em;
      font-weight: 500;
      outline: none;
      border: 2px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.1);
      color: #fff;
      backdrop-filter: blur(8px);
      transition: all 0.3s;
    }
    .form-input::placeholder {
      color: rgba(255,255,255,0.6);
    }
    .form-input:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.2);
      background: rgba(255,255,255,0.15);
    }

    /* Withdraw Form Styles */
    .withdraw-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .form-group { 
      display: flex; 
      flex-direction: column; 
      gap: 5px; 
    }
    .form-label {
      font-weight: 600;
      font-size: 0.96em;
      letter-spacing: 0.5px;
      color: #f0f0f0;
      text-transform: uppercase;
      margin-bottom: 2px;
    }
    .form-select {
      width: 100%;
      padding: 7px 10px;
      border-radius: 7px;
      font-family: inherit;
      font-size: 0.98em;
      font-weight: 500;
      outline: none;
      border: 2px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.1);
      color: #fff;
      backdrop-filter: blur(8px);
      transition: all 0.3s;
    }
    .form-select option {
      background: #1a1a2e;
      color: #fff;
    }
    .form-select:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.2);
      background: rgba(255,255,255,0.15);
    }
    .hint-text {
      font-size: 0.80em;
      color: #4ade80;
      font-weight: 500;
      letter-spacing: 0.3px;
      margin-top: -3px;
    }
    .conversion-text {
      font-size: 0.85em;
      color: #a78bfa;
      font-weight: 600;
      letter-spacing: 0.3px;
      margin-top: 2px;
      padding: 8px 10px;
      background: rgba(167,139,250,0.1);
      border-radius: 6px;
      border: 1px solid rgba(167,139,250,0.2);
    }
    .submit-btn {
      width: 100%;
      padding: 10px 5px;
      font-size: 1em;
      font-weight: 700;
      color: #fff;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border: none;
      border-radius: 8px;
      margin-top: 2px;
      letter-spacing: 0.7px;
      cursor: pointer;
      text-transform: uppercase;
      transition: all 0.3s;
      box-shadow: 0 3px 10px rgba(16,185,129,0.2);
    }
    .submit-btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 5px 18px rgba(16,185,129,0.3);
    }
    .submit-btn:disabled {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
      cursor: not-allowed;
      box-shadow: none;
    }

    /* Withdrawal History Styles */
    .history-section {
      margin-top: 20px;
      width: 100%;
    }
    .history-header-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .history-title {
      font-size: 1.1em;
      font-weight: 700;
      color: #f0f0f0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .reload-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 6px;
      color: #fff;
      padding: 6px 10px;
      font-size: 1.1em;
      cursor: pointer;
      transition: all 0.3s;
      min-width: 32px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .reload-btn:hover {
      transform: translateY(-1px) rotate(180deg);
      box-shadow: 0 3px 12px rgba(102,126,234,0.3);
    }
    .reload-btn:active {
      transform: translateY(0);
    }
    .history-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .history-item {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 12px 14px;
      backdrop-filter: blur(8px);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .history-address {
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 0.85em;
      color: #f0f0f0;
      font-weight: 600;
    }
    .history-date {
      font-size: 0.75em;
      color: rgba(255,255,255,0.6);
      font-weight: 500;
    }
    .history-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .history-amount {
      font-size: 0.9em;
      color: #f0f0f0;
      font-weight: 600;
    }
    .status-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75em;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      border: 1px solid;
    }
    .status-pending {
      background: rgba(255,193,7,0.1);
      border-color: rgba(255,193,7,0.3);
      color: #ffc107;
    }
    .status-paid {
      background: rgba(34,197,94,0.1);
      border-color: rgba(34,197,94,0.3);
      color: #22c55e;
    }
    .status-rejected {
      background: rgba(239,68,68,0.1);
      border-color: rgba(239,68,68,0.3);
      color: #ef4444;
    }
    .no-history {
      text-align: center;
      color: rgba(255,255,255,0.5);
      font-size: 0.9em;
      padding: 20px;
      font-style: italic;
    }

    /* Bottom Navigation */
    .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 340px; background: rgba(0,0,0,0.9); backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.1); border-radius: 20px 20px 0 0; padding: 16px 8px; display: flex; justify-content: space-around; align-items: center; z-index: 100; }
    .nav-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 6px 4px; border-radius: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); min-width: 45px; flex: 1; margin: 0 2px; transition: all 0.2s; }
    .nav-item:hover { background: rgba(255,255,255,0.1); transform: translateY(-2px); }
    .nav-icon { width: 20px; height: 20px; margin-bottom: 3px; background: #fff; mask-size: contain; mask-repeat: no-repeat; mask-position: center; }
    .nav-home .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m3 12 2-2m0 0 7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6'/%3E%3C/svg%3E"); }
    /* New WIN icon (star) */
    .nav-win .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='currentColor' d='M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z'/%3E%3C/svg%3E"); }
    .nav-ads .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z'/%3E%3C/svg%3E"); }
    .nav-refer .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z'/%3E%3C/svg%3E"); }
    .nav-task .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'/%3E%3C/svg%3E"); }
    .nav-wallet .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 00-3 3z'/%3E%3C/svg%3E"); }
    .nav-label { font-size: 0.65em; font-weight: 500; color: #e0e0e0; text-transform: uppercase; letter-spacing: 0.3px; }

    #snackbar { display: none; position: fixed; top: 18px; left: 50%; transform: translateX(-50%); background: #059669; color: white; padding: 12px 24px; border-radius: 24px; z-index: 2001; font-weight: 600; font-size: 1em; box-shadow: 0 4px 16px rgba(5,150,105,0.4); transition: opacity 0.4s; opacity: 1; letter-spacing: 0.5px; }
    #snackbar.error { background: #ef4444; box-shadow: 0 4px 16px rgba(239,68,68,0.4); }

    @media (max-width: 360px) { .container { width: 100%; padding: 10px 5px 110px 5px; } .bottom-nav { width: 100%; } }
  </style>
</head>
<body>
  <!-- User Banner -->
  <div class="id-banner" id="id-banner">Loading User...</div>
  
  <!-- Tab Buttons -->
  <div class="tab-buttons">
    <button class="tab-btn active" id="depositTab" onclick="switchTab('deposit')">DEPOSIT <small><sup>+50%</sup></small></button>
    <button class="tab-btn" id="withdrawTab" onclick="switchTab('withdraw')">WITHDRAW</button>
  </div>

  <!-- Deposit Content -->
  <div class="content-container active" id="depositContent">
    <div class="deposit-section">
      <div class="deposit-item">
        <div class="deposit-label">Network: TON</div>
      </div>
      
      <div class="deposit-item">
        <div class="deposit-label">Deposit Address:</div>
        <div class="deposit-value-container">
          <div class="deposit-value" id="depositAddress">UQB3O8XsvlpniZ-rsanNwLs1THLxYz1Uc5ucrBwlKS3X-dKE</div>
          <button class="copy-btn" onclick="copyToClipboard('depositAddress')">Copy</button>
        </div>
      </div>
      
      <div class="deposit-item">
        <div class="deposit-label">Memo (Your User ID):</div>
        <div class="deposit-value-container">
          <div class="deposit-value" id="userMemo">NOT_APP</div>
          <button class="copy-btn" onclick="copyToClipboard('userMemo')">Copy</button>
        </div>
      </div>
      
      <div class="note-text">
        <strong>Note:</strong> Deposit only TON on TON network.<br>
        • Memo (user id) is required to credit your account.
      </div>

      <!-- NEW: Deposit Amount Input & Button -->
      <div class="deposit-item">
        <div class="deposit-label">Amount (TON)</div>
        <input type="number" id="depositAmountInput" class="form-input" placeholder="Enter amount (optional)" step="any" min="0.01">
      </div>
      <div class="deposit-item">
        <button class="submit-btn" onclick="openTonWallet()">Deposit via TON Wallet</button>
      </div>
    </div>
  </div>

  <!-- Withdraw Content -->
  <div class="content-container" id="withdrawContent">
    <form class="withdraw-form" id="withdrawForm" autocomplete="off">
      <div class="form-group">
        <label class="form-label">Coin: BUMS</label>
        <div class="hint-text" id="coinBalanceText">Your BUMS Balance: 0</div>
      </div>
      <div class="form-group">
        <label class="form-label" for="amountInput">Amount</label>
        <input type="number" class="form-input" id="amountInput" placeholder="Enter Amount" required step="any" min="1000">
        <div class="hint-text">Minimum: 1000 BUMS</div>
        <div class="conversion-text" id="conversionText">You will receive: 0 TON</div>
      </div>
      <div class="form-group">
        <label class="form-label" for="idInput">TON Wallet Address</label>
        <input type="text" class="form-input" id="idInput" placeholder="Enter TON Wallet Address" required>
      </div>
      <button class="submit-btn" id="submitBtn" type="submit">Submit Request</button>
    </form>
    
    <!-- Withdrawal History Section -->
    <div class="history-section">
      <div class="history-header-section">
        <h3 class="history-title">Withdrawal History</h3>
        <button class="reload-btn" onclick="loadWithdrawalHistory()" title="Reload History">⟳</button>
      </div>
      <div id="historyContainer" class="history-container">
        <div class="no-history">No withdrawal history found</div>
      </div>
    </div>
  </div>
  
  <!-- Bottom Nav -->
  <div class="bottom-nav">
    <div class="nav-item nav-home" onclick="window.location.href='index.html'">
      <div class="nav-icon"></div><span class="nav-label">Home</span>
    </div>
    <div class="nav-item nav-win" onclick="window.location.href='win.html'">
      <div class="nav-icon"></div><span class="nav-label">Win</span>
    </div>
    <div class="nav-item nav-ads" onclick="window.location.href='ads.html'">
      <div class="nav-icon"></div><span class="nav-label">Ads</span>
    </div>
    <div class="nav-item nav-refer" onclick="window.location.href='refer.html'">
      <div class="nav-icon"></div><span class="nav-label">Refer</span>
    </div>
    <div class="nav-item nav-task" onclick="window.location.href='tasks.html'">
      <div class="nav-icon"></div><span class="nav-label">Tasks</span>
    </div>
    <div class="nav-item nav-wallet" onclick="window.location.href='wallet.html'">
      <div class="nav-icon"></div><span class="nav-label">Wallet</span>
    </div>
  </div>

  <!-- Snackbar -->
  <div id="snackbar"></div>

  <!-- Firebase + Telegram Script -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
<script type="module">
  // Firebase v9 modular
  import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getDatabase, ref, get, set, push, update, runTransaction } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBv4V4zPlUlbotICs5JVVJVfeZ_wesBCQI",
    authDomain: "momey-bims.firebaseapp.com",
    databaseURL: "https://momey-bims-default-rtdb.firebaseio.com",
    projectId: "momey-bims",
    storageBucket: "momey-bims.firebasestorage.app",
    messagingSenderId: "21496105095",
    appId: "1:21496105095:web:cbd7b39dada8f0b671d022",
    measurementId: "G-ECE8ZBS23B"
  };

  let app;
  try { app = getApps().length ? getApp() : initializeApp(firebaseConfig); } catch {}
  const db = getDatabase(app);

  // UI helpers
  function showSnack(msg, isErr = false) {
    const sb = document.getElementById("snackbar");
    sb.textContent = msg;
    sb.className = isErr ? "error" : "";
    sb.style.display = "block";
    setTimeout(() => (sb.style.display = "none"), 1600);
  }

  function injectDepositStatus() {
    const box = document.getElementById("depositContent");
    if (!box) return;
    const stat = document.createElement("div");
    stat.id = "autoDepositStatus";
    stat.style.fontSize = "0.85em";
    stat.style.color = "#a78bfa";
    stat.style.fontWeight = "700";
    stat.style.letterSpacing = "0.3px";
    stat.textContent = "Auto-deposit: starting...";
    box.appendChild(stat);

    const tonBal = document.createElement("div");
    tonBal.id = "tonBalanceText";
    tonBal.style.fontSize = "0.9em";
    tonBal.style.color = "#4ade80";
    tonBal.style.fontWeight = "700";
    tonBal.style.marginTop = "6px";
    tonBal.textContent = "Your TON Balance: —";
    box.appendChild(tonBal);
  }

  // Telegram user - FIXED
  let userKey = "NOT_APP";
  let isTelegram = false;
  
  try {
    window.Telegram?.WebApp?.ready?.();
    const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
    
    if (tgUser && tgUser.id) {
      const displayName = tgUser.username ? "@" + tgUser.username : "ID: " + tgUser.id;
      document.getElementById("id-banner").textContent = displayName;
      document.getElementById("userMemo").textContent = String(tgUser.id);
      userKey = String(tgUser.id);
      isTelegram = true;
    } else {
      // NOT_APP mode - sab kuch kaam karega
      document.getElementById("id-banner").textContent = "Demo Mode (NOT_APP)";
      document.getElementById("userMemo").textContent = "NOT_APP";
      userKey = "NOT_APP";
      isTelegram = false;
    }
  } catch (err) {
    console.log("Telegram init error, using NOT_APP mode", err);
    document.getElementById("id-banner").textContent = "Demo Mode (NOT_APP)";
    document.getElementById("userMemo").textContent = "NOT_APP";
    userKey = "NOT_APP";
    isTelegram = false;
  }

  // Tabs
  window.switchTab = function(tab) {
    document.getElementById('depositTab').classList.remove('active');
    document.getElementById('withdrawTab').classList.remove('active');
    document.getElementById('depositContent').classList.remove('active');
    document.getElementById('withdrawContent').classList.remove('active');
    if (tab === 'deposit') {
      document.getElementById('depositTab').classList.add('active');
      document.getElementById('depositContent').classList.add('active');
    } else {
      document.getElementById('withdrawTab').classList.add('active');
      document.getElementById('withdrawContent').classList.add('active');
      loadWithdrawalHistory();
    }
  };

  // Copy
  window.copyToClipboard = async function(elementId) {
    const text = document.getElementById(elementId)?.textContent || "";
    if (!text) return;
    try {
      await navigator.clipboard.writeText(text);
      const button = event.target;
      const originalText = button.textContent;
      button.textContent = '✓';
      button.style.background = 'linear-gradient(135deg, #059669 0%, #047857 100%)';
      setTimeout(() => {
        button.textContent = originalText;
        button.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
      }, 1000);
    } catch {
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      showSnack('Copied!', false);
    }
  };

  // FIXED: Open TON Wallet - ab sahi link banega
  window.openTonWallet = function() {
    const address = "UQB3O8XsvlpniZ-rsanNwLs1THLxYz1Uc5ucrBwlKS3X-dKE";
    const amountStr = document.getElementById("depositAmountInput")?.value.trim();
    
    // Validate minimum amount
    if (!amountStr || isNaN(amountStr) || parseFloat(amountStr) < 0.1) {
      showSnack("Minimum deposit is 0.1 TON", true);
      return;
    }

    // Convert TON to nanotons (1 TON = 1,000,000,000 nanotons)
    const nano = Math.floor(parseFloat(amountStr) * 1e9);
    
    // Build proper TON deeplink
    const url = `https://app.tonkeeper.com/transfer/${address}?amount=${nano}&text=${encodeURIComponent(userKey)}`;
    
    // Alternative: Direct ton:// protocol
    const tonUrl = `ton://transfer/${address}?amount=${nano}&text=${encodeURIComponent(userKey)}`;
    
    // Try ton:// first, fallback to tonkeeper web
    try {
      window.location.href = tonUrl;
      // Fallback after 1 second
      setTimeout(() => {
        if (document.hasFocus()) {
          window.open(url, '_blank');
        }
      }, 1000);
    } catch (err) {
      // Direct fallback
      window.open(url, '_blank');
    }
    
    showSnack(`Opening TON wallet for ${parseFloat(amountStr).toFixed(2)} TON`, false);
  };

  // Balance & Withdraw
  const BUMS_TO_TON_RATE = 0.00002;
  let userBums = 0;
  const userRef = ref(db, "users/" + userKey);

  async function loadBalance() {
    try {
      const snap = await get(userRef);
      if (snap.exists()) {
        const v = snap.val();
        userBums = Number(v.bums ?? 0);
        const tonBalEl = document.getElementById("tonBalanceText");
        if (tonBalEl) {
          const tonBalVal = Number(v.ton_balance ?? 0);
          tonBalEl.textContent = `Your TON Balance: ${tonBalVal.toFixed(6)} TON`;
        }
      } else {
        // Create user with default balance (for both Telegram and NOT_APP)
        await set(userRef, { bums: 10, ton_balance: 0 });
        userBums = 10;
      }
      updateBalanceDisplay();
    } catch (err) { 
      console.error("Load balance error:", err);
      // Still show default values
      userBums = 0;
      updateBalanceDisplay();
    }
  }

  function updateBalanceDisplay() {
    const tonEquivalent = (userBums * BUMS_TO_TON_RATE).toFixed(6);
    const el = document.getElementById("coinBalanceText");
    if (el) el.textContent = `Your BUMS Balance: ${userBums} ≈ ${tonEquivalent} TON`;
  }

  document.getElementById("amountInput")?.addEventListener("input", function() {
    const amount = parseFloat(this.value) || 0;
    const tonAmount = (amount * BUMS_TO_TON_RATE).toFixed(6);
    const ct = document.getElementById("conversionText");
    if (ct) ct.textContent = `You will receive: ${amount} × 0.00002 TON ≈ ${tonAmount} TON`;
  });

  window.loadWithdrawalHistory = async function() {
    const historyContainer = document.getElementById('historyContainer');
    if (historyContainer) historyContainer.innerHTML = '<div class="no-history">Loading...</div>';
    try {
      const historyRef = ref(db, 'withdraw_requests');
      const snapshot = await get(historyRef);
      if (!snapshot.exists()) {
        if (historyContainer) historyContainer.innerHTML = '<div class="no-history">No withdrawal history found</div>';
        return;
      }
      const requests = [];
      snapshot.forEach((child) => {
        const data = child.val();
        if (data.user_id === userKey) requests.push({ id: child.key, ...data });
      });
      if (requests.length === 0) {
        if (historyContainer) historyContainer.innerHTML = '<div class="no-history">No withdrawal history found</div>';
        return;
      }
      requests.sort((a, b) => new Date(b.time) - new Date(a.time));
      let html = '';
      requests.forEach(req => {
        const date = new Date(req.time);
        const formatted = date.toLocaleDateString('en-US', { month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit', hour12:true });
        let statusClass='status-pending', statusText='Pending';
        if (req.status === 'completed' || req.status === 'paid') { statusClass='status-paid'; statusText='✅ Paid'; }
        else if (req.status === 'rejected' || req.status === 'failed') { statusClass='status-rejected'; statusText='❌ Reject'; }
        const displayPayout = (req.payout||'').length>20 ? (req.payout.substring(0,20)+'...') : (req.payout||'—');
        html += `
          <div class="history-item">
            <div class="history-header">
              <div class="history-address">${displayPayout}</div>
              <div class="history-date">${formatted}</div>
            </div>
            <div class="history-footer">
              <div class="history-amount">${req.amount} BUMS</div>
              <div class="status-badge ${statusClass}">${statusText}</div>
            </div>
          </div>`;
      });
      if (historyContainer) historyContainer.innerHTML = html;
    } catch (err) {
      console.error('Error loading history:', err);
      if (historyContainer) historyContainer.innerHTML = '<div class="no-history">Error loading history</div>';
    }
  };

  document.getElementById("withdrawForm")?.addEventListener("submit", async e => {
    e.preventDefault();
    
    const amount = parseFloat(document.getElementById("amountInput").value);
    const targetId = document.getElementById("idInput").value.trim();

    if (!amount || !targetId) { showSnack("Please complete all fields.", true); return; }
    if (amount < 1000) { showSnack("Minimum 1000 BUMS required", true); return; }
    if (amount > userBums) { showSnack("Insufficient BUMS balance!", true); return; }

    const reqObj = {
      user_id: userKey,
      method: "TON",
      coin: "BUMS",
      amount,
      payout: targetId,
      status: "pending",
      time: new Date().toISOString()
    };

    try {
      await push(ref(db, "withdraw_requests"), reqObj);
      await update(userRef, { bums: userBums - amount });
      showSnack("Withdraw request submitted!");
      await loadBalance();
      await loadWithdrawalHistory();
      document.getElementById("withdrawForm").reset();
      const ct = document.getElementById("conversionText");
      if (ct) ct.textContent = "You will receive: 0 TON";
      updateBalanceDisplay();
    } catch (err) {
      console.error(err);
      showSnack("Error submitting request!", true);
    }
  });

  // ========= TON Auto-Deposit =========
  const AUTO = {
    address: "UQB3O8XsvlpniZ-rsanNwLs1THLxYz1Uc5ucrBwlKS3X-dKE",
    pollMs: 5000,
    apiBase: "https://toncenter.com/api/v2/getTransactions",
    apiKey: ""
  };

  let processedSet = new Set();
  function utcDayKey(d = new Date()) {
    const y = d.getUTCFullYear();
    const m = String(d.getUTCMonth() + 1).padStart(2, "0");
    const da = String(d.getUTCDate()).padStart(2, "0");
    return `${y}-${m}-${da}`;
  }
  function loadProcessed() {
    try {
      const raw = localStorage.getItem("ton_proc_" + utcDayKey());
      if (raw) processedSet = new Set(JSON.parse(raw));
    } catch {}
  }
  function saveProcessed() {
    try { localStorage.setItem("ton_proc_" + utcDayKey(), JSON.stringify([...processedSet])); } catch {}
  }
  function rolloverIfNewDay() {
    const key = "ton_proc_key";
    const cur = utcDayKey();
    const prev = localStorage.getItem(key);
    if (cur !== prev) {
      localStorage.setItem(key, cur);
      processedSet = new Set();
      saveProcessed();
    }
  }

  function isTodayUTC(utimeSec) {
    const now = new Date();
    const start = Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 0,0,0,0) / 1000 | 0;
    const end   = Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 23,59,59,999) / 1000 | 0;
    const u = Number(utimeSec || 0);
    return u >= start && u <= end;
  }
  function txKey(tx) {
    const h = tx?.transaction_id?.hash;
    const lt = tx?.transaction_id?.lt || tx?.lt || 0;
    const u = Number(tx?.utime || tx?.now || 0);
    return h || `${u}_${lt}`;
  }
  function extractMemo(tx) {
    try {
      if (tx?.in_msg?.message) return String(tx.in_msg.message);
      if (tx?.in_msg?.msg_data?.text) return String(tx.in_msg.msg_data.text);
    } catch {}
    return "";
  }
  function parseUserIdFromMemo(memo) {
    const m = String(memo).trim();
    // Accept NOT_APP as valid user ID
    if (m === "NOT_APP") return m;
    if (/^\d{5,}$/.test(m)) return m;
    if (m.startsWith("@")) return m;
    return "";
  }

  async function claimTxOnce(txHash, claimData) {
    const claimRef = ref(db, `processed_txs/${txHash}`);
    const res = await runTransaction(claimRef, (cur) => {
      if (cur) return cur;
      return { ...claimData, at: Date.now() };
    });
    return res.committed === true;
  }
  async function incrementUserTonBalance(userId, amountTon) {
    const balRef = ref(db, `users/${userId}/ton_balance`);
    await runTransaction(balRef, (cur) => (parseFloat(cur) || 0) + amountTon);
  }
  async function writeUserCreditLog(userId, txHash, payload) {
    const logRef = ref(db, `users/${userId}/ton_credits/${txHash}`);
    await set(logRef, payload);
  }

  async function handleTransaction(tx) {
    const inVal = tx?.in_msg?.value;
    if (!inVal || parseInt(inVal) <= 0) return;
    const u = Number(tx?.utime || tx?.now || 0);
    if (!isTodayUTC(u)) return;
    const key = txKey(tx);
    if (processedSet.has(key)) return;
    const memoRaw = extractMemo(tx);
    const userId = parseUserIdFromMemo(memoRaw);
    if (!userId) { processedSet.add(key); saveProcessed(); return; }

    const amountTon = parseInt(inVal) / 1e9;
    const source = tx?.in_msg?.source || "unknown";
    const claimed = await claimTxOnce(key, { user_id: userId, amount_ton: amountTon, source, address: AUTO.address });
    if (!claimed) { processedSet.add(key); saveProcessed(); return; }

    await incrementUserTonBalance(userId, amountTon);
    await writeUserCreditLog(userId, key, { utime: u, amount_ton: amountTon, source, memo: memoRaw || "", address: AUTO.address });

    processedSet.add(key);
    saveProcessed();

    if (userId === userKey) {
      const tonBalSnap = await get(ref(db, `users/${userKey}/ton_balance`));
      const tonBalEl = document.getElementById("tonBalanceText");
      if (tonBalSnap.exists() && tonBalEl) {
        tonBalEl.textContent = `Your TON Balance: ${Number(tonBalSnap.val()).toFixed(6)} TON`;
      }
      showSnack(`Credited ${amountTon.toFixed(6)} TON`, false);
    }
  }

  let timer = null;
  let backoff = 0;
  async function pollOnce() {
    rolloverIfNewDay();
    const addr = AUTO.address;
    const status = document.getElementById("autoDepositStatus");
    if (!addr) { if (status) status.textContent = "Auto-deposit: address missing"; return; }

    const url = `${AUTO.apiBase}?address=${encodeURIComponent(addr)}&limit=20`;
    const headers = {};
    if (AUTO.apiKey) headers["X-Api-Key"] = AUTO.apiKey;

    const res = await fetch(url, { headers });
    const data = await res.json();
    if (!data?.ok || !Array.isArray(data?.result)) throw new Error("TON API error");

    for (const tx of data.result) {
      await handleTransaction(tx);
    }
    if (status) status.textContent = "Auto-deposit: ON";
  }
  function scheduleNext(ok) {
    if (ok) { backoff = 0; timer = setTimeout(loop, AUTO.pollMs); }
    else { backoff = Math.min((backoff || 1) * 2, 60000); timer = setTimeout(loop, AUTO.pollMs + backoff); }
  }
  async function loop() {
    try { await pollOnce(); scheduleNext(true); }
    catch (e) { console.error("auto-deposit error", e); const s=document.getElementById("autoDepositStatus"); if(s) s.textContent="Auto-deposit: retrying..."; scheduleNext(false); }
  }

  window.startAutoDeposit = function() {
    if (timer) return;
    loadProcessed();
    loop();
  };
  window.stopAutoDeposit = function() {
    if (timer) clearTimeout(timer);
    timer = null;
    const s = document.getElementById("autoDepositStatus");
    if (s) s.textContent = "Auto-deposit: OFF";
  };

  // Boot
  injectDepositStatus();
  await loadBalance();
  window.startAutoDeposit();
</script>
</body>
</html>
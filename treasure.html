<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>Treasure - Open the chest</title>
  <meta name="viewport" content="width=340, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      background:linear-gradient(135deg,#0f172a 0%,#111827 50%,#0b1220 100%);
      color:#fff;font-family:'Inter',Arial,sans-serif;min-height:100vh;overflow-x:hidden;font-size:14px
    }
    .container{width:340px;margin:0 auto;padding:16px 10px 96px 10px}

    .title{font-size:26px;font-weight:800;text-align:center;letter-spacing:.3px;margin-top:2px}
    .badges{display:flex;justify-content:center;gap:10px;margin:10px 0 8px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border-radius:999px;
      font-weight:800;font-size:13px;border:1px solid rgba(255,255,255,.14);box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)
    }
    .pill.keys{background:linear-gradient(135deg,#3f3f46,#1f2937)}
    .pill.tickets{background:linear-gradient(135deg,#1e293b,#0f172a)}
    .pill .icon{font-size:16px}

    .card{
      background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:18px;
      padding:16px 12px;box-shadow:0 14px 36px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
      margin-top:10px
    }
    .chest-wrap{display:grid;place-items:center;margin:12px 0 2px 0;position:relative}
    .glow{
      width:240px;height:240px;border-radius:50%;
      background:radial-gradient(ellipse at center, rgba(255,215,0,.18) 0%, rgba(255,215,0,0) 60%);
      filter:blur(6px);position:absolute;z-index:0;pointer-events:none;transform:translateY(6px)
    }
    .chest{width:180px;height:180px;display:grid;place-items:center;position:relative;z-index:1;cursor:pointer}
    .chest-emoji{font-size:140px;filter:drop-shadow(0 12px 24px rgba(0,0,0,.45));transition:transform .12s ease}
    .chest:active .chest-emoji{transform:scale(.99)}
    .shake{animation:shake .9s cubic-bezier(.36,.07,.19,.97) both}
    @keyframes shake{
      10%,90%{transform:translateX(-1px)}
      20%,80%{transform:translateX(2px)}
      30%,50%,70%{transform:translateX(-4px)}
      40%,60%{transform:translateX(4px)}
    }
    .tap{text-align:center;color:#cbd5e1;margin:10px 0 2px 0;letter-spacing:.4px}

    .possible{margin-top:14px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:12px}
    .possible-title{font-weight:800;margin-bottom:8px;font-size:15px}
    .row{display:flex;gap:10px;justify-content:space-between}
    .box{flex:1;display:grid;place-items:center;gap:6px;padding:12px;border-radius:12px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08)}
    .box .ico{font-size:20px}
    .box .cap{font-size:12px;color:#cbd5e1}

    #snackbar{display:none;position:fixed;top:18px;left:50%;transform:translateX(-50%);background:#059669;color:#fff;padding:10px 18px;border-radius:22px;z-index:2001;font-weight:800;box-shadow:0 6px 16px rgba(5,150,105,.35)}
    #snackbar.error{background:#ef4444}

    /* Bottom navigation */
    .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 340px; background: rgba(0,0,0,0.9); backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.1); border-radius: 20px 20px 0 0; padding: 16px 8px; display: flex; justify-content: space-around; align-items: center; z-index: 100; }
    .nav-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 6px 4px; border-radius: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); min-width: 45px; flex: 1; margin: 0 2px; transition: all 0.2s; }
    .nav-item:hover { background: rgba(255,255,255,0.1); transform: translateY(-2px); }
    .nav-icon { width: 20px; height: 20px; margin-bottom: 3px; background: #fff; mask-size: contain; mask-repeat: no-repeat; mask-position: center; }
    .nav-home .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m3 12 2-2m0 0 7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6'/%3E%3C/svg%3E"); }
    .nav-ads .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z'/%3E%3C/svg%3E"); }
    .nav-refer .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z'/%3E%3C/svg%3E"); }
    .nav-task .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'/%3E%3C/svg%3E"); }
    .nav-wallet .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z'/%3E%3C/svg%3E"); }
    .nav-label { font-size: 0.65em; font-weight: 500; color: #e0e0e0; text-transform: uppercase; letter-spacing: 0.3px; }

    #snackbar { display: none; position: fixed; top: 18px; left: 50%; transform: translateX(-50%); background: #059669; color: white; padding: 12px 24px; border-radius: 24px; z-index: 2001; font-weight: 600; font-size: 1em; box-shadow: 0 4px 16px rgba(5,150,105,0.4); transition: opacity 0.4s; opacity: 1; letter-spacing: 0.5px; }
    #snackbar.error { background: #ef4444; box-shadow: 0 4px 16px rgba(239,68,68,0.4); }

    @media (max-width: 360px) { .container { width: 100%; padding: 10px 5px 90px 5px; } .bottom-nav { width: 100%; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="title">Open the chest</div>

    <div class="badges">
      <div class="pill keys"><span class="count" id="keyCount">0</span><span class="icon">üîë</span></div>
      <div class="pill tickets"><span class="count" id="ticketCount">0</span><span class="icon">üéüÔ∏è</span></div>
    </div>

    <div class="card">
      <div class="chest-wrap">
        <div class="glow"></div>
        <div class="chest" id="chest"><div class="chest-emoji" id="chestEmoji">üéÅ</div></div>
      </div>
      <div class="tap">Tap to Open</div>

      <div class="possible">
        <div class="possible-title">Possible treasures</div>
        <div class="row">
          <div class="box"><div class="ico">üí∞</div><div class="cap">BUMS</div></div>
          <div class="box"><div class="ico">üéüÔ∏è</div><div class="cap">Ticket</div></div>
          <div class="box"><div class="ico">üéØ</div><div class="cap">Spin</div></div>
        </div>
      </div>
    </div>
  </div>

  <div id="snackbar"></div>

  <!-- Bottom navigation (active: Home) -->
  <div class="bottom-nav">
    <div class="nav-item nav-home" onclick="window.location.href='index.html'">
      <div class="nav-icon"></div><span class="nav-label">Home</span>
    </div>
    <div class="nav-item nav-ads" onclick="window.location.href='ads.html'">
      <div class="nav-icon"></div><span class="nav-label">Ads</span>
    </div>
    <div class="nav-item nav-refer" onclick="window.location.href='refer.html'">
      <div class="nav-icon"></div><span class="nav-label">Refer</span>
    </div>
    <div class="nav-item nav-task" onclick="window.location.href='tasks.html'">
      <div class="nav-icon"></div><span class="nav-label">Tasks</span>
    </div>
    <div class="nav-item nav-wallet" onclick="window.location.href='wallet.html'">
      <div class="nav-icon"></div><span class="nav-label">Wallet</span>
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, get, set, runTransaction } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    function toast(msg, isError=false){
      const el = document.getElementById('snackbar');
      el.textContent = msg;
      el.className = isError ? 'error' : '';
      el.style.display = 'block';
      setTimeout(()=>{ el.style.display='none'; }, isError ? 3600 : 2400);
    }

    const firebaseConfig = {
      apiKey: "AIzaSyBv4V4zPlUlbotICs5JVVJVfeZ_wesBCQI",
      authDomain: "momey-bims.firebaseapp.com",
      databaseURL: "https://momey-bims-default-rtdb.firebaseio.com",
      projectId: "momey-bims",
      storageBucket: "momey-bims.firebasestorage.app",
      messagingSenderId: "21496105095",
      appId: "1:21496105095:web:cbd7b39dada8f0b671d022",
      measurementId: "G-ECE8ZBS23B"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    window.Telegram?.WebApp?.ready?.();
    const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
    const userKey = tgUser?.id ? String(tgUser.id) : "UNKNOWN_USER";

    const elKey   = document.getElementById('keyCount');
    const elTick  = document.getElementById('ticketCount');
    const chest   = document.getElementById('chest');

    async function loadBalances(){
      const keyRef   = ref(db, 'users/'+userKey+'/key');
      const ticketRef= ref(db, 'users/'+userKey+'/ticket');
      const spinRef  = ref(db, 'users/'+userKey+'/spin');
      const bumsRef  = ref(db, 'users/'+userKey+'/bums');

      const [kS,tS,sS,bS] = await Promise.all([get(keyRef),get(ticketRef),get(spinRef),get(bumsRef)]);
      if(!kS.exists()) await set(keyRef,0);
      if(!tS.exists()) await set(ticketRef,0);
      if(!sS.exists()) await set(spinRef,0);
      if(!bS.exists()) await set(bumsRef,0);

      elKey.textContent  = String(kS.exists() ? (kS.val() ?? 0) : 0);
      elTick.textContent = String(tS.exists() ? (tS.val() ?? 0) : 0);
    }

    async function spendOneKey(){
      const keyRef = ref(db, `users/${userKey}/key`);
      let snap = await get(keyRef);
      let start = Number(snap.val() ?? 0);
      if (!Number.isFinite(start)) start = parseInt(snap.val(),10) || 0;
      if (start <= 0) throw new Error('NO_KEYS');

      const attempt = () => runTransaction(keyRef, cur => {
        let v = Number(cur ?? 0);
        if (!Number.isFinite(v)) v = parseInt(cur,10) || 0;
        return v > 0 ? v - 1 : v; // never undefined
      });

      let res = await attempt();
      if (!res.committed) {
        res = await attempt();
        if (!res.committed) throw new Error('KEY_RETRY_ABORT');
      }
      return Number(res.snapshot.val() ?? 0);
    }

    async function addBums(amount){
      const r = ref(db, 'users/'+userKey+'/bums');
      await runTransaction(r, cur => Number(cur ?? 0) + Number(amount));
    }
    async function addTicket(cnt=1){
      const r = ref(db, 'users/'+userKey+'/ticket');
      const res = await runTransaction(r, cur => Number(cur ?? 0) + Number(cnt));
      elTick.textContent = String(res.snapshot.val() ?? 0);
    }
    async function addSpin(cnt=1){
      const r = ref(db, 'users/'+userKey+'/spin');
      await runTransaction(r, cur => Number(cur ?? 0) + Number(cnt));
    }

    const REWARDS = [
      {type:'BUMS',   value:5,  weight:28},
      {type:'BUMS',   value:10, weight:22},
      {type:'BUMS',   value:20, weight:12},
      {type:'TICKET', value:1,  weight:18},
      {type:'SPIN',   value:1,  weight:20},
    ];
    function pickReward(){
      const total = REWARDS.reduce((a,r)=>a+r.weight,0);
      let roll = Math.random()*total;
      for (const r of REWARDS){ if ((roll -= r.weight) <= 0) return r; }
      return REWARDS[0];
    }

    let opening = false;
    chest.addEventListener('click', async ()=>{
      if (opening) return;
      try{
        const left = await spendOneKey();
        elKey.textContent = String(left);

        opening = true;
        chest.classList.add('shake');

        setTimeout(async ()=>{
          const prize = pickReward();
          if (prize.type === 'BUMS') { await addBums(prize.value); toast(`üéâ +${prize.value} BUMS`); }
          else if (prize.type === 'TICKET') { await addTicket(prize.value); toast(`üéüÔ∏è +${prize.value} Ticket`); }
          else { await addSpin(prize.value); toast(`üéØ +${prize.value} Spin`); }
          chest.classList.remove('shake');
          opening = false;
        }, 900);
      }catch(e){
        if (e.message === 'NO_KEYS') toast('No keys available', true);
        else { console.error(e); toast('Open failed', true); }
      }
    });

    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', loadBalances);
    } else {
      loadBalances();
    }
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>Tasks - BUMS</title>
  <meta name="viewport" content="width=340, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:linear-gradient(135deg,#0b1224 0%,#0f1e3a 50%,#081224 100%);color:#fff;font-family:'Inter',Arial,sans-serif;min-height:100vh;overflow-x:hidden;font-size:13px}
    .wrap{width:340px;margin:0 auto;padding:12px 8px 100px 8px}

    .title{font-weight:800;font-size:18px;margin:6px 2px 10px}

    .task-card{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px;border-radius:14px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);box-shadow:0 8px 22px rgba(0,0,0,.35);margin-bottom:10px}
    .t-left{display:flex;align-items:center;gap:10px}
    .t-ico{width:30px;height:30px;border-radius:10px;background:rgba(255,255,255,.08);position:relative}
    .t-ico::before{content:"";position:absolute;inset:0;margin:auto;width:18px;height:18px;background:#fff;mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 11l9-9 9 9M5 9v10a2 2 0 0 0 2 2h3m7-12v10a2 2 0 0 1-2 2h-3" stroke="%23000" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>') center/contain no-repeat}
    .t-text{display:flex;flex-direction:column}
    .t-name{font-weight:800;letter-spacing:.2px}
    .t-rew{margin-top:3px}
    .pill{display:inline-block;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);padding:4px 8px;border-radius:10px;font-weight:700;color:#ffd479}

    .t-right{display:flex;align-items:center;gap:8px}
    .btn{border:none;border-radius:10px;padding:8px 12px;font-weight:800;color:#fff;cursor:pointer;border:1px solid rgba(255,255,255,.15)}
    .go{background:linear-gradient(135deg,#60a5fa,#3b82f6)}
    .claim{background:linear-gradient(135deg,#22c55e,#16a34a)}
    .done{background:rgba(255,255,255,.1);color:#cfd6e6;cursor:not-allowed}
    .counter{min-width:42px;text-align:center;font-weight:800;color:#a5b4fc;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);padding:6px 8px;border-radius:10px}

    .empty{opacity:.9;font-size:12px;border:1px dashed rgba(255,255,255,.22);border-radius:12px;padding:12px;text-align:center;letter-spacing:.4px}

    /* Toast */
    .toast{position:fixed;top:10px;left:50%;transform:translateX(-50%) translateY(-20px);background:rgba(34,197,94,.95);color:#071b0f;border:1px solid rgba(34,197,94,.6);padding:10px 14px;border-radius:14px;font-weight:800;letter-spacing:.3px;box-shadow:0 10px 28px rgba(0,0,0,.35);opacity:0;z-index:120;transition:all .25s ease}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

    /* Bottom nav (Home-style) */
    .bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:340px;background:rgba(0,0,0,.9);backdrop-filter:blur(20px);border-top:1px solid rgba(255,255,255,.1);border-radius:20px 20px 0 0;padding:16px 12px;display:flex;justify-content:space-around;align-items:center;z-index:100}
    .nav-item{display:flex;flex-direction:column;align-items:center;cursor:pointer;padding:8px 8px;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);min-width:50px;flex:1;margin:0 2px;transition:transform .2s ease, background .2s ease}
    .nav-item:hover{background:rgba(255,255,255,.1);transform:translateY(-2px)}
    .nav-item.active{background:rgba(102,126,234,.2);border-color:rgba(102,126,234,.3)}
    .nav-icon{width:22px;height:22px;margin-bottom:4px;background:#fff;mask-size:contain;mask-repeat:no-repeat;mask-position:center}
    .nav-home .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m3 12 2-2m0 0 7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6'/%3E%3C/svg%3E")}
    .nav-invite .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7M16 6l-4-4-4 4M12 2v14' stroke='currentColor' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E")}
    .nav-task .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'/%3E%3C/svg%3E")}
    .nav-ads .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z'/%3E%3C/svg%3E")}
    .nav-wallet .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z'/%3E%3C/svg%3E")}
    .nav-label{font-size:.7em;font-weight:500;color:#e0e0e0;text-transform:uppercase;letter-spacing:.3px}

    @media(max-width:360px){
      .container{width:100%;padding:7px 3px 90px 3px}
      .bottom-nav{width:100%}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">Available tasks</div>
    <div id="taskList"></div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Bottom nav -->
  <div class="bottom-nav">
    <div class="nav-item nav-home" onclick="window.location.href='index.html'">
      <div class="nav-icon"></div><span class="nav-label">Home</span>
    </div>
    <div class="nav-item nav-invite" onclick="window.location.href='invite.html'">
      <div class="nav-icon"></div><span class="nav-label">Invite</span>
    </div>
    <div class="nav-item nav-task active" onclick="window.location.href='tasks.html'">
      <div class="nav-icon"></div><span class="nav-label">Tasks</span>
    </div>
    <div class="nav-item nav-ads" onclick="window.location.href='ads.html'">
      <div class="nav-icon"></div><span class="nav-label">Ads</span>
    </div>
    <div class="nav-item nav-wallet" onclick="window.location.href='wallet.html'">
      <div class="nav-icon"></div><span class="nav-label">Wallet</span>
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, get, set, update, runTransaction } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

// 🔥 Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyALUr9fR5GE5CxPwY2xdYcIEvy33nu4vbs",
  authDomain: "money-bums-c9eba.firebaseapp.com",
  databaseURL: "https://money-bums-c9eba-default-rtdb.firebaseio.com",
  projectId: "money-bums-c9eba",
  storageBucket: "money-bums-c9eba.firebasestorage.app",
  messagingSenderId: "759031341495",
  appId: "1:759031341495:web:e9d2f9a7ec124e0a524832",
  measurementId: "G-XWHHSQHPP9"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// 🧩 Telegram UID
function getTelegramUser() {
  try {
    const tg = window.Telegram?.WebApp;
    tg?.ready?.();
    const u = tg?.initDataUnsafe?.user;
    if (u?.id) return u;
  } catch {}
  try {
    const parse = (src) => {
      const sp = new URLSearchParams(src);
      const raw = sp.get("tgWebAppData") || sp.get("tgwebappdata");
      if (!raw) return null;
      const inner = new URLSearchParams(raw);
      const s = inner.get("user");
      return s ? JSON.parse(s) : null;
    };
    const h = location.hash ? parse(location.hash.slice(1)) : null;
    if (h?.id) return h;
    const q = parse(location.search.slice(1));
    if (q?.id) return q;
  } catch {}
  return { id: "NOT_APP" };
}
const UID = String(getTelegramUser()?.id || "NOT_APP");

// 🔔 Toast popup
function toast(msg) {
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.classList.add("show");
  setTimeout(() => el.classList.remove("show"), 1600);
  try {
    window.Telegram?.WebApp?.HapticFeedback?.notificationOccurred?.("success");
  } catch {}
}

// 🧾 Ensure user exists
async function ensureUser() {
  const uref = ref(db, `users/${UID}`);
  const s = await get(uref);
  if (!s.exists()) {
    await set(uref, {
      balance: 0,
      ton_balance: 0,
      earnings_total: 0,
      referEarn: 0,
      createdAt: Date.now()
    });
  } else {
    const v = s.val() || {};
    const patch = {};
    if (v.balance === undefined) patch.balance = 0;
    if (v.referEarn === undefined) patch.referEarn = 0;
    if (Object.keys(patch).length) await update(uref, patch);
  }
}
ensureUser();

// 🎯 UI Elements
const listEl = document.getElementById("taskList");
const timers = new Map();

// 🧱 Task Card Template
function row(t) {
  const btnId = `btn_${t.id}`,
    cntId = `cnt_${t.id}`;
  return `
  <div class="task-card" data-id="${t.id}">
    <div class="t-left">
      <div class="t-ico"></div>
      <div class="t-text">
        <div class="t-name">${t.taskName || "TASK"}</div>
        <div class="t-rew"><span class="pill">+ 15 BUMS</span></div>
      </div>
    </div>
    <div class="t-right">
      <div class="counter" id="${cntId}" style="display:none">8s</div>
      <button class="btn go" id="${btnId}">GO</button>
    </div>
  </div>`;
}

// 🔗 Open Telegram / Web Link
function openLink(link) {
  if (!link) return;
  if (link.startsWith("@")) {
    location.href = "https://t.me/" + link.slice(1);
    return;
  }
  if (/^https?:\/\//i.test(link)) {
    location.href = link;
    return;
  }
  location.href = "https://t.me/" + String(link || "").replace(/^@/, "");
}

// ⏳ Task Timer
function startTimer(task) {
  const btn = document.getElementById(`btn_${task.id}`);
  const cnt = document.getElementById(`cnt_${task.id}`);
  if (!btn || !cnt) return;
  btn.style.display = "none";
  cnt.style.display = "";
  let left = 8;
  cnt.textContent = left + "s";
  const iv = setInterval(() => {
    left--;
    cnt.textContent = (left > 0 ? left : 0) + "s";
    if (left <= 0) {
      clearInterval(iv);
      timers.delete(task.id);
      cnt.style.display = "none";
      btn.textContent = "CLAIM";
      btn.classList.remove("go");
      btn.classList.add("claim");
      btn.style.display = "";
      btn.disabled = false;
      btn.onclick = () => claim(task);
    }
  }, 1000);
  timers.set(task.id, { left, intervalId: iv });
}

// 💰 Claim Reward + Refer System
async function claim(task) {
  const claimRef = ref(db, `task_claims/${task.id}/${UID}`);
  const first = await runTransaction(claimRef, (cur) => (cur ? cur : true));
  if (!first.committed || first.snapshot.val() !== true) {
    toast("Already claimed");
    return;
  }

  // limit check
  const compRef = ref(db, `tasks/${task.id}/currentCompletions`);
  const inc = await runTransaction(compRef, (cur) => {
    const c = Number(cur || 0),
      max = Number(task.maxCompletions || task.maxUsers || 0);
    if (c >= max) return;
    return c + 1;
  });
  if (!inc.committed) {
    toast("Slots filled");
    await set(claimRef, null);
    return;
  }

  // 🎁 User reward: 2 BUMS
  const reward = 15;
  await runTransaction(ref(db, `users/${UID}/balance`), (cur) => Number(cur || 0) + reward);

  // 🧩 Referral reward (50%)
  const userRef = ref(db, `users/${UID}`);
  const userSnap = await get(userRef);
  const userData = userSnap.val() || {};
  const referrer = userData.referBy;
  if (referrer) {
    const refEarnRef = ref(db, `users/${referrer}/referEarn`);
    const refBonus = reward * 0.5; // 50% of reward = 1 BUMS
    await runTransaction(refEarnRef, (cur) => Number(cur || 0) + refBonus);
  }

  toast("Claimed +15 BUMS");
  const b = document.getElementById(`btn_${task.id}`);
  if (b) {
    b.textContent = "CLAIMED";
    b.classList.add("done");
    b.disabled = true;
  }
}

// 📦 Load Tasks
function load() {
  onValue(ref(db, "tasks"), async (snap) => {
    const all = snap.val() || {};
    const tasks = Object.values(all)
      .filter((t) => String(t?.status || "active") === "active" && t?.link)
      .sort((a, b) => Number(b.createdAt || 0) - Number(a.createdAt || 0));

    if (!tasks.length) {
      listEl.innerHTML = `<div class="empty">NOT TASK AVAILABLE</div>`;
      return;
    }

    listEl.innerHTML = tasks.map(row).join("");

    for (const t of tasks) {
      const btn = document.getElementById(`btn_${t.id}`);
      const claimedSnap = await get(ref(db, `task_claims/${t.id}/${UID}`));
      const claimed = !!claimedSnap.val();
      const cur = Number(t.currentCompletions || 0),
        max = Number(t.maxCompletions || t.maxUsers || 0),
        filled = max > 0 && cur >= max;

      if (claimed) {
        btn.textContent = "CLAIMED";
        btn.classList.add("done");
        btn.disabled = true;
      } else if (filled) {
        btn.textContent = "FILLED";
        btn.classList.add("done");
        btn.disabled = true;
      } else {
        btn.onclick = () => {
          openLink(t.link);
          btn.disabled = true;
          startTimer(t);
        };
      }
    }
  });
}
load();
</script>
</body>
</html>

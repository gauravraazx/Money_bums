<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>Tickets ‚Äî Weekly Draw</title>
  <meta name="viewport" content="width=340, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      background:linear-gradient(135deg,#0b1020 0%,#121729 50%,#0e1f3f 100%);
      color:#fff;font-family:'Inter',Arial,sans-serif;min-height:100vh;overflow-x:hidden;font-size:14px
    }
    .container{width:340px;margin:0 auto;padding:15px 10px 100px 10px}
    .header{background:linear-gradient(135deg,#667eea,#764ba2);border-radius:12px;padding:12px;text-align:center;margin-bottom:12px;border:1px solid rgba(255,255,255,.1);box-shadow:0 8px 32px rgba(102,126,234,.3)}
    .header-title{font-weight:800;letter-spacing:.5px;font-size:.95em}
    .inv-wrap{display:flex;align-items:center;justify-content:space-between;gap:10px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px 12px;margin-bottom:14px}
    .inv-badge{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:6px 10px;display:flex;align-items:center;gap:8px;min-width:90px;justify-content:center}
    .get-btn{background:#fff;color:#111;border:none;padding:8px 14px;border-radius:10px;font-weight:700;cursor:pointer;transition:all .2s}
    .get-btn:hover{transform:scale(1.05);box-shadow:0 4px 12px rgba(255,255,255,.3)}
    .card{background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:14px;box-shadow:0 6px 24px rgba(0,0,0,.35);margin-bottom:14px}
    .card h3{font-size:1.05em;font-weight:800;margin-bottom:10px}
    .row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.06)}
    .row:last-child{border-bottom:none}
    .k{color:#aab3c9;font-weight:600}
    .v{font-weight:800;letter-spacing:.3px}
    .accent{color:#4ade80}
    .warn{color:#fbbf24}
    .muted{color:#cfd6e6}
    .inline-input{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:8px 10px;margin-top:10px}
    .btn-round{width:32px;height:32px;border-radius:8px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.1);color:#fff;font-weight:900;cursor:pointer;transition:all .2s}
    .btn-round:hover{background:rgba(255,255,255,.2);transform:scale(1.1)}
    .btn-round:active{transform:scale(.95)}
    .qty{flex:1;text-align:center;font-weight:800;font-size:1em;border:none;outline:none;background:transparent;color:#fff}
    .primary{margin-top:12px;width:100%;background:linear-gradient(135deg,#22c55e,#16a34a);border:none;color:#fff;font-weight:800;padding:10px 12px;border-radius:10px;cursor:pointer;box-shadow:0 6px 16px rgba(34,197,94,.3);transition:all .2s}
    .primary:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(34,197,94,.4)}
    .primary:active{transform:translateY(0)}
    .subtle{font-size:.85em;color:#b7c0d8;margin-top:6px;text-align:center}
    #snackbar{display:none;position:fixed;top:18px;left:50%;transform:translateX(-50%);background:#059669;color:#fff;padding:12px 24px;border-radius:24px;z-index:2001;font-weight:700;box-shadow:0 4px 16px rgba(5,150,105,.4)}
    #snackbar.error{background:#ef4444}

    .ad-section{margin-top:16px}
    .section-header{
      display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;
      padding:10px 12px;background:rgba(251,191,36,.1);border:1px solid rgba(251,191,36,.3);
      border-radius:12px
    }
    .section-title{font-weight:800;font-size:16px;color:#fbbf24;display:flex;align-items:center;gap:8px}
    .section-info{font-size:11px;color:#cbd5e1;background:rgba(0,0,0,.3);padding:4px 8px;border-radius:8px}

    .ad-grid{display:flex;flex-direction:column;gap:12px}

    .compact-ad-box {
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.1);
      border-radius: 14px;
      padding: 12px;
      transition: all .3s ease;
    }

    .compact-ad-box:hover {
      border-color: rgba(59,130,246,.4);
      transform: translateY(-2px);
    }

    .compact-ad-box.completed {
      border-color: rgba(16,185,129,.5);
      background: rgba(16,185,129,.08);
      box-shadow: 0 0 20px rgba(16,185,129,.2);
    }

    .compact-ad-box.locked {
      border-color: rgba(239,68,68,.5);
      background: rgba(239,68,68,.08);
    }

    .compact-ad-box.completed .ad-text {
      color: #10b981;
    }

    .compact-ad-box.locked .ad-text {
      color: #ef4444;
    }

    .compact-ad-content {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px;
      background: rgba(255,255,255,.03);
      border-radius: 10px;
    }

    .ad-text {
      font-weight: 600;
      font-size: 14px;
      color: #fbbf24;
      white-space: nowrap;
      min-width: 140px;
    }

    .ad-progress {
      font-size: 14px;
      font-weight: 600;
      color: #10b981;
      background: rgba(16,185,129,.15);
      padding: 6px 12px;
      border-radius: 12px;
      border: 1px solid rgba(16,185,129,.3);
    }

    .ad-progress.complete {
      background: rgba(16,185,129,.25);
      animation: pulse 2s infinite;
    }

    .play-btn {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      border: none;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .2s;
      color: white;
      font-size: 24px;
    }

    .play-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(59,130,246,.4);
    }

    .play-btn:active {
      transform: scale(1);
    }

    .play-btn:disabled {
      background: linear-gradient(135deg, #64748b, #475569);
      cursor: not-allowed;
      opacity: .6;
    }

    .play-btn.claim {
      background: linear-gradient(135deg, #10b981, #059669);
      animation: glow 2s ease-in-out infinite;
    }

    .play-btn.claim:hover {
      box-shadow: 0 4px 12px rgba(16,185,129,.5);
    }

    .play-btn.locked {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      cursor: not-allowed;
    }

    .cooldown-text {
      font-size: 11px;
      color: #fbbf24;
      margin-top: 4px;
      text-align: center;
      font-weight: 600;
    }

    .ad-stats{
      display:flex;justify-content:space-between;margin-top:8px;
      padding-top:8px;border-top:1px solid rgba(255,255,255,.1);
      font-size:11px;color:#94a3b8
    }

    .bottom-nav { 
      position: fixed; 
      bottom: 0; 
      left: 50%; 
      transform: translateX(-50%); 
      width: 340px; 
      background: rgba(0,0,0,0.9); 
      backdrop-filter: blur(20px); 
      border-top: 1px solid rgba(255,255,255,0.1); 
      border-radius: 20px 20px 0 0; 
      padding: 16px 8px; 
      display: flex; 
      justify-content: space-around; 
      align-items: center; 
      z-index: 100; 
    }
    .nav-item { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      cursor: pointer; 
      padding: 6px 4px; 
      border-radius: 10px; 
      background: rgba(255,255,255,0.05); 
      border: 1px solid rgba(255,255,255,0.1); 
      min-width: 45px; 
      flex: 1; 
      margin: 0 2px; 
      transition: all 0.2s; 
    }
    .nav-item:hover { 
      background: rgba(255,255,255,0.1); 
      transform: translateY(-2px); 
    }
    .nav-icon { 
      width: 20px; 
      height: 20px; 
      margin-bottom: 3px; 
      background: #fff; 
      mask-size: contain; 
      mask-repeat: no-repeat; 
      mask-position: center; 
    }
    .nav-home .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m3 12 2-2m0 0 7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6'/%3E%3C/svg%3E"); }
    .nav-win .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='currentColor' d='M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z'/%3E%3C/svg%3E"); }
    .nav-ads .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z'/%3E%3C/svg%3E"); }
    .nav-refer .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z'/%3E%3C/svg%3E"); }
    .nav-task .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'/%3E%3C/svg%3E"); }
    .nav-wallet .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 00-3 3z'/%3E%3C/svg%3E"); }
    .nav-label { font-size: 0.65em; font-weight: 500; color: #e0e0e0; text-transform: uppercase; letter-spacing: 0.3px; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: .7; }
    }

    @keyframes glow {
      0%, 100% { box-shadow: 0 0 5px rgba(16,185,129,.5); }
      50% { box-shadow: 0 0 20px rgba(16,185,129,.8); }
    }

    @media (max-width: 360px) { 
      .container { width: 100%; padding: 10px 5px 110px 5px; } 
      .bottom-nav { width: 100%; } 
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header"><div class="header-title" id="header-username">Loading...</div></div>

    <!-- Inventory + Get -->
    <div class="inv-wrap">
      <div class="inv-badge"><span id="inv-tickets">0</span><span>üéüÔ∏è</span></div>
      <button class="get-btn" id="btn-get">Get</button>
    </div>

    <!-- Weekly draw card -->
    <div class="card">
      <h3>Take part in the weekly drawing ?</h3>
      <div class="row"><span class="k">Winners</span><span class="v" id="winners">2</span></div>
      <div class="row">
        <span class="k">Rewards</span>
        <span class="v"><span id="reward-desc">0.1 TON each (total 0.2 TON)</span></span>
      </div>
      <div class="row"><span class="k">Tickets</span><span class="v" id="total-tickets">0 üéüÔ∏è</span></div>
      <div class="row"><span class="k">My tickets</span><span class="v" id="my-tickets">0 üéüÔ∏è</span></div>
      <div class="row"><span class="k">Chance of winning</span><span class="v accent" id="win-chance">0.00 %</span></div>
      <div class="row"><span class="k">Results</span><span class="v warn" id="results-at">‚Äî</span></div>

      <div class="inline-input">
        <button class="btn-round" id="minus">‚àí</button>
        <input class="qty" id="qty" type="number" min="1" step="1" value="1" />
        <button class="btn-round" id="plus">+</button>
      </div>
      <button class="primary" id="btn-enter">Enter draw</button>
      <div class="subtle">Tickets will be deducted from your inventory and added to this round.</div>
    </div>

    <!-- Ad Boxes Section -->
    <div class="card ad-section">
      <div class="section-header">
        <div class="section-title">
          <span>üé•</span>
          <span>Watch Ads & Earn Tickets</span>
        </div>
        <div class="section-info">30 Ads = 1 üéüÔ∏è</div>
      </div>
      
      <div class="ad-grid">
        <div class="compact-ad-box" id="adBox1">
          <div class="compact-ad-content">
            <div class="ad-text">Watch 30 ads<br>and get 1 üéüÔ∏è</div>
            <div class="ad-progress" id="progress1">0/30</div>
            <button class="play-btn" id="adBtn1" onclick="watchAd(1)">‚ñ∂Ô∏è</button>
          </div>
          <div class="ad-stats">
            <span id="watched1">Watched: 0</span>
            <span id="remaining1">Remaining: 30</span>
          </div>
          <div class="cooldown-text" id="cooldown1" style="display:none;"></div>
        </div>

        <div class="compact-ad-box" id="adBox2">
          <div class="compact-ad-content">
            <div class="ad-text">Watch 30 ads<br>and get 1 üéüÔ∏è</div>
            <div class="ad-progress" id="progress2">0/30</div>
            <button class="play-btn" id="adBtn2" onclick="watchAd(2)">‚ñ∂Ô∏è</button>
          </div>
          <div class="ad-stats">
            <span id="watched2">Watched: 0</span>
            <span id="remaining2">Remaining: 30</span>
          </div>
          <div class="cooldown-text" id="cooldown2" style="display:none;"></div>
        </div>

        <div class="compact-ad-box" id="adBox3">
          <div class="compact-ad-content">
            <div class="ad-text">Watch 30 ads<br>and get 1 üéüÔ∏è</div>
            <div class="ad-progress" id="progress3">0/30</div>
            <button class="play-btn" id="adBtn3" onclick="watchAd(3)">‚ñ∂Ô∏è</button>
          </div>
          <div class="ad-stats">
            <span id="watched3">Watched: 0</span>
            <span id="remaining3">Remaining: 30</span>
          </div>
          <div class="cooldown-text" id="cooldown3" style="display:none;"></div>
        </div>

        <div class="compact-ad-box" id="adBox4">
          <div class="compact-ad-content">
            <div class="ad-text">Watch 30 ads<br>and get 1 üéüÔ∏è</div>
            <div class="ad-progress" id="progress4">0/30</div>
            <button class="play-btn" id="adBtn4" onclick="watchAd(4)">‚ñ∂Ô∏è</button>
          </div>
          <div class="ad-stats">
            <span id="watched4">Watched: 0</span>
            <span id="remaining4">Remaining: 30</span>
          </div>
          <div class="cooldown-text" id="cooldown4" style="display:none;"></div>
        </div>

        <div class="compact-ad-box" id="adBox5">
          <div class="compact-ad-content">
            <div class="ad-text">Watch 30 ads<br>and get 1 üéüÔ∏è</div>
            <div class="ad-progress" id="progress5">0/30</div>
            <button class="play-btn" id="adBtn5" onclick="watchAd(5)">‚ñ∂Ô∏è</button>
          </div>
          <div class="ad-stats">
            <span id="watched5">Watched: 0</span>
            <span id="remaining5">Remaining: 30</span>
          </div>
          <div class="cooldown-text" id="cooldown5" style="display:none;"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="snackbar"></div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <div class="nav-item nav-home" onclick="window.location.href='index.html'">
      <div class="nav-icon"></div><span class="nav-label">Home</span>
    </div>
    <div class="nav-item nav-win" onclick="window.location.href='win.html'">
      <div class="nav-icon"></div><span class="nav-label">Win</span>
    </div>
    <div class="nav-item nav-ads" onclick="window.location.href='ads.html'">
      <div class="nav-icon"></div><span class="nav-label">Ads</span>
    </div>
    <div class="nav-item nav-refer" onclick="window.location.href='refer.html'">
      <div class="nav-icon"></div><span class="nav-label">Refer</span>
    </div>
    <div class="nav-item nav-task" onclick="window.location.href='tasks.html'">
      <div class="nav-icon"></div><span class="nav-label">Tasks</span>
    </div>
    <div class="nav-item nav-wallet" onclick="window.location.href='wallet.html'">
      <div class="nav-icon"></div><span class="nav-label">Wallet</span>
    </div>
  </div>

  <script src="https://libtl.com/sdk.js" data-zone="10005741" data-sdk="show_10005741"></script>
  <script src="https://telegram.org/js/telegram-web-app.js?56"></script>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getDatabase, ref, get, set, update, runTransaction } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  // ============== UTILITY FUNCTIONS ==============
  function toast(msg, err = false) {
    const el = document.getElementById('snackbar');
    if (!el) return;
    el.textContent = msg;
    el.className = err ? 'error' : '';
    el.style.display = 'block';
    setTimeout(() => { el.style.display = 'none'; }, err ? 4000 : 3000);
  }

  const $ = (id) => document.getElementById(id);

  function getTodayDate() {
    return new Date().toISOString().split('T')[0];
  }

  // ============== FIREBASE CONFIG ==============
  const firebaseConfig = {
    apiKey: "AIzaSyBv4V4zPlUlbotICs5JVVJVfeZ_wesBCQI",
    authDomain: "momey-bims.firebaseapp.com",
    databaseURL: "https://momey-bims-default-rtdb.firebaseio.com",
    projectId: "momey-bims",
    storageBucket: "momey-bims.firebasestorage.app",
    messagingSenderId: "21496105095",
    appId: "1:21496105095:web:cbd7b39dada8f0b671d022",
    measurementId: "G-ECE8ZBS23B"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ============== TELEGRAM SETUP ==============
  window.Telegram?.WebApp?.ready?.();
  const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
  const uid = tgUser ? String(tgUser.id) : "TEST_USER_" + Math.floor(Math.random() * 10000);
  const uname = tgUser?.username ? "@" + tgUser.username : (tgUser ? ("ID:" + tgUser.id) : "UNKNOWN_USER");

  document.getElementById('header-username').textContent = uname;

  // ============== CONSTANTS ==============
  const WINNERS_COUNT = 2;
  const TON_PER_WINNER = 0.1;
  const TON_TOTAL = 0.2;
  const AD_BOXES = 5;
  const ADS_REQUIRED = 30;
  const COOLDOWN_SECONDS = 4;

  // ============== STATE VARIABLES ==============
  const invEl = $('inv-tickets');
  const totalEl = $('total-tickets');
  const myEl = $('my-tickets');
  const chanceEl = $('win-chance');
  const resultsEl = $('results-at');
  const qtyEl = $('qty');
  const plusEl = $('plus');
  const minusEl = $('minus');
  const enterBtn = $('btn-enter');
  const getBtn = $('btn-get');

  let myInv = 0, myEntered = 0, totalTickets = 0;
  let adWatching = {};
  let cooldownTimers = {};

  // ============== UI CONTROLS ==============
  plusEl?.addEventListener('click', () => { 
    qtyEl.value = String(Math.max(1, Number(qtyEl.value || 1) + 1)); 
  });
  
  minusEl?.addEventListener('click', () => { 
    qtyEl.value = String(Math.max(1, Number(qtyEl.value || 1) - 1)); 
  });
  
  getBtn?.addEventListener('click', () => { 
    window.location.href = 'buy.html'; 
  });

  // ============== REFRESH CHANCE FUNCTION ==============
  function refreshChance() {
    const t = Number(totalTickets || 0), m = Number(myEntered || 0);
    const p = (!t || !m) ? 0 : (m * 100.0) / t;
    chanceEl.textContent = `${p.toFixed(2)} %`;
  }

  // ============== ENTER DRAW FUNCTION ==============
  enterBtn?.addEventListener('click', async () => {
    if (uid === "UNKNOWN_USER") { 
      toast("Open in Telegram to enter.", true); 
      return; 
    }
    
    const n = Math.floor(Number(qtyEl.value || 1));
    if (n <= 0) { 
      toast("Enter at least 1 ticket", true); 
      return; 
    }

    try {
      // Deduct from inventory
      const invTx = await runTransaction(ref(db, `users/${uid}/ticketsInventory`), (cur) => {
        const have = Number(cur || 0);
        if (have < n) return; // abort
        return have - n;
      });
      
      if (!invTx.committed) { 
        toast("Not enough tickets", true); 
        return; 
      }

      // Add to weekly draw
      await runTransaction(ref(db, `weekly/current/entries/${uid}`), (cur) => Number(cur || 0) + n);
      const totTx = await runTransaction(ref(db, `weekly/current/ticketsTotal`), (cur) => Number(cur || 0) + n);
      totalTickets = Number(totTx.snapshot.val() || 0);

      // Track daily usage
      const today = getTodayDate();
      await runTransaction(ref(db, `dailyTickets/${today}/users/${uid}`), (cur) => Number(cur || 0) + n);

      // Refresh UI
      const [invSnap, meSnap] = await Promise.all([
        get(ref(db, `users/${uid}/ticketsInventory`)),
        get(ref(db, `weekly/current/entries/${uid}`))
      ]);
      
      myInv = Number(invSnap.val() || 0);
      myEntered = Number(meSnap.val() || 0);
      invEl.textContent = String(myInv);
      myEl.textContent = `${myEntered} üéüÔ∏è`;
      totalEl.textContent = `${totalTickets} üéüÔ∏è`;
      refreshChance();
      toast(`Entered ${n} tickets`);
    } catch (e) {
      console.error("Enter error:", e);
      toast("Failed to enter tickets", true);
    }
  });

  // ============== ENSURE USER EXISTS ==============
  async function ensureUser() {
    const uRef = ref(db, `users/${uid}`);
    const snap = await get(uRef);
    if (!snap.exists()) {
      await set(uRef, {
        bums: 10,
        ton: 0,
        ticketsInventory: 0,
        totalEarn: 0,
        taskDone: 0,
        profileName: uname
      });
    } else {
      const cur = snap.val() || {};
      if (!cur.profileName && uname) await update(uRef, { profileName: uname });
    }
  }

  // ============== AD BOX LOGIC ==============
  async function loadAdProgress() {
    try {
      const today = getTodayDate();
      for (let i = 1; i <= AD_BOXES; i++) {
        const progressRef = ref(db, `users/${uid}/ticketAdProgress/box${i}/count`);
        const dateRef = ref(db, `users/${uid}/ticketAdProgress/box${i}/lastClaimDate`);
        
        const [countSnap, dateSnap] = await Promise.all([
          get(progressRef),
          get(dateRef)
        ]);
        
        let count = countSnap.exists() ? Number(countSnap.val() ?? 0) : 0;
        const lastClaimDate = dateSnap.exists() ? dateSnap.val() : null;
        
        // Check if box was completed yesterday - reset today
        if (count >= ADS_REQUIRED && lastClaimDate && lastClaimDate !== today) {
          await set(progressRef, 0);
          count = 0;
        }
        
        if (!countSnap.exists()) await set(progressRef, 0);
        
        updateAdUI(i, count, lastClaimDate === today && count >= ADS_REQUIRED);
      }
    } catch (e) {
      console.error('Ad progress load error:', e);
    }
  }

  function updateAdUI(boxNum, count, isLockedToday = false) {
    const progressEl = $(`progress${boxNum}`);
    const btnEl = $(`adBtn${boxNum}`);
    const boxEl = $(`adBox${boxNum}`);
    const watchedEl = $(`watched${boxNum}`);
    const remainingEl = $(`remaining${boxNum}`);
    const cooldownEl = $(`cooldown${boxNum}`);

    if (!progressEl || !btnEl || !boxEl) return;

    progressEl.textContent = `${count}/${ADS_REQUIRED}`;
    if (watchedEl) watchedEl.textContent = `Watched: ${count}`;
    if (remainingEl) remainingEl.textContent = `Remaining: ${ADS_REQUIRED - count}`;

    // If locked for today (already claimed)
    if (isLockedToday) {
      btnEl.disabled = true;
      btnEl.classList.add('locked');
      btnEl.classList.remove('claim');
      boxEl.classList.add('completed', 'locked');
      progressEl.classList.add('complete');
      btnEl.innerHTML = 'üîí';
      if (cooldownEl) {
        cooldownEl.style.display = 'block';
        cooldownEl.textContent = '‚úÖ Claimed! Opens tomorrow';
        cooldownEl.style.color = '#ef4444';
      }
    } else if (count >= ADS_REQUIRED) {
      // Ready to claim
      btnEl.classList.add('claim');
      btnEl.classList.remove('locked');
      btnEl.disabled = false;
      boxEl.classList.add('completed');
      boxEl.classList.remove('locked');
      progressEl.classList.add('complete');
      btnEl.innerHTML = 'üéÅ';
      if (cooldownEl) cooldownEl.style.display = 'none';
    } else {
      // Normal state
      btnEl.classList.remove('claim', 'locked');
      btnEl.disabled = false;
      boxEl.classList.remove('completed', 'locked');
      progressEl.classList.remove('complete');
      btnEl.innerHTML = '‚ñ∂Ô∏è';
      if (cooldownEl) cooldownEl.style.display = 'none';
    }
  }

  function startCooldown(boxNum) {
    const btnEl = $(`adBtn${boxNum}`);
    const cooldownEl = $(`cooldown${boxNum}`);
    
    if (!btnEl || !cooldownEl) return;
    
    let timeLeft = COOLDOWN_SECONDS;
    btnEl.disabled = true;
    cooldownEl.style.display = 'block';
    cooldownEl.style.color = '#fbbf24';
    cooldownEl.textContent = `‚è≥ Wait ${timeLeft}s...`;
    
    cooldownTimers[boxNum] = setInterval(() => {
      timeLeft--;
      if (timeLeft > 0) {
        cooldownEl.textContent = `‚è≥ Wait ${timeLeft}s...`;
      } else {
        clearInterval(cooldownTimers[boxNum]);
        delete cooldownTimers[boxNum];
        cooldownEl.style.display = 'none';
        btnEl.disabled = false;
      }
    }, 1000);
  }

  async function addTicket(count = 1) {
    const ticketRef = ref(db, `users/${uid}/ticketsInventory`);
    const res = await runTransaction(ticketRef, cur => Number(cur ?? 0) + Number(count));
    myInv = Number(res.snapshot.val() ?? 0);
    invEl.textContent = String(myInv);
    return res.snapshot.val();
  }

  window.watchAd = async function(boxNum) {
    if (adWatching[boxNum]) {
      toast('Please wait for current ad to complete', true);
      return;
    }

    const progressRef = ref(db, `users/${uid}/ticketAdProgress/box${boxNum}/count`);
    const dateRef = ref(db, `users/${uid}/ticketAdProgress/box${boxNum}/lastClaimDate`);
    const btnEl = $(`adBtn${boxNum}`);

    try {
      const [countSnap, dateSnap] = await Promise.all([
        get(progressRef),
        get(dateRef)
      ]);
      
      const currentCount = countSnap.exists() ? Number(countSnap.val() ?? 0) : 0;
      const lastClaimDate = dateSnap.exists() ? dateSnap.val() : null;
      const today = getTodayDate();

      // Check if already claimed today
      if (currentCount >= ADS_REQUIRED && lastClaimDate === today) {
        toast('Already claimed today! Come back tomorrow üîí', true);
        return;
      }

      // If ready to claim
      if (currentCount >= ADS_REQUIRED) {
        btnEl.disabled = true;
        btnEl.innerHTML = '‚è≥';
        try {
          await addTicket(1);
          await update(ref(db, `users/${uid}/ticketAdProgress/box${boxNum}`), {
            count: 0,
            lastClaimDate: today
          });
          updateAdUI(boxNum, 0, true);
          toast(`üéüÔ∏è +1 Ticket claimed from Ad Box ${boxNum}!`);
        } catch (e) {
          console.error('Claim error:', e);
          toast('Failed to claim ticket', true);
        } finally {
          btnEl.disabled = true;
          btnEl.innerHTML = 'üîí';
        }
        return;
      }

      // Watch ad
      adWatching[boxNum] = true;
      btnEl.disabled = true;
      btnEl.innerHTML = '‚è≥';

      // Trigger Monetag ad
      if (typeof window.show_10005741 === 'function') {
        window.show_10005741();
      } else {
        console.warn("Monetag SDK not loaded yet");
      }

      // Simulate ad watch (2-3 seconds)
      const adDuration = 2000 + Math.random() * 1000;
      setTimeout(async () => {
        try {
          const newCount = currentCount + 1;
          await set(progressRef, newCount);
          updateAdUI(boxNum, newCount, false);
          
          if (newCount >= ADS_REQUIRED) {
            toast(`üéâ Ad Box ${boxNum} completed! Claim your ticket now!`);
          } else {
            toast(`‚úÖ Ad watched! Progress: ${newCount}/${ADS_REQUIRED}`);
          }
          
          // Start 4 second cooldown
          startCooldown(boxNum);
        } catch (e) {
          console.error('Progress update error:', e);
          toast('Failed to save progress', true);
        } finally {
          adWatching[boxNum] = false;
          btnEl.innerHTML = '‚ñ∂Ô∏è';
        }
      }, adDuration);

    } catch (e) {
      console.error('watchAd error:', e);
      toast('Ad loading failed', true);
      adWatching[boxNum] = false;
      btnEl.disabled = false;
      btnEl.innerHTML = '‚ñ∂Ô∏è';
    }
  };

  // ============== INITIALIZATION ==============
  async function loadAll() {
    console.log("üöÄ Initializing app for user:", uid);

    try {
      await ensureUser();

      // Setup weekly round
      const roundRef = ref(db, `weekly/current`);
      let rSnap = await get(roundRef);
      if (!rSnap.exists() || !rSnap.val()?.resultsAt) {
        const nextSunday = new Date();
        nextSunday.setDate(nextSunday.getDate() + ((7 - nextSunday.getDay()) % 7));
        nextSunday.setHours(0, 0, 0, 0);
        const resAt = nextSunday.toISOString();
        await update(roundRef, {
          winners: WINNERS_COUNT,
          rewardTonPerWinner: TON_PER_WINNER,
          rewardTonTotal: TON_TOTAL,
          ticketsTotal: 0,
          resultsAt: resAt
        });
        rSnap = await get(roundRef);
      }

      // Load user data
      const uSnap = await get(ref(db, `users/${uid}`));
      const eSnap = await get(ref(db, `weekly/current/entries/${uid}`));
      const u = uSnap.val() || {};
      const r = rSnap.val() || {};

      myInv = Number(u.ticketsInventory || 0);
      myEntered = Number(eSnap.exists() ? eSnap.val() : 0);
      totalTickets = Number(r.ticketsTotal || 0);

      // Update UI
      invEl.textContent = String(myInv);
      myEl.textContent = `${myEntered} üéüÔ∏è`;
      totalEl.textContent = `${totalTickets} üéüÔ∏è`;
      $('winners').textContent = String(r.winners || WINNERS_COUNT);
      $('reward-desc').textContent = `${(r.rewardTonPerWinner ?? TON_PER_WINNER).toFixed(1)} TON each (total ${(r.rewardTonTotal ?? TON_TOTAL).toFixed(1)} TON)`;
      resultsEl.textContent = new Date(r.resultsAt).toLocaleDateString() + " 00:00 UTC";
      refreshChance();

      // Load ads
      await loadAdProgress();
      console.log("‚úÖ App loaded successfully");
    } catch (err) {
      console.error("‚ùå LoadAll failed:", err);
      toast("Failed to load data. Check console.", true);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadAll);
  } else {
    loadAll();
  }

  // Refresh ad progress every 30s
  setInterval(loadAdProgress, 30000);
</script>
</body>
</html>